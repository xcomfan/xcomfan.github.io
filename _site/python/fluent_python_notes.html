<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Random Tidbits | My References</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Random Tidbits" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description." />
<meta property="og:description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description." />
<link rel="canonical" href="http://localhost:4000/python/fluent_python_notes.html" />
<meta property="og:url" content="http://localhost:4000/python/fluent_python_notes.html" />
<meta property="og:site_name" content="My References" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Random Tidbits" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.","headline":"Random Tidbits","url":"http://localhost:4000/python/fluent_python_notes.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="My References" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">My References</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Random Tidbits</h1>
  </header>

  <div class="post-content">
    <h2 id="random-tidbits">Random Tidbits</h2>

<p>Try out the python <code class="language-plaintext highlighter-rouge">random.choice</code> function.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">choice</span>
<span class="n">choice</span><span class="p">(</span><span class="n">deck</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="special-methods">Special Methods</h2>

<p>Special methods (dunders) are meant to be called by the Python interpreter, and not by you.  You don’t write my_object.<strong>len</strong>(). You write len(my_object) and, if my_object is an instance of a user-defined class, then Python calls the <strong>len</strong> method you implemented.</p>

<p>If you need to invoke a special method, it is usually better to call the related built-in function (e.g., len, iter, str, etc.). These built-ins call the corresponding special method, but often provide other services and—for built-in types—are faster than method calls.</p>

<p>The <code class="language-plaintext highlighter-rouge">__repr__</code> is called by the repr build in to get the sting representation of the object for inspection.  Without a <strong>repr</strong> method console will give you the <code class="language-plaintext highlighter-rouge">&lt;SomeClass ojbect at 0x1222234&gt;</code> output.  <code class="language-plaintext highlighter-rouge">__repr__</code> method should return code that can be used to create the object (just a suggestion not requirement) for example it would return <code class="language-plaintext highlighter-rouge">Vector(1,2)</code>  In contrast <code class="language-plaintext highlighter-rouge">__str__</code> is called by the str() build in and is implicitly used by the print function.  This should return a string suitable for displaying to end users.  Built ins that use <code class="language-plaintext highlighter-rouge">__str__</code> will fall back to <code class="language-plaintext highlighter-rouge">__repr__</code> if <code class="language-plaintext highlighter-rouge">__str__</code> is not available.</p>

<p>By default, instances of user-defined classes are considered truthy, unless either <strong>bool</strong> or <strong>len</strong> is implemented. Basically, bool(x) calls x.<strong>bool</strong>() and uses the result. If <strong>bool</strong> is not implemented, Python tries to invoke x.<strong>len</strong>(), and if that returns zero, bool returns False. Otherwise bool returns True.</p>

<h2 id="sequences">Sequences</h2>

<p>Mutable sequences in Python are list, bytearray, array.array and collections.deque</p>

<p>Immutable sequences are tuple, str and bytes.</p>

<h2 id="list-comprehensions-and-generator-expressions">List Comprehensions and Generator Expressions</h2>

<h3 id="list-comprehension">List Comprehension</h3>

<p>List comprehension can also be called listcomp and generate expressions genexps.</p>

<p>A listcomp expression will always build a new list.</p>

<p>In Python 3, list comprehensions, generator expressions, and their siblings set and dict comprehensions, have a local scope to hold the variables assigned in the for clause.However, variables assigned with the “Walrus operator” := remain accessible after those comprehensions or expressions return—unlike local variables in a function. PEP 572—Assignment Expressions defines the scope of the target of := as the enclosing function, unless there is a global or nonlocal declaration for that target.2</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="s">'ABC'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">codes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">x</span> 
<span class="s">'ABC'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">codes</span>
<span class="p">[</span><span class="mi">65</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">67</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">last</span> <span class="p">:</span><span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">last</span>
<span class="mi">67</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">c</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="nb">NameError</span><span class="p">:</span> <span class="n">name</span> <span class="s">'c'</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">defined</span>
</code></pre></div></div>

<p>You can use list comprehension instead of map or filter as the code from list comprehension is more readable than what you wind up when you use filter and map.</p>

<p>You can use list comprehension can build lists from cartesian products of two or more iterables.  The iterables do not need to be the same size and the resulting list will have a size that is the product of all the iterables.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s">'black'</span><span class="p">,</span> <span class="s">'white'</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="s">'S'</span><span class="p">,</span> <span class="s">'M'</span><span class="p">,</span> <span class="s">'L'</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">tshirts</span> <span class="o">=</span> <span class="p">[(</span><span class="n">color</span><span class="p">,</span><span class="n">size</span><span class="p">)</span> <span class="k">for</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">colors</span> <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">tshirts</span>
<span class="p">[(</span><span class="s">'black'</span><span class="p">,</span> <span class="s">'S'</span><span class="p">),</span> <span class="p">(</span><span class="s">'black'</span><span class="p">,</span> <span class="s">'M'</span><span class="p">),</span> <span class="p">(</span><span class="s">'black'</span><span class="p">,</span> <span class="s">'L'</span><span class="p">),</span> <span class="p">(</span><span class="s">'white'</span><span class="p">,</span> <span class="s">'S'</span><span class="p">),</span> <span class="p">(</span><span class="s">'white'</span><span class="p">,</span> <span class="s">'M'</span><span class="p">),</span> <span class="p">(</span><span class="s">'white'</span><span class="p">,</span> <span class="s">'L'</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">:</span>
<span class="p">...</span>   <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">:</span>
<span class="p">...</span>     <span class="k">print</span><span class="p">((</span><span class="n">color</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
<span class="p">...</span>
<span class="p">(</span><span class="s">'black'</span><span class="p">,</span> <span class="s">'S'</span><span class="p">)</span>
<span class="p">(</span><span class="s">'black'</span><span class="p">,</span> <span class="s">'M'</span><span class="p">)</span>
<span class="p">(</span><span class="s">'black'</span><span class="p">,</span> <span class="s">'L'</span><span class="p">)</span>
<span class="p">(</span><span class="s">'white'</span><span class="p">,</span> <span class="s">'S'</span><span class="p">)</span>
<span class="p">(</span><span class="s">'white'</span><span class="p">,</span> <span class="s">'M'</span><span class="p">)</span>
<span class="p">(</span><span class="s">'white'</span><span class="p">,</span> <span class="s">'L'</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="generator-expressions">Generator Expressions</h3>

<p>Using a genexp will save memory because it yields items one by one instead of building the entire list.</p>

<p>Genexps use the same syntax as listcomps but are enclosed by parentheses <code class="language-plaintext highlighter-rouge">()</code> instead of square brackets.</p>

<p>Below is the tshirts example form above written as a generator</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s">'black'</span><span class="p">,</span> <span class="s">'white'</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="s">'S'</span><span class="p">,</span> <span class="s">'M'</span><span class="p">,</span> <span class="s">'L'</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">tshirt</span> <span class="ow">in</span> <span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s">'</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">colors</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">):</span>
<span class="p">...</span>   <span class="k">print</span><span class="p">(</span><span class="n">tshirt</span><span class="p">)</span>
<span class="p">...</span>
<span class="n">black</span> <span class="n">S</span>
<span class="n">black</span> <span class="n">M</span>
<span class="n">black</span> <span class="n">L</span>
<span class="n">white</span> <span class="n">S</span>
<span class="n">white</span> <span class="n">M</span>
<span class="n">white</span> <span class="n">L</span>
<span class="o">&gt;&gt;&gt;</span>
</code></pre></div></div>

<h2 id="tuples">Tuples</h2>

<p>Tuple uses less memory than a list of the same length and allows Python to make some optimizations.  Even though the tuple is not mutable the object in it can be so be aware of that.  Tuples support all the same methods as List except those that add or remove elements.</p>

<h3 id="tuples-as-records">Tuples as Records</h3>

<p>Tuples can be used as immutable lists but also as records with no field names.  Basically the position in the tuple has meaning.  This combines well with unpacking.  For example…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">city</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">pop</span><span class="p">,</span> <span class="n">chg</span><span class="p">,</span> <span class="n">area</span> <span class="o">=</span> <span class="p">(</span><span class="s">'Tokyo'</span><span class="p">,</span> <span class="mi">2003</span><span class="p">,</span> <span class="mi">32_450</span><span class="p">,</span> <span class="mf">0.66</span><span class="p">,</span> <span class="mi">8014</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="unpacking-sequences-and-iterables">Unpacking Sequences and Iterables</h2>

<p>Unpacking works with any iterable object.</p>

<p>Basic examples of unpacking in Python are parallel assignment, and a one line variable swap as in the example below…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">lax_coordinates</span> <span class="o">=</span> <span class="p">(</span><span class="mf">33.9425</span><span class="p">,</span> <span class="o">-</span><span class="mf">118.408056</span><span class="p">)</span>
<span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">lax_coordinates</span> <span class="c1"># unpacking
</span>
<span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="c1"># unpacking
</span></code></pre></div></div>

<p>Another example of unpacking is prefixing arguments with a <code class="language-plaintext highlighter-rouge">*</code> when calling a function.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="nb">divmod</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">divmod</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">quotient</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">quotient</span><span class="p">,</span> <span class="n">remainder</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span>
</code></pre></div></div>

<h3 id="using--to-grab-excess-items">Using * to Grab Excess Items</h3>

<p>Python 3 extended the idea of using *args to grab access arguments to parallel assignment.  In the context of parallel assignment, the <code class="language-plaintext highlighter-rouge">*</code> prefix can be applied to only one variable but it can be used in any place.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">rest</span>
<span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">rest</span>
<span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">body</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span>
<span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">head</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span>
<span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</code></pre></div></div>

<p>You can also use <code class="language-plaintext highlighter-rouge">*</code> unpacking in function calls and sequence literals.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">fun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span><span class="p">):</span>
<span class="p">...</span>   <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">rest</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">fun</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</code></pre></div></div>

<p>Below is an example of defining list, tuple or set literals with <code class="language-plaintext highlighter-rouge">*</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mi">4</span>
<span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">[</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mi">4</span><span class="p">]</span>
<span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">{</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">)}</span>
<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="nested-unpacking">Nested Unpacking</h3>

<p>The target of an unpacking can use nesting, e.g <code class="language-plaintext highlighter-rouge">(a, b, (c, d))</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">metro_areas</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s">'Tokyo'</span><span class="p">,</span> <span class="s">'JP'</span><span class="p">,</span> <span class="mf">36.933</span><span class="p">,</span> <span class="p">(</span><span class="mf">35.689722</span><span class="p">,</span> <span class="mf">139.691667</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">'Delhi NCR'</span><span class="p">,</span> <span class="s">'IN'</span><span class="p">,</span> <span class="mf">21.935</span><span class="p">,</span> <span class="p">(</span><span class="mf">28.613889</span><span class="p">,</span> <span class="mf">77.208889</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">'Mexico City'</span><span class="p">,</span> <span class="s">'MX'</span><span class="p">,</span> <span class="mf">20.142</span><span class="p">,</span> <span class="p">(</span><span class="mf">19.433333</span><span class="p">,</span> <span class="o">-</span><span class="mf">99.133333</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">'New York-Newark'</span><span class="p">,</span> <span class="s">'US'</span><span class="p">,</span> <span class="mf">20.104</span><span class="p">,</span> <span class="p">(</span><span class="mf">40.808611</span><span class="p">,</span> <span class="o">-</span><span class="mf">74.020386</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">'São Paulo'</span><span class="p">,</span> <span class="s">'BR'</span><span class="p">,</span> <span class="mf">19.649</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">23.547778</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.635833</span><span class="p">)),</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="s">""</span><span class="p">:</span><span class="mi">15</span><span class="si">}</span><span class="s"> | </span><span class="si">{</span><span class="s">"latitude"</span><span class="p">:</span><span class="o">&gt;</span><span class="mi">9</span><span class="si">}</span><span class="s"> | </span><span class="si">{</span><span class="s">"longitude"</span><span class="p">:</span><span class="o">&gt;</span><span class="mi">9</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span> <span class="ow">in</span> <span class="n">metro_areas</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lon</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">name</span><span class="p">:</span><span class="mi">15</span><span class="si">}</span><span class="s"> | </span><span class="si">{</span><span class="n">lat</span><span class="p">:</span><span class="mf">9.4</span><span class="n">f</span><span class="si">}</span><span class="s"> | </span><span class="si">{</span><span class="n">lon</span><span class="p">:</span><span class="mf">9.4</span><span class="n">f</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="pattern-matching-with-sequences-new-in-python-310">Pattern Matching with Sequences (new in Python 3.10)</h2>

<p>Pattern matching is done with the <code class="language-plaintext highlighter-rouge">match/case</code> statements.  Below is a basic example</p>

<p>In general, a sequence pattern matches the subject if</p>

<ol>
  <li>The subject is a sequence and;</li>
  <li>The subject and pattern have the same number of items and;</li>
  <li>Each corresponding item matches including nested items.</li>
</ol>

<p>A sequence pattern can match instances of most actual or virtual subclasses or <code class="language-plaintext highlighter-rouge">collections.abc.Sequence</code>, with the exception of <code class="language-plaintext highlighter-rouge">str</code>, <code class="language-plaintext highlighter-rouge">bytes</code> and <code class="language-plaintext highlighter-rouge">bytearray</code></p>

<p><em><strong>Note</strong></em> Instances of <code class="language-plaintext highlighter-rouge">str</code>, <code class="language-plaintext highlighter-rouge">bytes</code> and <code class="language-plaintext highlighter-rouge">bytearray</code> are not handled as sequences in the context of <code class="language-plaintext highlighter-rouge">match/case</code>.  A <code class="language-plaintext highlighter-rouge">match</code> subject of one of those types is treated as an “atomic” value like the integer 987 is treated as one value and not a sequence of digits.  IF you need to process one of those types convert it in the match clause.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">match</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">phone</span><span class="p">):</span>
  <span class="n">case</span> <span class="p">[</span><span class="s">'1'</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span><span class="p">]:</span> <span class="c1"># North America and Caribbean
</span>    <span class="p">...</span>
  <span class="n">case</span> <span class="p">[</span><span class="s">'2'</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span><span class="p">]:</span> <span class="c1"># Africa and some territories
</span></code></pre></div></div>

<p>Sequence patterns may be written as tuples or lists or any combination of nested tuples and lists.  It does not make a difference what sequence you use.</p>

<p>The <code class="language-plaintext highlighter-rouge">_</code> symbol is special in patterns.  It matches any single item in that position, but it is never bound to the value of the matched item.  Also the _ is the only variable that can appear more than once in a pattern.</p>

<p>You can bind an part of a pattern with a variable using the <code class="language-plaintext highlighter-rouge">as</code> keyword. <code class="language-plaintext highlighter-rouge">case [name, _, _, (lat, lon) as coord]:</code>.  Given the subject [‘Shanghai’, ‘CN’, 24.9, (31.1, 121.3)], the preceding pattern will match, and set the following variables.</p>

<table>
  <thead>
    <tr>
      <th>Variable</th>
      <th>Set Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>name</td>
      <td>‘Shanghai’</td>
    </tr>
    <tr>
      <td>lat</td>
      <td>31.1</td>
    </tr>
    <tr>
      <td>lon</td>
      <td>121.3</td>
    </tr>
    <tr>
      <td>coord</td>
      <td>(31.1, 121.3)</td>
    </tr>
  </tbody>
</table>

<p>We can make patterns more specific by adding type information.  <code class="language-plaintext highlighter-rouge">case [str(name), _, _, (float(lat), float(lon))]:</code> __note** the exressions <code class="language-plaintext highlighter-rouge">str(name)</code> and <code class="language-plaintext highlighter-rouge">float(lat)</code> look like constructor calls, but in context of a patten match perform a runtime type check.</p>

<p>If we want to match any subject sequence starting with a str and ending with a nested sequence of two floats we can write <code class="language-plaintext highlighter-rouge">case [str(name) *_, (float(lat), float(lon))]:</code> The *_ matches any number of items without binding them to a variable.  Using <code class="language-plaintext highlighter-rouge">*extra</code> instead of <code class="language-plaintext highlighter-rouge">*_</code> would bind the items to the variable extras as a list with 0 or more items.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">http_error</span><span class="p">(</span><span class="n">status</span><span class="p">):</span>
    <span class="n">match</span> <span class="n">status</span><span class="p">:</span>
        <span class="n">case</span> <span class="mi">400</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"Bad request"</span>
        <span class="n">case</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"Not found"</span>
        <span class="n">case</span> <span class="mi">418</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"I'm a teapot"</span>
        <span class="n">case</span> <span class="n">_</span><span class="p">:</span> <span class="c1"># this case _ is a wild card catchall and is optional
</span>            <span class="k">return</span> <span class="s">"Something's wrong with the internet"</span>
</code></pre></div></div>

<p>You can combine several literals in a single pattern using <code class="language-plaintext highlighter-rouge">|</code> or (“or”):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">case</span> <span class="mi">401</span> <span class="o">|</span> <span class="mi">403</span> <span class="o">|</span> <span class="mi">404</span><span class="p">:</span>
    <span class="k">return</span> <span class="s">"Not allowed
</span></code></pre></div></div>

<p>You can also combine pattern matching with unpacking as in te example below…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># point is an (x, y) tuple
</span><span class="n">match</span> <span class="n">point</span><span class="p">:</span>
    <span class="n">case</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Origin"</span><span class="p">)</span>
    <span class="n">case</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Y=</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">case</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"X=</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">case</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"X=</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s">, Y=</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">case</span> <span class="n">_</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">"Not a point"</span><span class="p">)</span>
</code></pre></div></div>

<p>If you are using classes to structure your data, you can use as a pattern the class name followed by an argument list resembling a constructor. This pattern has the ability to capture class attributes into variables</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Point</span><span class="p">:</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">def</span> <span class="nf">location</span><span class="p">(</span><span class="n">point</span><span class="p">):</span>
    <span class="n">match</span> <span class="n">point</span><span class="p">:</span>
        <span class="n">case</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Origin is the point's location."</span><span class="p">)</span>
        <span class="n">case</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Y=</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s"> and the point is on the y-axis."</span><span class="p">)</span>
        <span class="n">case</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"X=</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s"> and the point is on the x-axis."</span><span class="p">)</span>
        <span class="n">case</span> <span class="n">Point</span><span class="p">():</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"The point is located somewhere else on the plane."</span><span class="p">)</span>
        <span class="n">case</span> <span class="n">_</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Not a point"</span><span class="p">)</span>
</code></pre></div></div>

<p>Patterns can be arbitrarily nested.  For example, if our data is a short list of points, it could be matched like this.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">match</span> <span class="n">points</span><span class="p">:</span>
    <span class="n">case</span> <span class="p">[]:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"No points in the list."</span><span class="p">)</span>
    <span class="n">case</span> <span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"The origin is the only point in the list."</span><span class="p">)</span>
    <span class="n">case</span> <span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)]:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"A single point </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s"> is in the list."</span><span class="p">)</span>
    <span class="n">case</span> <span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y2</span><span class="p">)]:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Two points on the Y axis at </span><span class="si">{</span><span class="n">y1</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">y2</span><span class="si">}</span><span class="s"> are in the list."</span><span class="p">)</span>
    <span class="n">case</span> <span class="n">_</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Something else is found in the list."</span><span class="p">)</span>
</code></pre></div></div>

<p>In addition to the <code class="language-plaintext highlighter-rouge">_</code> as the last case statement you can use a wildcard for more complex patterns.  In the below test_variable will match for (‘error’, code 100) and (‘error’, code, 800)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">match</span> <span class="n">test_variable</span><span class="p">:</span>
    <span class="n">case</span> <span class="p">(</span><span class="s">'warning'</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="mi">40</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"A warning has been received."</span><span class="p">)</span>
    <span class="n">case</span> <span class="p">(</span><span class="s">'error'</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"An error </span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s"> occurred."</span><span class="p">)</span>
</code></pre></div></div>

<p>You can add an <code class="language-plaintext highlighter-rouge">if</code> clause to a pattern, known as a “guard”.  If the guard is false match goes on to try the next case block.  Not that value capture happens before the guard is evaluated.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">match</span> <span class="n">point</span><span class="p">:</span>
    <span class="n">case</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">y</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"The point is located on the diagonal Y=X at </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s">."</span><span class="p">)</span>
    <span class="n">case</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Point is not on the diagonal."</span><span class="p">)</span>
</code></pre></div></div>

<p>Mapping patterns: <code class="language-plaintext highlighter-rouge">{"bandwidth": b, "latency": l}</code> captures the “bandwidth” and “latency” values from a dict. Unlike sequence patterns, extra keys are ignored. A wildcard <code class="language-plaintext highlighter-rouge">**rest</code> is also supported. (But <code class="language-plaintext highlighter-rouge">**_</code> would be redundant, so is not allowed.)</p>

<h2 id="slicing">Slicing</h2>

<p>All sequence types in Python such as <code class="language-plaintext highlighter-rouge">list</code>, <code class="language-plaintext highlighter-rouge">tuple</code>, <code class="language-plaintext highlighter-rouge">str</code> support slicing.</p>

<h3 id="why-slices-and-ranges-exclude-the-last-item">Why slices and ranges exclude the last item.</h3>

<ul>
  <li>
    <p>Its easy to see the length of a slice or range when only the stop position is given.  For example range(3) and my_list[:3] both produce three items.</p>
  </li>
  <li>
    <p>Its easy to compute the length of a slice or range when start and top are given: just subtrace <code class="language-plaintext highlighter-rouge">stop - start</code></p>
  </li>
  <li>
    <p>Its easy to split a sequence in two parts at any index x, without overlapping: simply get <code class="language-plaintext highlighter-rouge">my_list[:x]</code> and <code class="language-plaintext highlighter-rouge">my_list[x:]</code>.</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">60</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">l</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># split at 2
</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
<span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">60</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">l</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># split at 3
</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
<span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">60</span><span class="p">]</span>
</code></pre></div></div>

<h3 id="slice-objects">Slice Objects</h3>

<p><code class="language-plaintext highlighter-rouge">s[a:b:c]</code> can be used to specify a strite or step <code class="language-plaintext highlighter-rouge">c</code> causing the resulting slice to skip items.  The stride can also be negative, returning items in reverse.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="s">'bicycle'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">s</span><span class="p">[::</span><span class="mi">3</span><span class="p">]</span>
<span class="s">'bye'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">s</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="s">'elcycib'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">s</span><span class="p">[::</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<span class="s">'eccb'</span>
</code></pre></div></div>

<p>When you use the syntax <code class="language-plaintext highlighter-rouge">[a:b:c]</code> a slice object <code class="language-plaintext highlighter-rouge">slice(a, b,c)</code> is produced.  Python will then call <code class="language-plaintext highlighter-rouge">seq.__getitem__(slice(start, stop, step))</code>.  The reason we care is we can use the <code class="language-plaintext highlighter-rouge">slice</code> object to make our code cleaner.  In the example below a data file is being parsed.  Instead of messy hard coded slices we can have constant slice objects.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">invoice</span> <span class="o">=</span> <span class="s">"""
... 0.....6.................................40........52...55........
... 1909  Pimoroni PiBrella                     $17.50    3    $52.50
... 1489  6mm Tactile Switch x20                 $4.95    2     $9.90
... 1510  Panavise Jr. - PV-201                 $28.00    1    $28.00
... 1601  PiTFT Mini Kit 320x240                $34.95    1    $34.95
... """</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">SKU</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">DESCRIPTION</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">UNIT_PRICE</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">52</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">QUANTITY</span> <span class="o">=</span>  <span class="nb">slice</span><span class="p">(</span><span class="mi">52</span><span class="p">,</span> <span class="mi">55</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ITEM_TOTAL</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">55</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">line_items</span> <span class="o">=</span> <span class="n">invoice</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">line_items</span><span class="p">:</span>
<span class="p">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">UNIT_PRICE</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="n">DESCRIPTION</span><span class="p">])</span>
<span class="p">...</span>
    <span class="err">$</span><span class="mf">17.50</span>   <span class="n">Pimoroni</span> <span class="n">PiBrella</span>
     <span class="err">$</span><span class="mf">4.95</span>   <span class="mi">6</span><span class="n">mm</span> <span class="n">Tactile</span> <span class="n">Switch</span> <span class="n">x20</span>
    <span class="err">$</span><span class="mf">28.00</span>   <span class="n">Panavise</span> <span class="n">Jr</span><span class="p">.</span> <span class="o">-</span> <span class="n">PV</span><span class="o">-</span><span class="mi">201</span>
    <span class="err">$</span><span class="mf">34.95</span>   <span class="n">PiTFT</span> <span class="n">Mini</span> <span class="n">Kit</span> <span class="mi">320</span><span class="n">x240</span>
</code></pre></div></div>

<h3 id="listsort-versus-the-sorted-built-in">list.sort Versus the sorted Built-In</h3>

<p><code class="language-plaintext highlighter-rouge">list.sort</code> sorts the list in place and returns None to remind us that it changes the reciever and does not create a new list.</p>

<p><em>__Note:</em>** This is a Python convention.  Functions that change an object should return None to make it clear to the caller that the receiver was changed.</p>

<p>The built in <code class="language-plaintext highlighter-rouge">sorted</code> creates a new list and accepts any iterable.</p>

<h3 id="when-a-list-is-not-the-answer">When a List is Not the Answer</h3>

<p>This covers some types that may be a better option than the all purpose list.</p>

<h4 id="arrays">Arrays</h4>

<p>If a list only contains numbers <code class="language-plaintext highlighter-rouge">array.array</code> is a more efficient replacement.  When creating an array you provide a type code (a letter) to determine the underlying c type used to store each item in the array.  For example <code class="language-plaintext highlighter-rouge">b</code> is the type code for what C calls a signed char (an integer from -128 to 127).</p>

<p>The example code below would run much faster than reading a list from a text file as no conversion is needed.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">array</span> <span class="kn">import</span> <span class="n">array</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">random</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">floats</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">'d'</span><span class="p">,</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">7</span><span class="p">)))</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">floats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  
<span class="mf">0.07802343889111107</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'floats.bin'</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">floats</span><span class="p">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">fp</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">floats2</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">'d'</span><span class="p">)</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'floats.bin'</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">floats2</span><span class="p">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">10</span><span class="o">**</span><span class="mi">7</span><span class="p">)</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">fp</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">floats2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  
<span class="mf">0.07802343889111107</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">floats2</span> <span class="o">==</span> <span class="n">floats</span>  
<span class="bp">True</span>
</code></pre></div></div>

<h4 id="deques-and-other-queues">Deques and Other Queues</h4>

<p>If you are using a list as a stack you may want to consider using a deque as removing the head (pop(0)) of a list is an expensive operation since entire list has to be shifted in memory.</p>

<p>The <code class="language-plaintext highlighter-rouge">collections.deque</code> is a thread-safe double-ended queue desinged for fast inserting and removing from both ends.  Its also a good use case for keeping a list of “last seen items” or something of that nature because deque can be bounded (created with a fixed maximum length).  When a bounded deque is full it discards the item from the opposite end.  While you can remove items from the middle of a deque it will be slower than with a list.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dq</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="mi">1</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dq</span>
<span class="n">deque</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dq</span><span class="p">.</span><span class="n">rotate</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dq</span>
<span class="n">deque</span><span class="p">([</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dq</span><span class="p">.</span><span class="n">rotate</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dq</span>
<span class="n">deque</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dq</span><span class="p">.</span><span class="n">appendleft</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dq</span>
<span class="n">deque</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dq</span><span class="p">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">11</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">33</span><span class="p">])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dq</span>
<span class="n">deque</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">33</span><span class="p">],</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dq</span><span class="p">.</span><span class="n">extendleft</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dq</span>
<span class="n">deque</span><span class="p">([</span><span class="mi">40</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div></div>

<h5 id="other-standard-library-packages-to-look-into">Other standard library packages to look into</h5>

<ul>
  <li>
    <p>queue - Can be used for safe communication between threads as its threadsafe.</p>
  </li>
  <li>
    <p>multiprocessing - designed for inter process communication.</p>
  </li>
  <li>
    <p>asyncio - Provides queues adapted for managing tasks in asynchronous programming.</p>
  </li>
  <li>
    <p>heapq - Provides functions like heappush and heappop that let you use a mutable sequence as a heap queue or priority queue.</p>
  </li>
</ul>

<h2 id="modern-dict-syntax">Modern dict Syntax</h2>

<h3 id="dict-comprehensions">dict Comprehensions</h3>

<p>A dict comprehension builds a dict instance by taking key:value pairs from any iterable.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">dial_codes</span> <span class="o">=</span> <span class="p">[</span>
<span class="p">...</span>   <span class="p">(</span><span class="mi">880</span><span class="p">,</span> <span class="s">'Bangladesh'</span><span class="p">),</span>
<span class="p">...</span>   <span class="p">(</span><span class="mi">55</span><span class="p">,</span> <span class="s">'Brazil'</span><span class="p">),</span>
<span class="p">...</span>   <span class="p">(</span><span class="mi">86</span><span class="p">,</span> <span class="s">'China'</span><span class="p">),</span>
<span class="p">...</span> <span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">country_dial</span> <span class="o">=</span> <span class="p">{</span> <span class="n">country</span><span class="p">:</span> <span class="n">code</span> <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">country</span> <span class="ow">in</span> <span class="n">dial_codes</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">country_dial</span>
<span class="p">{</span><span class="s">'Bangladesh'</span><span class="p">:</span> <span class="mi">880</span><span class="p">,</span> <span class="s">'Brazil'</span><span class="p">:</span> <span class="mi">55</span><span class="p">,</span> <span class="s">'China'</span><span class="p">:</span> <span class="mi">86</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">{</span><span class="n">code</span><span class="p">:</span> <span class="n">country</span><span class="p">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">country</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">country_dial</span><span class="p">.</span><span class="n">items</span><span class="p">())</span> <span class="k">if</span> <span class="n">code</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">}</span>
<span class="p">{</span><span class="mi">55</span><span class="p">:</span> <span class="s">'BRAZIL'</span><span class="p">,</span> <span class="mi">86</span><span class="p">:</span> <span class="s">'CHINA'</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="unpacking-mappings">Unpacking Mappings</h3>

<p>After Python 3.5 we can use the <code class="language-plaintext highlighter-rouge">**</code> syntax on more than one argument in a function call.  This works when keys are all strings and uniqe across all arguments (duplicate key-word arguments are forbidden).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="p">...</span>   <span class="k">return</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dump</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s">'x'</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="n">y</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s">'z'</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
<span class="p">{</span><span class="s">'x'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'y'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">'z'</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
</code></pre></div></div>

<p>You can also use ** inside a dict literal and multiple times.  Not that in example below duplicate keys are allowed.  Later occurrences just overwrite previous.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="p">{</span><span class="s">'a'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s">'x'</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span> <span class="s">'y'</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s">'z'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'x'</span><span class="p">:</span> <span class="mi">4</span><span class="p">}}</span>
<span class="p">{</span><span class="s">'a'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">'x'</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s">'y'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">'z'</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="merging-mappings-with-">Merging Mappings with |</h3>

<p>From Python 3.9 you can use <code class="language-plaintext highlighter-rouge">|</code> and <code class="language-plaintext highlighter-rouge">|=</code> to merge mappings.  This makes sense since <code class="language-plaintext highlighter-rouge">|</code> is the set union operator.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">d1</span> <span class="o">=</span> <span class="p">{</span><span class="s">'a'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'b'</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">d2</span> <span class="o">=</span> <span class="p">{</span><span class="s">'a'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">'b'</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s">'c'</span><span class="p">:</span> <span class="mi">6</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">d1</span> <span class="o">|</span> <span class="n">d2</span>
<span class="p">{</span><span class="s">'a'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">'b'</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s">'c'</span><span class="p">:</span> <span class="mi">6</span><span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">|</code> operator creates a new mapping.  Usually the type of the new mapping will be the same as the tye of the left operand, but it can be the right if user defined types are involved.  This is related to operator overloading which will be covered later in the book.</p>

<p>To update an existng mapping in place use the <code class="language-plaintext highlighter-rouge">|=</code> operator.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">d1</span> <span class="o">=</span> <span class="p">{</span><span class="s">'a'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'b'</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">d2</span> <span class="o">=</span> <span class="p">{</span><span class="s">'a'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">'b'</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s">'c'</span><span class="p">:</span> <span class="mi">6</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">d1</span> <span class="o">|=</span> <span class="n">d2</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">d1</span>
<span class="p">{</span><span class="s">'a'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">'b'</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s">'c'</span><span class="p">:</span> <span class="mi">6</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="pattern-matching-with-mappings">Pattern Matching with Mappings</h3>

<p>the <code class="language-plaintext highlighter-rouge">match/case</code> statement supports subjects that are mapping objects.  Patterns for mappings look like <code class="language-plaintext highlighter-rouge">dict</code> literals, but they can match instances of any actual or virtual subclasses of <code class="language-plaintext highlighter-rouge">collections.abc.Mapping</code></p>

<p>Thanks to destructuring, pattern matching is a powerful tool to process records structure like nested mappings and sequences.  This is common when reading JSON APIs and databases with semi-structured schemas like MongoDB, EdgeDB, or PostgreSQL.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_creators</span><span class="p">(</span><span class="n">record</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="n">match</span> <span class="n">record</span><span class="p">:</span> 
        <span class="n">case</span> <span class="p">{</span><span class="s">'type'</span><span class="p">:</span> <span class="s">'book'</span><span class="p">,</span> <span class="s">'api'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">'authors'</span><span class="p">:</span> <span class="p">[</span><span class="o">*</span><span class="n">names</span><span class="p">]}:</span>  
            <span class="k">return</span> <span class="n">names</span>
        <span class="n">case</span> <span class="p">{</span><span class="s">'type'</span><span class="p">:</span> <span class="s">'book'</span><span class="p">,</span> <span class="s">'api'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'author'</span><span class="p">:</span> <span class="n">name</span><span class="p">}:</span>  
            <span class="k">return</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">case</span> <span class="p">{</span><span class="s">'type'</span><span class="p">:</span> <span class="s">'book'</span><span class="p">}:</span>  
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"Invalid 'book' record: </span><span class="si">{</span><span class="n">record</span><span class="err">!</span><span class="n">r</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">case</span> <span class="p">{</span><span class="s">'type'</span><span class="p">:</span> <span class="s">'movie'</span><span class="p">,</span> <span class="s">'director'</span><span class="p">:</span> <span class="n">name</span><span class="p">}:</span>  
            <span class="k">return</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">case</span> <span class="n">_</span><span class="p">:</span>  
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">'Invalid record: </span><span class="si">{</span><span class="n">record</span><span class="err">!</span><span class="n">r</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">b1</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">api</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="s">'Douglas Hofstadter'</span><span class="p">,</span>
<span class="p">...</span>         <span class="nb">type</span><span class="o">=</span><span class="s">'book'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">'Gödel, Escher, Bach'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">get_creators</span><span class="p">(</span><span class="n">b1</span><span class="p">)</span>
<span class="p">[</span><span class="s">'Douglas Hofstadter'</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">api</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">'book'</span><span class="p">,</span>
<span class="p">...</span>         <span class="n">title</span><span class="o">=</span><span class="s">'Python in a Nutshell'</span><span class="p">,</span>
<span class="p">...</span>         <span class="n">authors</span><span class="o">=</span><span class="s">'Martelli Ravenscroft Holden'</span><span class="p">.</span><span class="n">split</span><span class="p">())</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">get_creators</span><span class="p">(</span><span class="n">b2</span><span class="p">)</span>
<span class="p">[</span><span class="s">'Martelli'</span><span class="p">,</span> <span class="s">'Ravenscroft'</span><span class="p">,</span> <span class="s">'Holden'</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">get_creators</span><span class="p">({</span><span class="s">'type'</span><span class="p">:</span> <span class="s">'book'</span><span class="p">,</span> <span class="s">'pages'</span><span class="p">:</span> <span class="mi">770</span><span class="p">})</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
    <span class="p">...</span>
<span class="nb">ValueError</span><span class="p">:</span> <span class="n">Invalid</span> <span class="s">'book'</span> <span class="n">record</span><span class="p">:</span> <span class="p">{</span><span class="s">'type'</span><span class="p">:</span> <span class="s">'book'</span><span class="p">,</span> <span class="s">'pages'</span><span class="p">:</span> <span class="mi">770</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">get_creators</span><span class="p">(</span><span class="s">'Spam, spam, spam'</span><span class="p">)</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
    <span class="p">...</span>
<span class="nb">ValueError</span><span class="p">:</span> <span class="n">Invalid</span> <span class="n">record</span><span class="p">:</span> <span class="s">'Spam, spam, spam'</span>
</code></pre></div></div>

<h2 id="standard-api-of-mapping-types">Standard API of Mapping Types</h2>

<p>It is a good practice to use <code class="language-plaintext highlighter-rouge">isinstance()</code> with an abstract base class (ABC) than checking if its a <code class="language-plaintext highlighter-rouge">dict</code> because it allows for other types to be used.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">my_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">my_dict</span><span class="p">,</span> <span class="n">abc</span><span class="p">.</span><span class="n">Mapping</span><span class="p">)</span>
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">my_dict</span><span class="p">,</span> <span class="n">abc</span><span class="p">.</span><span class="n">MutableMapping</span><span class="p">)</span>
<span class="bp">True</span>
</code></pre></div></div>

<p>Instead of writing the code below…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">my_dict</span><span class="p">:</span>
    <span class="n">my_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">my_dict</span><span class="p">[</span><span class="n">key</span><span class="p">].</span><span class="n">append</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span>
</code></pre></div></div>

<p>You can write <code class="language-plaintext highlighter-rouge">my_dict.setdefault(key, []).append(new_value)</code></p>

<p>The above in addition to default dict rely on the class implementing a <code class="language-plaintext highlighter-rouge">__missing__</code> method.  Essentially if you subclass <code class="language-plaintext highlighter-rouge">dict</code> and a key is not found in a lookup, if the <code class="language-plaintext highlighter-rouge">__missing__</code> method exists it will be called instead of raising a ValueError.</p>

<h2 id="variations-of-dict">Variations of dict</h2>

<h3 id="collectionsordereddict">collections.OrderedDict</h3>

<p>Since python 3.6 a <code class="language-plaintext highlighter-rouge">dict</code> will keep the keys in order.  The most common reason to use <code class="language-plaintext highlighter-rouge">OrderedDict</code> is for backwards compatibility.</p>

<p>Some benefits of an order dict should you need them are…</p>

<ul>
  <li>equality operation for OrderedDict check for matching order.</li>
  <li>OrderedDict was designed to be efficient at reordering operations.  Update operations performance was secondary.</li>
</ul>

<h3 id="collectionschainmap">collections.ChainMap</h3>

<p>A <code class="language-plaintext highlighter-rouge">ChainMap</code> instance holds a list of mappings that can be searched at once.  The lookup is performed on each input mapping in the order it appears in the constructor call, and succeeds as soon as a key is found in one of those mappings.  Note that the chain map instance does not copy the input mappings, but keeps references to them.  So an update of the chain will update the mapping that was passed to the constructor.</p>

<p><code class="language-plaintext highlighter-rouge">ChainMap</code> is useful in scenarios where you have to search though various scopes.  Fore example think of searching for a variable in local and global scope.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">d1</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">d2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">ChainMap</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">chain</span> <span class="o">=</span> <span class="n">ChainMap</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">chain</span><span class="p">[</span><span class="s">'a'</span><span class="p">]</span>
<span class="mi">1</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">chain</span><span class="p">[</span><span class="s">'c'</span><span class="p">]</span>
<span class="mi">6</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">chain</span><span class="p">[</span><span class="s">'b'</span><span class="p">]</span>
<span class="mi">3</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">chain</span><span class="p">[</span><span class="s">'c'</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">d1</span>
<span class="p">{</span><span class="s">'a'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'b'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'c'</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="collectionscounter">collections.Counter</h3>

<p>A mapping that hold an integer count for each key.  Updating an existing key adds to its count.</p>

<p>Note that when you ask for top 3 even though there is a tie between b and r only b is returned.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">collections</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ct</span> <span class="o">=</span> <span class="n">collections</span><span class="p">.</span><span class="n">Counter</span><span class="p">(</span><span class="s">'abracadabra'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ct</span>
<span class="n">Counter</span><span class="p">({</span><span class="s">'a'</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s">'b'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">'r'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">'c'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'d'</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ct</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="s">'aaaaazzzz'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ct</span>
<span class="n">Counter</span><span class="p">({</span><span class="s">'a'</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s">'z'</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s">'b'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">'r'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">'c'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'d'</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ct</span><span class="p">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="p">[(</span><span class="s">'a'</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="s">'z'</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="s">'b'</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
</code></pre></div></div>

<h3 id="shelveshelf">shelve.Shelf</h3>

<p>The curious name of shelve makes sense when you think that pickle jars are kept on shelves.  Shelve modules in the standard library provides persistent storage for a mapping of string keys to Python objects serialized in the pickle binary format.</p>

<h2 id="subclassing-userdict-instead-of-dict">Subclassing UserDict Instead of dict</h2>

<p>The reason you want to subclass UserDict and not dict is that the built in has some implementation shortcuts that would force you to imlement methods that you would not have to if you subclass collections.UserDict</p>

<h2 id="immutable-mappings">Immutable Mappings</h2>

<p>The mapping types provided by the standard library are all mutable.  If you have a scenario where you need to prevent users from modifying a mapping the <code class="language-plaintext highlighter-rouge">types</code> module has wrapper class called <code class="language-plaintext highlighter-rouge">MappingProxyType</code> which given a mapping returns a <code class="language-plaintext highlighter-rouge">mappingproxy</code> instance that is read only but a dynamic proxy for the original mapping.  That means that updates to the original mapping can be seen in <code class="language-plaintext highlighter-rouge">mappingproxy</code>, but changes cannot be made though it.</p>

<p>’'’python</p>
<blockquote>
  <blockquote>
    <blockquote>
      <p>from types import MappingProxyType
d = {1: ‘A’}
d_proxy = MappingProxyType(d)
d_proxy
mappingproxy({1: ‘A’})
d_proxy[1]<br />
‘A’
d_proxy[2] = ‘x’<br />
Traceback (most recent call last):
  File “<stdin>", line 1, in <module>
TypeError: 'mappingproxy' object does not support item assignment
d[2] = 'B'
d_proxy  
mappingproxy({1: 'A', 2: 'B'})
d_proxy[2]
'B'</module></stdin></p>

      <p>’’’</p>
    </blockquote>
  </blockquote>
</blockquote>

<h2 id="dictionary-views">Dictionary Views</h2>

<p>The dict instance methods <code class="language-plaintext highlighter-rouge">.keys()</code>, <code class="language-plaintext highlighter-rouge">.values()</code>, and <code class="language-plaintext highlighter-rouge">.items()</code> return instances of classes called <code class="language-plaintext highlighter-rouge">dict_keys</code>, <code class="language-plaintext highlighter-rouge">dict_values</code>, and <code class="language-plaintext highlighter-rouge">dict_items</code>, respectively. These dictionary views are read-only projections of the internal data structures used in the dict implementation.  A view object is a dynamic proxy as described above.  If dict is updated it sees the change but it cannot be modified itself.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">values</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="n">values</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">values</span>
<span class="n">dict_values</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">])</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>  
<span class="mi">3</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>  
<span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>  
<span class="o">&lt;</span><span class="n">dict_reversevalueiterator</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x10e9e7310</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="nb">TypeError</span><span class="p">:</span> <span class="s">'dict_values'</span> <span class="nb">object</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">subscriptable</span>
</code></pre></div></div>

<h2 id="sets">Sets</h2>

<p><code class="language-plaintext highlighter-rouge">set</code> is not hashable but <code class="language-plaintext highlighter-rouge">frozenset</code> is may be useful if you ever want to use it as a key to a dictionary.</p>

<p>A set literal looks like <code class="language-plaintext highlighter-rouge">{1}, {1,2}</code>  Note that there is no literal for an empty set.  You need to use <code class="language-plaintext highlighter-rouge">set()</code> to declare an empty set. A string representation of a set will use the literal syntax except if its an empty set in which case you would get <code class="language-plaintext highlighter-rouge">class 'set'</code>.</p>

<p>Sets use more memory than arrays, but are much faster to search.  Order cannot be counted on.  Its based on insertion order but not in a useful or reliable way.  If two elements have same hash code their position depends on which was added first.  Adding elements may change order since its still a hash table and its most efficient if about 30% empty thus Python may need to move things around.</p>

<h3 id="set-comprehensions">Set Comprehensions</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">unicodedata</span> <span class="kn">import</span> <span class="n">name</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">name</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">33</span><span class="p">),</span> <span class="s">''</span><span class="p">)</span>
<span class="s">'EXCLAMATION MARK'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">{</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span> <span class="k">if</span> <span class="s">'SIGN'</span> <span class="ow">in</span> <span class="n">name</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="s">''</span><span class="p">)}</span>
<span class="p">{</span><span class="s">'¢'</span><span class="p">,</span> <span class="s">'¤'</span><span class="p">,</span> <span class="s">'µ'</span><span class="p">,</span> <span class="s">'&lt;'</span><span class="p">,</span> <span class="s">'±'</span><span class="p">,</span> <span class="s">'¬'</span><span class="p">,</span> <span class="s">'$'</span><span class="p">,</span> <span class="s">'©'</span><span class="p">,</span> <span class="s">'¶'</span><span class="p">,</span> <span class="s">'§'</span><span class="p">,</span> <span class="s">'%'</span><span class="p">,</span> <span class="s">'='</span><span class="p">,</span> <span class="s">'°'</span><span class="p">,</span> <span class="s">'+'</span><span class="p">,</span> <span class="s">'£'</span><span class="p">,</span> <span class="s">'×'</span><span class="p">,</span> <span class="s">'¥'</span><span class="p">,</span> <span class="s">'#'</span><span class="p">,</span> <span class="s">'®'</span><span class="p">,</span> <span class="s">'&gt;'</span><span class="p">,</span> <span class="s">'÷'</span><span class="p">}</span>
</code></pre></div></div>

<h2 id="unicode-text-versus-bytes-chapter-4">Unicode Text Versus Bytes (Chapter 4)</h2>

<p>Converting from code points ot bytes is <em>encoding</em> converting from bytes to code points is <code class="language-plaintext highlighter-rouge">decoding</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="s">'café'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  
<span class="mi">4</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf8'</span><span class="p">)</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">b</span>
<span class="sa">b</span><span class="s">'caf</span><span class="se">\xc3\xa9</span><span class="s">'</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>  
<span class="mi">5</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">b</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf8'</span><span class="p">)</span>  
<span class="s">'café'</span>
</code></pre></div></div>

<p>Bellow is an example of encoding the string <code class="language-plaintext highlighter-rouge">El Niño</code> to various codes.  A python distribution has over 100 codecs which you can use.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">codec</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'latin_1'</span><span class="p">,</span> <span class="s">'utf_8'</span><span class="p">,</span> <span class="s">'utf_16'</span><span class="p">]:</span>
<span class="p">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="s">'El Niño'</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">codec</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s">'</span><span class="se">\t</span><span class="s">'</span><span class="p">)</span>
<span class="p">...</span>
<span class="n">latin_1</span> <span class="sa">b</span><span class="s">'El Ni</span><span class="se">\xf1</span><span class="s">o'</span>
<span class="n">utf_8</span>   <span class="sa">b</span><span class="s">'El Ni</span><span class="se">\xc3\xb1</span><span class="s">o'</span>
<span class="n">utf_16</span>  <span class="sa">b</span><span class="s">'</span><span class="se">\xff\xfe</span><span class="s">E</span><span class="se">\x00</span><span class="s">l</span><span class="se">\x00</span><span class="s"> </span><span class="se">\x00</span><span class="s">N</span><span class="se">\x00</span><span class="s">i</span><span class="se">\x00\xf1\x00</span><span class="s">o</span><span class="se">\x00</span><span class="s">'</span>
</code></pre></div></div>

<p>When encoding and decoding the two types of errors you may encounter are <code class="language-plaintext highlighter-rouge">UnicodeEncodeError</code> and <code class="language-plaintext highlighter-rouge">UnicodeDecodeError</code>.  You need to be mindful of which error you are seeing to figure out what’s going on with the encoding.</p>

<p>below is an example of error handling when encoding.  When using <code class="language-plaintext highlighter-rouge">error='ignore'</code> characters will be skipped which is usually a bad idea since you will have silent data loss.  If using the <code class="language-plaintext highlighter-rouge">error='replace'</code> characters that cannot be encoded are substituted with a <code class="language-plaintext highlighter-rouge">?</code>.  Data is still lost but at least you know its lost.  <code class="language-plaintext highlighter-rouge">errors=xmlcharrefreplace</code> replaces encodable characters with XML entity.  If you can’t use UTF and you can’t loose data this is the only viable option.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">city</span> <span class="o">=</span> <span class="s">'São Paulo'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">city</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf_8'</span><span class="p">)</span>  
<span class="sa">b</span><span class="s">'S</span><span class="se">\xc3\xa3</span><span class="s">o Paulo'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">city</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf_16'</span><span class="p">)</span>
<span class="sa">b</span><span class="s">'</span><span class="se">\xff\xfe</span><span class="s">S</span><span class="se">\x00\xe3\x00</span><span class="s">o</span><span class="se">\x00</span><span class="s"> </span><span class="se">\x00</span><span class="s">P</span><span class="se">\x00</span><span class="s">a</span><span class="se">\x00</span><span class="s">u</span><span class="se">\x00</span><span class="s">l</span><span class="se">\x00</span><span class="s">o</span><span class="se">\x00</span><span class="s">'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">city</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'iso8859_1'</span><span class="p">)</span>  
<span class="sa">b</span><span class="s">'S</span><span class="se">\xe3</span><span class="s">o Paulo'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">city</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'cp437'</span><span class="p">)</span>  
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
  <span class="n">File</span> <span class="s">"/.../lib/python3.4/encodings/cp437.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">12</span><span class="p">,</span> <span class="ow">in</span> <span class="n">encode</span>
    <span class="k">return</span> <span class="n">codecs</span><span class="p">.</span><span class="n">charmap_encode</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">errors</span><span class="p">,</span><span class="n">encoding_map</span><span class="p">)</span>
<span class="nb">UnicodeEncodeError</span><span class="p">:</span> <span class="s">'charmap'</span> <span class="n">codec</span> <span class="n">can</span><span class="s">'t encode character '</span>\<span class="n">xe3</span><span class="s">' in
position 1: character maps to &lt;undefined&gt;
&gt;&gt;&gt; city.encode('</span><span class="n">cp437</span><span class="s">', errors='</span><span class="n">ignore</span><span class="s">')  
b'</span><span class="n">So</span> <span class="n">Paulo</span><span class="s">'
&gt;&gt;&gt; city.encode('</span><span class="n">cp437</span><span class="s">', errors='</span><span class="n">replace</span><span class="s">')  
b'</span><span class="n">S</span><span class="err">?</span><span class="n">o</span> <span class="n">Paulo</span><span class="s">'
&gt;&gt;&gt; city.encode('</span><span class="n">cp437</span><span class="s">', errors='</span><span class="n">xmlcharrefreplace</span><span class="s">')  
b'</span><span class="n">S</span><span class="o">&amp;</span><span class="c1">#227;o Paulo'
</span></code></pre></div></div>

<p>ASCII is a common subset and if all your characters are ASCII all encodings should work.  Python 3.7 and up has a <code class="language-plaintext highlighter-rouge">str.isascii()</code> method to check if all characters are ASCII.</p>

<p>Below is an example of decoding from bytes.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">octets</span> <span class="o">=</span> <span class="sa">b</span><span class="s">'Montr</span><span class="se">\xe9</span><span class="s">al'</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">octets</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'cp1252'</span><span class="p">)</span>  
<span class="s">'Montréal'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">octets</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'iso8859_7'</span><span class="p">)</span>  
<span class="s">'Montrιal'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">octets</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'koi8_r'</span><span class="p">)</span>  
<span class="s">'MontrИal'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">octets</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf_8'</span><span class="p">)</span>  
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="nb">UnicodeDecodeError</span><span class="p">:</span> <span class="s">'utf-8'</span> <span class="n">codec</span> <span class="n">can</span><span class="s">'t decode byte 0xe9 in position 5:
invalid continuation byte
&gt;&gt;&gt; octets.decode('</span><span class="n">utf_8</span><span class="s">', errors='</span><span class="n">replace</span><span class="s">')  
'</span><span class="n">Montr</span><span class="err">�</span><span class="n">al</span><span class="s">'
</span></code></pre></div></div>

<p>UTF-8 is the default source encoding for Python 3.  If you load a .py module containing non-UTF-8 data and no encoding declaration, you get a messge like the below…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">SyntaxError</span><span class="p">:</span> <span class="n">Non</span><span class="o">-</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span> <span class="n">code</span> <span class="n">starting</span> <span class="k">with</span> <span class="s">'</span><span class="se">\xe1</span><span class="s">'</span> <span class="ow">in</span> <span class="nb">file</span> <span class="n">ola</span><span class="p">.</span><span class="n">py</span> <span class="n">on</span> <span class="n">line</span>
  <span class="mi">1</span><span class="p">,</span> <span class="n">but</span> <span class="n">no</span> <span class="n">encoding</span> <span class="n">declared</span><span class="p">;</span> <span class="n">see</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">python</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">peps</span><span class="o">/</span><span class="n">pep</span><span class="o">-</span><span class="mi">0263</span><span class="o">/</span>
  <span class="k">for</span> <span class="n">details</span>
</code></pre></div></div>

<p>To fix this problem add a macing <code class="language-plaintext highlighter-rouge">coding</code> comment at the top of the file as below…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># coding: cp1252
</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Olá, Mundo!'</span><span class="p">)</span>
</code></pre></div></div>

<p>There is no way to figure out what encoding something uses.  You must be told.  Any other approach is essentially an educated guess based on the bytes you see.</p>

<p>The best way to handle reading files is the ‘Unicode sandwich’.  This expressio measn you decode as early in your code as possible and encode in the very end.  The middle where you actually work on the data you operatin gon strings.  This is kind of done for you by python because if you use the <code class="language-plaintext highlighter-rouge">my_file.read()</code> method it decodes before it gives you the datat and <code class="language-plaintext highlighter-rouge">my_file.write()</code> it encodes for your.  Your program should not be doing encoding or decoding in the middle of other porcessing.</p>

<p>Code that will run on various machines shoul never make assumption about encoding defaults.  Explicityly pass the encoding as in the example below…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="nb">open</span><span class="p">(</span><span class="s">'cafe.txt'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf_8'</span><span class="p">).</span><span class="n">write</span><span class="p">(</span><span class="s">'café'</span><span class="p">)</span>
<span class="mi">4</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">open</span><span class="p">(</span><span class="s">'cafe.txt'</span><span class="p">).</span><span class="n">read</span><span class="p">()</span>
<span class="s">'cafÃ©'</span>
</code></pre></div></div>

<h2 id="data-class-builders">Data Class Builders</h2>

<p>A data class is a simple class that is a collection of fields, with little or no extra functionality.</p>

<p><code class="language-plaintext highlighter-rouge">namedtuple</code> is one kind of data class available in python.  Notice that over using a plain tople you get a more useful <code class="language-plaintext highlighter-rouge">__repr__</code> and a more meaningful <code class="language-plaintext highlighter-rouge">__eq__</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Coordinate</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s">'Coordinate'</span><span class="p">,</span> <span class="s">'lat lon'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">Coordinate</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">moscow</span> <span class="o">=</span> <span class="n">Coordinate</span><span class="p">(</span><span class="mf">55.756</span><span class="p">,</span> <span class="mf">37.617</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">moscow</span>
<span class="n">Coordinate</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="mf">55.756</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mf">37.617</span><span class="p">)</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">moscow</span> <span class="o">==</span> <span class="n">Coordinate</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="mf">55.756</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mf">37.617</span><span class="p">)</span>  
<span class="bp">True</span>
</code></pre></div></div>

<p>The newer <code class="language-plaintext highlighter-rouge">typing.NamedTuple</code> provides the same functionality but adds a type annotation to each field.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">typing</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Coordinate</span> <span class="o">=</span> <span class="n">typing</span><span class="p">.</span><span class="n">NamedTuple</span><span class="p">(</span><span class="s">'Coordinate'</span><span class="p">,</span>
<span class="p">...</span>     <span class="p">[(</span><span class="s">'lat'</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s">'lon'</span><span class="p">,</span> <span class="nb">float</span><span class="p">)])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">Coordinate</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">typing</span><span class="p">.</span><span class="n">get_type_hints</span><span class="p">(</span><span class="n">Coordinate</span><span class="p">)</span>
<span class="p">{</span><span class="s">'lat'</span><span class="p">:</span> <span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">float</span><span class="s">'&gt;, '</span><span class="n">lon</span><span class="s">': &lt;class '</span><span class="nb">float</span><span class="s">'&gt;}
</span></code></pre></div></div>

<p>You can construct a named tople with a list of keyword arugments like this <code class="language-plaintext highlighter-rouge">Coordinate = typing.NamedTuple('Coordinate', lat=float, lon=float)</code></p>

<p>Since Python 3.6 typing.NamedTuple can also be used in a class statement making it easier to override methods.  Note that alothough NamedTuple appears in the class statement as a superclass, its actually not.  typing.NamedTuple uses the advanced functionality of a metaclass to customize the creation of the user’s class.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NamedTuple</span>

<span class="k">class</span> <span class="nc">Coordinate</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">lat</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">lon</span><span class="p">:</span> <span class="nb">float</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="s">'N'</span> <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">lat</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s">'S'</span>
        <span class="n">we</span> <span class="o">=</span> <span class="s">'E'</span> <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">lon</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s">'W'</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">lat</span><span class="p">):.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">°</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">lon</span><span class="p">):.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">°</span><span class="si">{</span><span class="n">we</span><span class="si">}</span><span class="s">'</span>
</code></pre></div></div>

<p>Another way to implement a data class is with the <code class="language-plaintext highlighter-rouge">@dataclass</code> decorator.  The <code class="language-plaintext highlighter-rouge">@dataclass</code> decorator does not depend on inheritence or metaclass so you are free to use those features.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="o">@</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Coordinate</span><span class="p">:</span>
    <span class="n">lat</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">lon</span><span class="p">:</span> <span class="nb">float</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="s">'N'</span> <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">lat</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s">'S'</span>
        <span class="n">we</span> <span class="o">=</span> <span class="s">'E'</span> <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">lon</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s">'W'</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">lat</span><span class="p">):.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">°</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">lon</span><span class="p">):.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">°</span><span class="si">{</span><span class="n">we</span><span class="si">}</span><span class="s">'</span>
</code></pre></div></div>

<p>Below is a summary of the 3 options for data classes.</p>

<table>
  <thead>
    <tr>
      <th> </th>
      <th>namedtuple</th>
      <th>NamedTuple</th>
      <th>dataclass</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>mutable instances</td>
      <td>NO</td>
      <td>NO</td>
      <td>YES</td>
    </tr>
    <tr>
      <td>class statement syntax</td>
      <td>NO</td>
      <td>NO</td>
      <td>YES</td>
    </tr>
    <tr>
      <td>contruct dict</td>
      <td>x._asdict()</td>
      <td>x._asdict()</td>
      <td>dataclasses.asdict(x)</td>
    </tr>
    <tr>
      <td>get field names</td>
      <td>x._fields</td>
      <td>x._fields</td>
      <td>[f.name for f in dataclasses.fields(x)]</td>
    </tr>
    <tr>
      <td>get defauls</td>
      <td>x._field_defaults</td>
      <td>x._field_defaults</td>
      <td>[f.default for f in dataclasses.fields(x)]</td>
    </tr>
    <tr>
      <td>get field types</td>
      <td>N/A</td>
      <td>x.<strong>annotations</strong></td>
      <td>x.<strong>annotations</strong></td>
    </tr>
    <tr>
      <td>new instance wtih changes</td>
      <td>x._replace(…)</td>
      <td>x.replace(…)</td>
      <td>dataclasses.replace(x,…)</td>
    </tr>
    <tr>
      <td>new class at runtime</td>
      <td>namedtuple(…)</td>
      <td>NamedTuple(…)</td>
      <td>dataclasses.make_dataclasse(…)</td>
    </tr>
  </tbody>
</table>

<p><strong><em>Note:</em></strong> Its not recommedned to use the <code class="language-plaintext highlighter-rouge">__annotations__</code> attribute.  Instead use <code class="language-plaintext highlighter-rouge">inspect.get_annotations(MyClass)</code> which was added in Python 3.10 or <code class="language-plaintext highlighter-rouge">typing.get_type_hints(MyClass)</code> (Python 3.5 to 3.9).  Thsoe functions provide extra services like resolving forward references in type hints.</p>

<h3 id="a-type-hints-101-aside-as-its-relevant-to-namedtuple">A type hints 101 Aside as its relevant to NamedTuple</h3>

<p>Python typehints are just documentation that can be verified by IDEs and type checkers.  It has not runtime impact.  Even though there is no runtime impact, Python does read the type hints to buidl the <code class="language-plaintext highlighter-rouge">__annotations__</code> dictionary.  <code class="language-plaintext highlighter-rouge">typing.NamedTuple</code> and <code class="language-plaintext highlighter-rouge">@dataclass</code> then use this dictionary to enchance the class.</p>

<h3 id="more-about-dataclass">More about @dataclass</h3>

<p>The <code class="language-plaintext highlighter-rouge">@dataclass</code> decorartin accpets the follwing keywors.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">dataclass</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
              <span class="n">unsafe_hash</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<p>The defaults are usually what you want.</p>

<p>If the <code class="language-plaintext highlighter-rouge">eq</code> and <code class="language-plaintext highlighter-rouge">frozen</code> argumetns are both <code class="language-plaintext highlighter-rouge">True</code>, <code class="language-plaintext highlighter-rouge">@dataclass</code> produces a suitalbe <code class="language-plaintext highlighter-rouge">__hash__</code> method, so instances will be hashable. If <code class="language-plaintext highlighter-rouge">frozen</code> is <code class="language-plaintext highlighter-rouge">False</code> hashable will be set to False.</p>

<p>You can forece Dat Classes to have a hash with <code class="language-plaintext highlighter-rouge">unsafe_hash=True</code> but its not recommended.</p>

<p>You cannot have mutable as default values.  This will raise a value error.  If you use a mutable as a default than every instance will reference that mutable and can lead to bugs.  If you need a mutable as a default you can provide a callable as in the example below which will create an instance of the mutable for each instance of the data class when its created.  Note that this check aplie only to dict, set and list.  Any other mutable while still having the same bug potential will not be caught.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>

<span class="o">@</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">ClubMember</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">guests</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
</code></pre></div></div>

<p>The default option exists because the field call takes the place of the default value in the field annotation. If you want to create an athlete field with a default value of False, and also omit that field from the <code class="language-plaintext highlighter-rouge">__repr__</code> method, you’d write this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">ClubMember</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">guests</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">athlete</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">__init__</code> method generated by <code class="language-plaintext highlighter-rouge">@dataclass</code> only takes argumetns passed and assigns them or their default values if missing to the instance attributes that are instance fields.  If you need to do more than that you need to implement the <code class="language-plaintext highlighter-rouge">__post_init__</code> method.  This will be called as the last step of the <code class="language-plaintext highlighter-rouge">__init__</code> method if declared.  Common use cases for <code class="language-plaintext highlighter-rouge">__post_init__</code> are validation and computing field values based on other fields.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">club</span> <span class="kn">import</span> <span class="n">ClubMember</span>

<span class="o">@</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">HackerClubMember</span><span class="p">(</span><span class="n">ClubMember</span><span class="p">):</span>                         
    <span class="n">all_handles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>                                     
    <span class="n">handle</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">''</span>                                        

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__class__</span>                                
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">handle</span> <span class="o">==</span> <span class="s">''</span><span class="p">:</span>                               
            <span class="bp">self</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">handle</span> <span class="ow">in</span> <span class="n">cls</span><span class="p">.</span><span class="n">all_handles</span><span class="p">:</span>                  
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'handle </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">handle</span><span class="err">!</span><span class="n">r</span><span class="si">}</span><span class="s"> already exists.'</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">cls</span><span class="p">.</span><span class="n">all_handles</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">handle</span><span class="p">)</span>
</code></pre></div></div>

<p>The above example will make Type Checkesr complaing.  In order to make them happy you have to use the <code class="language-plaintext highlighter-rouge">typing.ClassVar</code> pseudotype.  The declaration for all_handles would look like <code class="language-plaintext highlighter-rouge">all_handles = ClassVar[set[str]] = set()</code>.  This type hint is saying all_handles is a class attibute of type set of str with an empty set as its default value.</p>

<p>If a variable is a ClassVar, an instance field will not be generated for that attribute.  This is one of two cases where <code class="language-plaintext highlighter-rouge">@dataclass</code> cares about type hints.  The other instance is dicusses below…</p>

<h3 id="initialization-variables-that-are-not-fields">Initialization Variables That Are Not Fields</h3>

<p>Sometimes you need to pass argumetns to <code class="language-plaintext highlighter-rouge">__init__</code> which are not fiedls.  These are called init-only variables.  To delcare such types the <code class="language-plaintext highlighter-rouge">dataclasses</code> module provides the pseufotype <code class="language-plaintext highlighter-rouge">InitVar</code>  Exampe below has a filed initialized from a database and the database object must be passed to the constructor.  By using <code class="language-plaintext highlighter-rouge">InitVar</code> we prevent <code class="language-plaintext highlighter-rouge">@dataclass</code> from treating database as a reguller field.  It will not be set as an instance attrbiteu, and the dataclasses.fileds function will not list it.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">C</span><span class="p">:</span>
    <span class="n">i</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">j</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">database</span><span class="p">:</span> <span class="n">InitVar</span><span class="p">[</span><span class="n">DatabaseType</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">j</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">database</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">j</span> <span class="o">=</span> <span class="n">database</span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span><span class="s">'j'</span><span class="p">)</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="n">my_database</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="data-classes-and-class-patterns">Data Classes and Class Patterns</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">typing</span>

<span class="k">class</span> <span class="nc">City</span><span class="p">(</span><span class="n">typing</span><span class="p">.</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">continent</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">country</span><span class="p">:</span> <span class="nb">str</span>


<span class="n">cities</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">City</span><span class="p">(</span><span class="s">'Asia'</span><span class="p">,</span> <span class="s">'Tokyo'</span><span class="p">,</span> <span class="s">'JP'</span><span class="p">),</span>
    <span class="n">City</span><span class="p">(</span><span class="s">'Asia'</span><span class="p">,</span> <span class="s">'Delhi'</span><span class="p">,</span> <span class="s">'IN'</span><span class="p">),</span>
    <span class="n">City</span><span class="p">(</span><span class="s">'North America'</span><span class="p">,</span> <span class="s">'Mexico City'</span><span class="p">,</span> <span class="s">'MX'</span><span class="p">),</span>
    <span class="n">City</span><span class="p">(</span><span class="s">'North America'</span><span class="p">,</span> <span class="s">'New York'</span><span class="p">,</span> <span class="s">'US'</span><span class="p">),</span>
    <span class="n">City</span><span class="p">(</span><span class="s">'South America'</span><span class="p">,</span> <span class="s">'São Paulo'</span><span class="p">,</span> <span class="s">'BR'</span><span class="p">),</span>
<span class="p">]</span>

<span class="c1">## The old none pattern eway of doin git...
</span>
<span class="k">def</span> <span class="nf">match_asian_countries</span><span class="p">():</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">city</span> <span class="ow">in</span> <span class="n">cities</span><span class="p">:</span>
        <span class="n">match</span> <span class="n">city</span><span class="p">:</span>
            <span class="n">case</span> <span class="n">City</span><span class="p">(</span><span class="n">continent</span><span class="o">=</span><span class="s">'Asia'</span><span class="p">,</span> <span class="n">country</span><span class="o">=</span><span class="n">cc</span><span class="p">):</span>
                <span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span>

<span class="c1">## the new types way.
</span>
<span class="n">match</span> <span class="n">city</span><span class="p">:</span>
  <span class="n">case</span> <span class="n">City</span><span class="p">(</span><span class="n">continent</span><span class="o">=</span><span class="s">'Asia'</span><span class="p">,</span> <span class="n">country</span><span class="o">=</span><span class="n">country</span><span class="p">):</span>
    <span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">country</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="chapter-6-object-references-mutability-and-recycling">Chapter 6: Object References, Mutability and Recycling</h2>

<p>You can use the <code class="language-plaintext highlighter-rouge">id()</code> build in to get the id of an object.  In CPython <code class="language-plaintext highlighter-rouge">id()</code> returns the memory address of an object, but it could be something different in other implementations.  Generally you don’t need to call <code class="language-plaintext highlighter-rouge">id()</code> you can use the <code class="language-plaintext highlighter-rouge">is</code> operator to check if two objects are the same object for example <code class="language-plaintext highlighter-rouge">var_a is var_b</code>.  <code class="language-plaintext highlighter-rouge">is</code> operator compares identidies while <code class="language-plaintext highlighter-rouge">==</code> compares equality.</p>

<h3 id="copies-are-shallow-by-default">Copies are shallow by default.</h3>

<p>Easiest way to copy a list (or most build-in collections) is to use the build-in constructor for the type itself for example.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">l1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">[</span><span class="mi">55</span><span class="p">,</span> <span class="mi">44</span><span class="p">],</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">l2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">l1</span><span class="p">)</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">l2</span>
<span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">[</span><span class="mi">55</span><span class="p">,</span> <span class="mi">44</span><span class="p">],</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">l2</span> <span class="o">==</span> <span class="n">l1</span>  
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">l2</span> <span class="ow">is</span> <span class="n">l1</span>  
<span class="bp">False</span>
</code></pre></div></div>

<p>An altenative for the above the works for lists and other mutable sequences is <code class="language-plaintext highlighter-rouge">l2 = l1[:]</code>.  Both of these options produce a shallow copy.  The outer most container is duplicated, but the copy is filled with references to the same items held by the original container.  This is fine if the items are immutable but if not mutable you will get references to same objects.</p>

<h3 id="deep-and-shallow-copies-of-arbitratry-objects">Deep and Shallow Copies of Arbitratry Objects</h3>

<p>The <code class="language-plaintext highlighter-rouge">copy</code> module provides <code class="language-plaintext highlighter-rouge">deepcopy</code> and <code class="language-plaintext highlighter-rouge">copy</code> functions that return deep and shallow copies of arbitrary objects.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Bus</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">passengers</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">passengers</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">passengers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">passengers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">passengers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">passengers</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">drop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">passengers</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">copy</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bus1</span> <span class="o">=</span> <span class="n">Bus</span><span class="p">([</span><span class="s">'Alice'</span><span class="p">,</span> <span class="s">'Bill'</span><span class="p">,</span> <span class="s">'Claire'</span><span class="p">,</span> <span class="s">'David'</span><span class="p">])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bus2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bus1</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bus3</span> <span class="o">=</span> <span class="n">copy</span><span class="p">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">bus1</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">id</span><span class="p">(</span><span class="n">bus1</span><span class="p">),</span> <span class="nb">id</span><span class="p">(</span><span class="n">bus2</span><span class="p">),</span> <span class="nb">id</span><span class="p">(</span><span class="n">bus3</span><span class="p">)</span>
<span class="p">(</span><span class="mi">4301498296</span><span class="p">,</span> <span class="mi">4301499416</span><span class="p">,</span> <span class="mi">4301499752</span><span class="p">)</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">bus1</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="s">'Bill'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bus2</span><span class="p">.</span><span class="n">passengers</span>
<span class="p">[</span><span class="s">'Alice'</span><span class="p">,</span> <span class="s">'Claire'</span><span class="p">,</span> <span class="s">'David'</span><span class="p">]</span>          
<span class="o">&gt;&gt;&gt;</span> <span class="nb">id</span><span class="p">(</span><span class="n">bus1</span><span class="p">.</span><span class="n">passengers</span><span class="p">),</span> <span class="nb">id</span><span class="p">(</span><span class="n">bus2</span><span class="p">.</span><span class="n">passengers</span><span class="p">),</span> <span class="nb">id</span><span class="p">(</span><span class="n">bus3</span><span class="p">.</span><span class="n">passengers</span><span class="p">)</span>
<span class="p">(</span><span class="mi">4302658568</span><span class="p">,</span> <span class="mi">4302658568</span><span class="p">,</span> <span class="mi">4302657800</span><span class="p">)</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">bus3</span><span class="p">.</span><span class="n">passengers</span>
<span class="p">[</span><span class="s">'Alice'</span><span class="p">,</span> <span class="s">'Bill'</span><span class="p">,</span> <span class="s">'Claire'</span><span class="p">,</span> <span class="s">'David'</span><span class="p">]</span>  
</code></pre></div></div>

<p>Note that deepcopy is not trivial.  An object may have cyclical references and you need to track what has already been copied.  You can control the behaviour of both <code class="language-plaintext highlighter-rouge">copy</code> and <code class="language-plaintext highlighter-rouge">deepcopy</code> by implementing <code class="language-plaintext highlighter-rouge">__deepcopy__</code> and <code class="language-plaintext highlighter-rouge">__copy__</code> sepcial methods.</p>

<h3 id="function-parameters-as-references">Function Parameters as References</h3>

<p>Parameters inside the function become aliases of the acutal arguments.  The result of this scheme is that any function may change any mutable object passed as a parameter, but it cannot change the identityt of those objects.  In other words it cannot al togetehr replace an object with another.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="p">...</span>     <span class="n">a</span> <span class="o">+=</span> <span class="n">b</span>
<span class="p">...</span>     <span class="k">return</span> <span class="n">a</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="mi">3</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>  
<span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>  
<span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>  
<span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">t</span><span class="p">,</span> <span class="n">u</span>
<span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">))</span>
</code></pre></div></div>

<h3 id="mutable-types-as-parameter-defaults-bad-idea">Mutable Types as Parameter Defaults: Bad Idea</h3>

<p>The code below illustrates how if you do not set an inital passenger list the instances that get the default empy list all share the same list.  The way to work around this is to set the default to <code class="language-plaintext highlighter-rouge">None</code> and in the init method set the value to an empty list if the value is <code class="language-plaintext highlighter-rouge">None</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">HauntedBus</span><span class="p">:</span>
    <span class="s">"""A bus model haunted by ghost passengers"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">passengers</span><span class="o">=</span><span class="p">[]):</span>  
        <span class="bp">self</span><span class="p">.</span><span class="n">passengers</span> <span class="o">=</span> <span class="n">passengers</span>  

    <span class="k">def</span> <span class="nf">pick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">passengers</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>  

    <span class="k">def</span> <span class="nf">drop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">passengers</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">bus1</span> <span class="o">=</span> <span class="n">HauntedBus</span><span class="p">([</span><span class="s">'Alice'</span><span class="p">,</span> <span class="s">'Bill'</span><span class="p">])</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">bus1</span><span class="p">.</span><span class="n">passengers</span>
<span class="p">[</span><span class="s">'Alice'</span><span class="p">,</span> <span class="s">'Bill'</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bus1</span><span class="p">.</span><span class="n">pick</span><span class="p">(</span><span class="s">'Charlie'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bus1</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="s">'Alice'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bus1</span><span class="p">.</span><span class="n">passengers</span>  
<span class="p">[</span><span class="s">'Bill'</span><span class="p">,</span> <span class="s">'Charlie'</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bus2</span> <span class="o">=</span> <span class="n">HauntedBus</span><span class="p">()</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">bus2</span><span class="p">.</span><span class="n">pick</span><span class="p">(</span><span class="s">'Carrie'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bus2</span><span class="p">.</span><span class="n">passengers</span>
<span class="p">[</span><span class="s">'Carrie'</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bus3</span> <span class="o">=</span> <span class="n">HauntedBus</span><span class="p">()</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">bus3</span><span class="p">.</span><span class="n">passengers</span>  
<span class="p">[</span><span class="s">'Carrie'</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bus3</span><span class="p">.</span><span class="n">pick</span><span class="p">(</span><span class="s">'Dave'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bus2</span><span class="p">.</span><span class="n">passengers</span>  
<span class="p">[</span><span class="s">'Carrie'</span><span class="p">,</span> <span class="s">'Dave'</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bus2</span><span class="p">.</span><span class="n">passengers</span> <span class="ow">is</span> <span class="n">bus3</span><span class="p">.</span><span class="n">passengers</span>  
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bus1</span><span class="p">.</span><span class="n">passengers</span>  
<span class="p">[</span><span class="s">'Bill'</span><span class="p">,</span> <span class="s">'Charlie'</span><span class="p">]</span>
</code></pre></div></div>

<h3 id="defensive-programming-with-mutable-parameters">Defensive Programming with Mutable Parameters</h3>

<p>You need to be careful with acting on mutable types passed to functions.  Fore example is someone passed a list to the init method in the example above and you dropped a passenger you would remove that passenger from the list.  Make sure that you make a copy of the list bieng passed in this scenario so you don’t cause bugs.</p>

<h3 id="del-and-garbage-collection">del and Garbage Collection</h3>

<p><code class="language-plaintext highlighter-rouge">del</code> is not a function its a statement.  We write <code class="language-plaintext highlighter-rouge">del x</code> NOT <code class="language-plaintext highlighter-rouge">del(x)</code>.  <code class="language-plaintext highlighter-rouge">del(x)</code> also works but that is becuase <code class="language-plaintext highlighter-rouge">x</code> and <code class="language-plaintext highlighter-rouge">(x)</code> evaluate to the same thing.</p>

<p><code class="language-plaintext highlighter-rouge">del</code> deletes references not objects.</p>

<p>The example below uses <code class="language-plaintext highlighter-rouge">weakref.finalize</code> to have a callback be called when an object is destroyed.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">weakref</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">s1</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">s1</span>         
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">bye</span><span class="p">():</span>      
<span class="p">...</span>     <span class="k">print</span><span class="p">(</span><span class="s">'...like tears in the rain.'</span><span class="p">)</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ender</span> <span class="o">=</span> <span class="n">weakref</span><span class="p">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">bye</span><span class="p">)</span>  <span class="c1"># register bye callback on the ojbect referred by s1
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">ender</span><span class="p">.</span><span class="n">alive</span>  
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">del</span> <span class="n">s1</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ender</span><span class="p">.</span><span class="n">alive</span>  
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">s2</span> <span class="o">=</span> <span class="s">'spam'</span>  
<span class="p">...</span><span class="n">like</span> <span class="n">tears</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">rain</span><span class="p">.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ender</span><span class="p">.</span><span class="n">alive</span>
<span class="bp">False</span>
</code></pre></div></div>

<h2 id="functions-as-first-class-objects-chapter-7">Functions as First Class Objects (Chapter 7)</h2>

<h3 id="higher-order-functions">Higher-Order Functions</h3>

<p>A function that takes a function as an argument or returns a function as a result is a <strong>higher-order function</strong>.  <code class="language-plaintext highlighter-rouge">sorted</code> is an example of a higher order function.</p>

<h3 id="anonymous-functions">Anonymous Functions</h3>

<p>The <code class="language-plaintext highlighter-rouge">lambda</code> keyword creates an anonymous function within a Python expression.  The simple syntax of Python limits <code class="language-plaintext highlighter-rouge">lamda</code> functions to be pure expressions (body cannot contain other Python statemetns such as <code class="language-plaintext highlighter-rouge">while</code> or <code class="language-plaintext highlighter-rouge">try</code>)</p>

<p>The best use of anonymous functions is in the context of an argument list for a higher order function.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">fruits</span> <span class="o">=</span> <span class="p">[</span><span class="s">'strawberry'</span><span class="p">,</span> <span class="s">'fig'</span><span class="p">,</span> <span class="s">'apple'</span><span class="p">,</span> <span class="s">'cherry'</span><span class="p">,</span> <span class="s">'raspberry'</span><span class="p">,</span> <span class="s">'banana'</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fruits</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">word</span><span class="p">:</span> <span class="n">word</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="p">[</span><span class="s">'banana'</span><span class="p">,</span> <span class="s">'apple'</span><span class="p">,</span> <span class="s">'fig'</span><span class="p">,</span> <span class="s">'raspberry'</span><span class="p">,</span> <span class="s">'strawberry'</span><span class="p">,</span> <span class="s">'cherry'</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span>
</code></pre></div></div>

<p>Lambda statement is just syntactic sugar.  It creates a function object just like anything else.</p>

<h3 id="the-nine-flavoers-of-callable-objects">The Nine Flavoers of Callable Objects</h3>

<p>The call operator <code class="language-plaintext highlighter-rouge">()</code> may be applied to other ojbects beside functions.  To determine if an object is a callable use the <code class="language-plaintext highlighter-rouge">callable()</code> build-in funciton.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="nb">abs</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="s">'Ni!'</span>
<span class="p">(</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">function</span> <span class="nb">abs</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">str</span><span class="s">'&gt;, '</span><span class="n">Ni</span><span class="err">!</span><span class="s">')
&gt;&gt;&gt; [callable(obj) for obj in (abs, str, '</span><span class="n">Ni</span><span class="err">!</span><span class="s">')]
[True, True, False]
</span></code></pre></div></div>

<p>As of Python 3.9 ther are 9 callable types.</p>

<ul>
  <li>User Defined Functions created with <code class="language-plaintext highlighter-rouge">def</code> or <code class="language-plaintext highlighter-rouge">lambda</code> statements</li>
  <li>Build in functions such as <code class="language-plaintext highlighter-rouge">len</code> or <code class="language-plaintext highlighter-rouge">time.strftime</code></li>
  <li>Build in methods such as <code class="language-plaintext highlighter-rouge">dict.get</code></li>
  <li>Methods: functions defined in body of a class.</li>
  <li>Classes: When ivoked a class runs its <code class="language-plaintext highlighter-rouge">__new__</code> method to create an instance, then <code class="language-plaintext highlighter-rouge">__init__</code> to initialize it, and finally the instance is returned to the caller.  Because ther is no <code class="language-plaintext highlighter-rouge">new</code> operator in Python calling a class is like calling a function.</li>
  <li>Class instances: If a class defines a <code class="language-plaintext highlighter-rouge">__call__</code> method, then its instnace may be invokes as functions.</li>
  <li>Generator functions: Functions or methods that use <code class="language-plaintext highlighter-rouge">yield</code> keyword in their body.  When called they return a generator object.</li>
  <li>Native coroutine functions: Functions or methods defined with async def.  When called they return a coroutine object.  Added in Python 3.5.</li>
  <li>Asynchronous generator functions: Functiosn or methods defined with async def that have yeild in their body.  When called they return an asynchronous generator for use with <code class="language-plaintext highlighter-rouge">async for</code> Added in Python 3.6.</li>
</ul>

<p>Below is an example of implementing <code class="language-plaintext highlighter-rouge">__call__</code> in a class to make the class a callable.  A class implementing <code class="language-plaintext highlighter-rouge">__call__</code> is an easy way to create funciton-like objects that have some internal state that must be kept across invocations.  Another good use case for <code class="language-plaintext highlighter-rouge">__call__</code> is implementing decorators.  Decorators must be callable and its sometimes convinient to remember somethign between calls of the decorator.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">random</span>

<span class="k">class</span> <span class="nc">BingoCage</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>  
        <span class="n">random</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_items</span><span class="p">)</span>  

    <span class="k">def</span> <span class="nf">pick</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_items</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">LookupError</span><span class="p">(</span><span class="s">'pick from empty BingoCage'</span><span class="p">)</span>  

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">pick</span><span class="p">()</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">bingo</span> <span class="o">=</span> <span class="n">BingoCage</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bingo</span><span class="p">.</span><span class="n">pick</span><span class="p">()</span>
<span class="mi">1</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bingo</span><span class="p">()</span>
<span class="mi">0</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">callable</span><span class="p">(</span><span class="n">bingo</span><span class="p">)</span>
<span class="bp">True</span>
</code></pre></div></div>

<h3 id="from-positional-to-keyword-only-parameters">From Positional to Keyword-Only Parameters</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">tag</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">content</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">attrs</span><span class="p">):</span>
    <span class="s">"""Generate one or more HTML tags"""</span>
    <span class="k">if</span> <span class="n">class_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s">'class'</span><span class="p">]</span> <span class="o">=</span> <span class="n">class_</span>
    <span class="n">attr_pairs</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s">' </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s">="</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s">"'</span> <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span>
                    <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">attrs</span><span class="p">.</span><span class="n">items</span><span class="p">()))</span>
    <span class="n">attr_str</span> <span class="o">=</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">attr_pairs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s">'&lt;</span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">attr_str</span><span class="si">}</span><span class="s">&gt;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s">&lt;/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">&gt;'</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">content</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s">'&lt;</span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">attr_str</span><span class="si">}</span><span class="s"> /&gt;'</span>

 
<span class="o">&gt;&gt;&gt;</span> <span class="n">tag</span><span class="p">(</span><span class="s">'br'</span><span class="p">)</span>  <span class="c1"># A single positional argument produces an ampty tag with that name.
</span><span class="s">'&lt;br /&gt;'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">tag</span><span class="p">(</span><span class="s">'p'</span><span class="p">,</span> <span class="s">'hello'</span><span class="p">)</span>  <span class="c1"># Any number of argumetns after the first are captured by *content as a tuple.
</span><span class="s">'&lt;p&gt;hello&lt;/p&gt;'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">tag</span><span class="p">(</span><span class="s">'p'</span><span class="p">,</span> <span class="s">'hello'</span><span class="p">,</span> <span class="s">'world'</span><span class="p">))</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">hello</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">world</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">tag</span><span class="p">(</span><span class="s">'p'</span><span class="p">,</span> <span class="s">'hello'</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">33</span><span class="p">)</span>  <span class="c1"># Keyword arguments not explicitly named in tag signature are captured by **attrs as a dict.
</span><span class="s">'&lt;p id="33"&gt;hello&lt;/p&gt;'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">tag</span><span class="p">(</span><span class="s">'p'</span><span class="p">,</span> <span class="s">'hello'</span><span class="p">,</span> <span class="s">'world'</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s">'sidebar'</span><span class="p">))</span>  <span class="c1"># The class_ parameter can only be passed as a keyword argument.
</span><span class="o">&lt;</span><span class="n">p</span> <span class="n">class</span><span class="o">=</span><span class="s">"sidebar"</span><span class="o">&gt;</span><span class="n">hello</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span> <span class="n">class</span><span class="o">=</span><span class="s">"sidebar"</span><span class="o">&gt;</span><span class="n">world</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">tag</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s">'testing'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"img"</span><span class="p">)</span>  <span class="c1"># The first positional argument can also be passed as a keyword.
</span><span class="s">'&lt;img content="testing" /&gt;'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">my_tag</span> <span class="o">=</span> <span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'img'</span><span class="p">,</span> <span class="s">'title'</span><span class="p">:</span> <span class="s">'Sunset Boulevard'</span><span class="p">,</span>
<span class="p">...</span>           <span class="s">'src'</span><span class="p">:</span> <span class="s">'sunset.jpg'</span><span class="p">,</span> <span class="s">'class'</span><span class="p">:</span> <span class="s">'framed'</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">tag</span><span class="p">(</span><span class="o">**</span><span class="n">my_tag</span><span class="p">)</span>  <span class="c1"># Prefixing the my_tag dict with ** passes all its itmes as separate arguments whcih are then bound to the named parameters with the remaining caugth by **attrs.  In this case we can have a 'class' key in the arguments dict because it is a string, and does not clash with the class reserved keyword.
</span><span class="s">'&lt;img class="framed" src="sunset.jpg" title="Sunset Boulevard" /&gt;'</span>
</code></pre></div></div>

<p>Keyword only arguments are a feature of Pyton 3.  The <code class="language-plaintext highlighter-rouge">class_</code> param in exaple above can only be given as a keyword argument.  It will never capture un-named positional arguments.  To specify keyword-only arguments when defining a function, name them after the argumetn prfixed with <code class="language-plaintext highlighter-rouge">*</code>.  If you don’t want to support variable positional arguments but still want keyword-only arguments, put a * by itself in the signature like below.  Note that keyword- only arguments do not need to have a default value: they can be mandaroty, like b in the preceding example.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="nb">TypeError</span><span class="p">:</span> <span class="n">f</span><span class="p">()</span> <span class="n">takes</span> <span class="mi">1</span> <span class="n">positional</span> <span class="n">argument</span> <span class="n">but</span> <span class="mi">2</span> <span class="n">were</span> <span class="n">given</span>
</code></pre></div></div>

<h3 id="positional-only-parameters">Positional-Only Parameters</h3>

<p>Since Python 3.8 user-defined function signatures may specify positional-only parameters.  To define a function requiring positional only parameters ue the <code class="language-plaintext highlighter-rouge">/</code> in the parameter list.  Not that this is a syntax violation if in Python 3.7 or earlier.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">divmod</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">/</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">//</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">%</span> <span class="n">b</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="packages-for-functional-programming">Packages for Functional Programming</h3>

<h4 id="the-operator-module">The operator Module</h4>

<p>Below are two examples of implementing factorial.  The first without the <code class="language-plaintext highlighter-rouge">operator</code> module and the secon with.  Operator module has function versions of oberators so you don’t have to write trivial functiosn with <code class="language-plaintext highlighter-rouge">lambda</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Without operator module
</span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="nb">reduce</span>

<span class="k">def</span> <span class="nf">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span><span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># Using the operator module
</span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="nb">reduce</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">mul</span>

<span class="k">def</span> <span class="nf">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">reduce</span><span class="p">(</span><span class="n">mul</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div></div>

<p>Another group of one trick lambdas <code class="language-plaintext highlighter-rouge">operator</code> module replaces are functions to pick items from sequences or read attributes from objects.  <code class="language-plaintext highlighter-rouge">itemgetter</code> and <code class="language-plaintext highlighter-rouge">attrgetter</code> are factories that build custom function to do that.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">metro_data</span> <span class="o">=</span> <span class="p">[</span>
<span class="p">...</span>     <span class="p">(</span><span class="s">'Tokyo'</span><span class="p">,</span> <span class="s">'JP'</span><span class="p">,</span> <span class="mf">36.933</span><span class="p">,</span> <span class="p">(</span><span class="mf">35.689722</span><span class="p">,</span> <span class="mf">139.691667</span><span class="p">)),</span>
<span class="p">...</span>     <span class="p">(</span><span class="s">'Delhi NCR'</span><span class="p">,</span> <span class="s">'IN'</span><span class="p">,</span> <span class="mf">21.935</span><span class="p">,</span> <span class="p">(</span><span class="mf">28.613889</span><span class="p">,</span> <span class="mf">77.208889</span><span class="p">)),</span>
<span class="p">...</span>     <span class="p">(</span><span class="s">'Mexico City'</span><span class="p">,</span> <span class="s">'MX'</span><span class="p">,</span> <span class="mf">20.142</span><span class="p">,</span> <span class="p">(</span><span class="mf">19.433333</span><span class="p">,</span> <span class="o">-</span><span class="mf">99.133333</span><span class="p">)),</span>
<span class="p">...</span>     <span class="p">(</span><span class="s">'New York-Newark'</span><span class="p">,</span> <span class="s">'US'</span><span class="p">,</span> <span class="mf">20.104</span><span class="p">,</span> <span class="p">(</span><span class="mf">40.808611</span><span class="p">,</span> <span class="o">-</span><span class="mf">74.020386</span><span class="p">)),</span>
<span class="p">...</span>     <span class="p">(</span><span class="s">'São Paulo'</span><span class="p">,</span> <span class="s">'BR'</span><span class="p">,</span> <span class="mf">19.649</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">23.547778</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.635833</span><span class="p">)),</span>
<span class="p">...</span> <span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">city</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">metro_data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
<span class="p">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
<span class="p">...</span>
<span class="p">(</span><span class="s">'São Paulo'</span><span class="p">,</span> <span class="s">'BR'</span><span class="p">,</span> <span class="mf">19.649</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">23.547778</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.635833</span><span class="p">))</span>
<span class="p">(</span><span class="s">'Delhi NCR'</span><span class="p">,</span> <span class="s">'IN'</span><span class="p">,</span> <span class="mf">21.935</span><span class="p">,</span> <span class="p">(</span><span class="mf">28.613889</span><span class="p">,</span> <span class="mf">77.208889</span><span class="p">))</span>
<span class="p">(</span><span class="s">'Tokyo'</span><span class="p">,</span> <span class="s">'JP'</span><span class="p">,</span> <span class="mf">36.933</span><span class="p">,</span> <span class="p">(</span><span class="mf">35.689722</span><span class="p">,</span> <span class="mf">139.691667</span><span class="p">))</span>
<span class="p">(</span><span class="s">'Mexico City'</span><span class="p">,</span> <span class="s">'MX'</span><span class="p">,</span> <span class="mf">20.142</span><span class="p">,</span> <span class="p">(</span><span class="mf">19.433333</span><span class="p">,</span> <span class="o">-</span><span class="mf">99.133333</span><span class="p">))</span>
<span class="p">(</span><span class="s">'New York-Newark'</span><span class="p">,</span> <span class="s">'US'</span><span class="p">,</span> <span class="mf">20.104</span><span class="p">,</span> <span class="p">(</span><span class="mf">40.808611</span><span class="p">,</span> <span class="o">-</span><span class="mf">74.020386</span><span class="p">))</span>
</code></pre></div></div>

<p>If you pass multiple index arguments to itemgetter, the function it builds will return tuples with the extracted values which is useful for sorting on multiple keys.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">cc_name</span> <span class="o">=</span> <span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">city</span> <span class="ow">in</span> <span class="n">metro_data</span><span class="p">:</span>
<span class="p">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">cc_name</span><span class="p">(</span><span class="n">city</span><span class="p">))</span>
<span class="p">...</span>
<span class="p">(</span><span class="s">'JP'</span><span class="p">,</span> <span class="s">'Tokyo'</span><span class="p">)</span>
<span class="p">(</span><span class="s">'IN'</span><span class="p">,</span> <span class="s">'Delhi NCR'</span><span class="p">)</span>
<span class="p">(</span><span class="s">'MX'</span><span class="p">,</span> <span class="s">'Mexico City'</span><span class="p">)</span>
<span class="p">(</span><span class="s">'US'</span><span class="p">,</span> <span class="s">'New York-Newark'</span><span class="p">)</span>
<span class="p">(</span><span class="s">'BR'</span><span class="p">,</span> <span class="s">'São Paulo'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span>
</code></pre></div></div>

<p>Because <code class="language-plaintext highlighter-rouge">itemgetter</code> use the <code class="language-plaintext highlighter-rouge">[]</code> operator it supports not only sequences but also mappings and any class that implements <code class="language-plaintext highlighter-rouge">__getitem__</code>.</p>

<p><code class="language-plaintext highlighter-rouge">attrgetter</code> creates functiosn to extract object attributes by name.  If you pass <code class="language-plaintext highlighter-rouge">attrgetter</code> several attribute names as arguments, it also returns a tuple of values.  In addition, If any argument name contains a <code class="language-plaintext highlighter-rouge">.</code> <code class="language-plaintext highlighter-rouge">attrgetter</code> navigates though nested object to retrieve the atribute.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">LatLon</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s">'LatLon'</span><span class="p">,</span> <span class="s">'lat lon'</span><span class="p">)</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">Metropolis</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s">'Metropolis'</span><span class="p">,</span> <span class="s">'name cc pop coord'</span><span class="p">)</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">metro_areas</span> <span class="o">=</span> <span class="p">[</span><span class="n">Metropolis</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">pop</span><span class="p">,</span> <span class="n">LatLon</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">))</span>  
<span class="p">...</span>     <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">pop</span><span class="p">,</span> <span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span> <span class="ow">in</span> <span class="n">metro_data</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">metro_areas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Metropolis</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'Tokyo'</span><span class="p">,</span> <span class="n">cc</span><span class="o">=</span><span class="s">'JP'</span><span class="p">,</span> <span class="n">pop</span><span class="o">=</span><span class="mf">36.933</span><span class="p">,</span> <span class="n">coord</span><span class="o">=</span><span class="n">LatLon</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="mf">35.689722</span><span class="p">,</span>
<span class="n">lon</span><span class="o">=</span><span class="mf">139.691667</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">metro_areas</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">coord</span><span class="p">.</span><span class="n">lat</span>  
<span class="mf">35.689722</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">attrgetter</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">name_lat</span> <span class="o">=</span> <span class="n">attrgetter</span><span class="p">(</span><span class="s">'name'</span><span class="p">,</span> <span class="s">'coord.lat'</span><span class="p">)</span>  
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">city</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">metro_areas</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s">'coord.lat'</span><span class="p">)):</span>  
<span class="p">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">name_lat</span><span class="p">(</span><span class="n">city</span><span class="p">))</span>  
<span class="p">...</span>
<span class="p">(</span><span class="s">'São Paulo'</span><span class="p">,</span> <span class="o">-</span><span class="mf">23.547778</span><span class="p">)</span>
<span class="p">(</span><span class="s">'Mexico City'</span><span class="p">,</span> <span class="mf">19.433333</span><span class="p">)</span>
<span class="p">(</span><span class="s">'Delhi NCR'</span><span class="p">,</span> <span class="mf">28.613889</span><span class="p">)</span>
<span class="p">(</span><span class="s">'Tokyo'</span><span class="p">,</span> <span class="mf">35.689722</span><span class="p">)</span>
<span class="p">(</span><span class="s">'New York-Newark'</span><span class="p">,</span> <span class="mf">40.808611</span><span class="p">)</span>

</code></pre></div></div>

<p>Below is a list of functions defined in <code class="language-plaintext highlighter-rouge">operator</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">operator</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'_'</span><span class="p">)]</span>
<span class="p">[</span><span class="s">'abs'</span><span class="p">,</span> <span class="s">'add'</span><span class="p">,</span> <span class="s">'and_'</span><span class="p">,</span> <span class="s">'attrgetter'</span><span class="p">,</span> <span class="s">'concat'</span><span class="p">,</span> <span class="s">'contains'</span><span class="p">,</span>
<span class="s">'countOf'</span><span class="p">,</span> <span class="s">'delitem'</span><span class="p">,</span> <span class="s">'eq'</span><span class="p">,</span> <span class="s">'floordiv'</span><span class="p">,</span> <span class="s">'ge'</span><span class="p">,</span> <span class="s">'getitem'</span><span class="p">,</span> <span class="s">'gt'</span><span class="p">,</span>
<span class="s">'iadd'</span><span class="p">,</span> <span class="s">'iand'</span><span class="p">,</span> <span class="s">'iconcat'</span><span class="p">,</span> <span class="s">'ifloordiv'</span><span class="p">,</span> <span class="s">'ilshift'</span><span class="p">,</span> <span class="s">'imatmul'</span><span class="p">,</span>
<span class="s">'imod'</span><span class="p">,</span> <span class="s">'imul'</span><span class="p">,</span> <span class="s">'index'</span><span class="p">,</span> <span class="s">'indexOf'</span><span class="p">,</span> <span class="s">'inv'</span><span class="p">,</span> <span class="s">'invert'</span><span class="p">,</span> <span class="s">'ior'</span><span class="p">,</span>
<span class="s">'ipow'</span><span class="p">,</span> <span class="s">'irshift'</span><span class="p">,</span> <span class="s">'is_'</span><span class="p">,</span> <span class="s">'is_not'</span><span class="p">,</span> <span class="s">'isub'</span><span class="p">,</span> <span class="s">'itemgetter'</span><span class="p">,</span>
<span class="s">'itruediv'</span><span class="p">,</span> <span class="s">'ixor'</span><span class="p">,</span> <span class="s">'le'</span><span class="p">,</span> <span class="s">'length_hint'</span><span class="p">,</span> <span class="s">'lshift'</span><span class="p">,</span> <span class="s">'lt'</span><span class="p">,</span> <span class="s">'matmul'</span><span class="p">,</span>
<span class="s">'methodcaller'</span><span class="p">,</span> <span class="s">'mod'</span><span class="p">,</span> <span class="s">'mul'</span><span class="p">,</span> <span class="s">'ne'</span><span class="p">,</span> <span class="s">'neg'</span><span class="p">,</span> <span class="s">'not_'</span><span class="p">,</span> <span class="s">'or_'</span><span class="p">,</span> <span class="s">'pos'</span><span class="p">,</span>
<span class="s">'pow'</span><span class="p">,</span> <span class="s">'rshift'</span><span class="p">,</span> <span class="s">'setitem'</span><span class="p">,</span> <span class="s">'sub'</span><span class="p">,</span> <span class="s">'truediv'</span><span class="p">,</span> <span class="s">'truth'</span><span class="p">,</span> <span class="s">'xor'</span><span class="p">]</span>
</code></pre></div></div>

<h3 id="freezing-arguments-with-functoolspartial">Freezing Arguments with functools.partial</h3>

<p><code class="language-plaintext highlighter-rouge">partial</code> function of the <code class="language-plaintext highlighter-rouge">functools</code> module lets us proudce a new callable with some fot he arguments of the original callable boudn to predetrmined values.  This is useful to adpet a function that takes one or more arguments to an API that requries a callback with fewer arguments.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">mul</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">triple</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">mul</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">triple</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>  
<span class="mi">21</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">triple</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)))</span>  
<span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">27</span><span class="p">]</span>
</code></pre></div></div>

<h2 id="chapter-8-type-hints">Chapter 8 Type hints</h2>

<p>You insatll mypy via <code class="language-plaintext highlighter-rouge">pip install mypy</code></p>

<p>The command line option <code class="language-plaintext highlighter-rouge">--disallow-untyped-defs</code> makes mypy flag any funcion definitiosn that do no hae type hints for all its parameters and for its return value.</p>

<p><code class="language-plaintext highlighter-rouge">--disallow-incomplete-defs</code> is another option.</p>

<p>Look into <code class="language-plaintext highlighter-rouge">flake8</code> and <code class="language-plaintext highlighter-rouge">blue</code> which check for syntax and blue will rewrite source code acording to (most) rules embedded in the <code class="language-plaintext highlighter-rouge">black</code> code formatting tool.</p>

<p>for srints single qoutes are preferred but not mandatory.  <code class="language-plaintext highlighter-rouge">black</code> does the double quote thing but <code class="language-plaintext highlighter-rouge">black -S</code> will leave the quotes alone.</p>

<p><code class="language-plaintext highlighter-rouge">Optional</code> is not a great name, because that annotation does not make the parameter optional.  What makes it optional is assigning a default value to the parameter.  <code class="language-plaintext highlighter-rouge">Optional[str]</code> just means: the type of this parameter may be <code class="language-plaintext highlighter-rouge">str</code> or <code class="language-plaintext highlighter-rouge">NoneType</code>.  <code class="language-plaintext highlighter-rouge">Optional[str]</code> is actually a shortcut for <code class="language-plaintext highlighter-rouge">Union[str, None]</code></p>

<p><code class="language-plaintext highlighter-rouge">Duck Typing</code> If I can invoke <code class="language-plaintext highlighter-rouge">birdie.quack()</code> then <code class="language-plaintext highlighter-rouge">birdie</code> is a duck.  In other words it does not matter what declared types are only what operations it actually supports.  Duck Typing is only enforced at runtime and is more flexible but allows for more errors.</p>

<p><code class="language-plaintext highlighter-rouge">Normal Typing</code> Normal typing is enforced statically.  It looks at the code.  Allows for less bugs but is more flexible.</p>

<h3 id="types-usable-in-annotations">Types Usable in Annotations</h3>

<p><code class="language-plaintext highlighter-rouge">Any</code> type is the catch all.</p>

<p><code class="language-plaintext highlighter-rouge">int</code>, <code class="language-plaintext highlighter-rouge">float</code>, <code class="language-plaintext highlighter-rouge">str</code>, <code class="language-plaintext highlighter-rouge">bytes</code> are the hints for simple types.</p>

<p>Abstract Base Classes are also usefull as type hints.  You need to keep in mind that if you use a class in a type hint and pass a parent as an agument if child class implements method used in function and you pass a parent type hints will catch that.</p>

<p><code class="language-plaintext highlighter-rouge">Union[int, float]</code> is reduntant because <code class="language-plaintext highlighter-rouge">int</code> is consistent with <code class="language-plaintext highlighter-rouge">float</code> (consistent means implements the same operations).  If you use <code class="language-plaintext highlighter-rouge">float</code> to annotate the parameter, it will accept int values as well.</p>

<p>If you are using defaultdict and dicts do the follwing.  Using the <code class="language-plaintext highlighter-rouge">Mapping</code> type will allow the caller to pass a dict or a default dict User Dict etc.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Mapping</span>

<span class="k">def</span> <span class="nf">name2hex</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">color_map</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</code></pre></div></div>

<p>Instead of <code class="language-plaintext highlighter-rouge">typing.List</code> for paremeters consider using <code class="language-plaintext highlighter-rouge">Sequence</code> or <code class="language-plaintext highlighter-rouge">Iterable</code> for function parameter type hints.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="k">def</span> <span class="nf">fsum</span><span class="p">(</span><span class="n">__seq</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</code></pre></div></div>

<p>and one more example…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>

<span class="n">FromTo</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>  

<span class="k">def</span> <span class="nf">zip_replace</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">changes</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">FromTo</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>  
    <span class="k">for</span> <span class="n">from_</span><span class="p">,</span> <span class="n">to</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">from_</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span>
</code></pre></div></div>

<p>Using <code class="language-plaintext highlighter-rouge">Iterable</code> gives the caller to pass in a generator to save memory.  <code class="language-plaintext highlighter-rouge">Sequence</code> cannot be a negerator as it must support <code class="language-plaintext highlighter-rouge">len()</code></p>

<h3 id="parameterized-generics-and-typevar">Parameterized Generics and TypeVar</h3>

<p>A parameterized generic is a generic type, written as <code class="language-plaintext highlighter-rouge">list[T]</code> where <code class="language-plaintext highlighter-rouge">T</code> is a type variable that will be bound to a specific type with each usage.  This allows the paramete type to be reflected on the result type.  Use of <code class="language-plaintext highlighter-rouge">TypeVar</code> in example below is needed becuse otherwise you would need to make deep changes in the python interpreter.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Sequence</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">shuffle</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s">'T'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="n">population</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'size must be &gt;= 1'</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>
    <span class="n">shuffle</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">[:</span><span class="n">size</span><span class="p">]</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">TypeVar</code> accepts extra positional arguments to restrict the type parameter.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span> <span class="nn">fractions</span> <span class="kn">import</span> <span class="n">Fraction</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span>

<span class="n">NumberT</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s">'NumberT'</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">NumberT</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NumberT</span><span class="p">:</span>
</code></pre></div></div>

<p>You can alsow use the <code class="language-plaintext highlighter-rouge">bound</code> keyword in <code class="language-plaintext highlighter-rouge">TypeVar</code> to bound the type to a certina parent in the class hierarchy.  In the below example with bound to <code class="language-plaintext highlighter-rouge">Hashable</code> which means Typing will not allow anything int he class hierarchy higher than Hashable.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Hashable</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span>

<span class="n">HashableT</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s">'HashableT'</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Hashable</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">HashableT</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">HashableT</span><span class="p">:</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'no mode for empty data'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div>

<h3 id="anystr-predefined-type-variable">AnyStr predefined type variable</h3>

<p>They <code class="language-plaintext highlighter-rouge">typing</code> modules included a prediefined <code class="language-plaintext highlighter-rouge">TypeVar</code> named <code class="language-plaintext highlighter-rouge">AnyStr</code>.  Its uses in functions that accept either <code class="language-plaintext highlighter-rouge">bytes</code> or <code class="language-plaintext highlighter-rouge">str</code>, and return values of the given type.</p>

<p>Its defined as in the exmple below.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AnyStr</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s">'AnyStr'</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</code></pre></div></div>

<p>Below is an examle of using a protocoal to limit what can be passed.  We are checking for supports less than becuased sorted needs that.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span>

<span class="kn">from</span> <span class="nn">comparable</span> <span class="kn">import</span> <span class="n">SupportsLessThan</span>

<span class="n">LT</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s">'LT'</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">SupportsLessThan</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">top</span><span class="p">(</span><span class="n">series</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">LT</span><span class="p">],</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">LT</span><span class="p">]:</span>
    <span class="n">ordered</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ordered</span><span class="p">[:</span><span class="n">length</span><span class="p">]</span>
</code></pre></div></div>

<p>Just for your reference the unit tests for teh above code are below…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterator</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>  

<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">top</span> <span class="kn">import</span> <span class="n">top</span>

<span class="c1"># several lines omitted
</span>
<span class="k">def</span> <span class="nf">test_top_tuples</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">fruit</span> <span class="o">=</span> <span class="s">'mango pear apple kiwi banana'</span><span class="p">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">series</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>  
        <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">fruit</span><span class="p">)</span>
    <span class="n">length</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">6</span><span class="p">,</span> <span class="s">'banana'</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">'mango'</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">'apple'</span><span class="p">)]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">top</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>  
        <span class="n">reveal_type</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>  
        <span class="n">reveal_type</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span>
        <span class="n">reveal_type</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">expected</span>

<span class="c1"># intentional type error
</span><span class="k">def</span> <span class="nf">test_top_objects_error</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">series</span> <span class="o">=</span> <span class="p">[</span><span class="nb">object</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
        <span class="n">reveal_type</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="p">.</span><span class="n">raises</span><span class="p">(</span><span class="nb">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">excinfo</span><span class="p">:</span>
        <span class="n">top</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  
    <span class="k">assert</span> <span class="s">"'&lt;' not supported"</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">excinfo</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="callable">Callable</h3>

<p>To annotate cllback parameters or callable objects returend by higher-order functions <code class="language-plaintext highlighter-rouge">collections.abc</code> module provides the Callable t ype, available in <code class="language-plaintext highlighter-rouge">typing</code> modules for thos not yet using Python 3.0.</p>

<p>Exampel bleow is about…</p>

<p>Imagine a temperature control system with a simple update function as shown in Example 8-24. The update function calls the probe function to get the current temperature, and calls display to show the temperature to the user. Both probe and display are passed as arguments to update for didactic reasons. The goal of the example is to contrast two Callable annotations: one with a return type, the other with a parameter type.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Callable</span>

<span class="k">def</span> <span class="nf">update</span><span class="p">(</span>  
        <span class="n">probe</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">float</span><span class="p">],</span>  
        <span class="n">display</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">float</span><span class="p">],</span> <span class="bp">None</span><span class="p">]</span>  
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="n">probe</span><span class="p">()</span>
    <span class="c1"># imagine lots of control code here
</span>    <span class="n">display</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">probe_ok</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>  
    <span class="k">return</span> <span class="mi">42</span>

<span class="k">def</span> <span class="nf">display_wrong</span><span class="p">(</span><span class="n">temperature</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>  
    <span class="k">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">temperature</span><span class="p">))</span>

<span class="n">update</span><span class="p">(</span><span class="n">probe_ok</span><span class="p">,</span> <span class="n">display_wrong</span><span class="p">)</span>  <span class="c1"># type error  
</span>
<span class="k">def</span> <span class="nf">display_ok</span><span class="p">(</span><span class="n">temperature</span><span class="p">:</span> <span class="nb">complex</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>  
    <span class="k">print</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>

<span class="n">update</span><span class="p">(</span><span class="n">probe_ok</span><span class="p">,</span> <span class="n">display_ok</span><span class="p">)</span>  <span class="c1"># OK  
</span></code></pre></div></div>

<h3 id="noreturn">NoReturn</h3>

<p>This is a special type used only to annotat the return type of functions that never return.</p>

<p>The <code class="language-plaintext highlighter-rouge">__status</code> parameter is positiona only, and it has a default value.  Stuf files don’t spell out the deafult vlaues, they use the <code class="language-plaintext highlighter-rouge">...</code> elpsis which means that the function can can an arbitrary number of argumetns.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">exit</span><span class="p">(</span><span class="n">__status</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="p">...)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span> <span class="p">...</span>
</code></pre></div></div>

<h3 id="imperfect-typing-and-string-testing">Imperfect Typing and String Testing</h3>

<p>Some usefull feature cannot be statically checked for exmple <code class="language-plaintext highlighter-rouge">config(**settings)</code> argument unpacking.</p>

<p>Advanced fatues like properties, descirptors, metaclassed and metaprogramming are poorly supported by type checkers.</p>

<h2 id="decorators-and-closures">Decorators and Closures</h2>

<h3 id="decorators-101">Decorators 101</h3>

<p>A decorator is a callable that takes another function as an argument (the decorated function).</p>

<p>A decorator may perfrom some processing with the docorated function, and returns it or rplaces it with another function or callable object.</p>

<p>Assuming you have a decorator named <code class="language-plaintext highlighter-rouge">decorate</code> the to defintions below are effectively the same.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">decorate</span>
<span class="k">def</span> <span class="nf">target</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'running target()'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">target</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'running target()'</span><span class="p">)</span>

<span class="n">target</span> <span class="o">=</span> <span class="n">decorate</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</code></pre></div></div>

<p>A key feature of decordators is that they run right after the decorator function is defined.  That is usually at import time (i.e. when a module is loaded by Python)</p>

<p>Note that in example below <code class="language-plaintext highlighter-rouge">register</code> runs twice, beofre any other function in the module when <code class="language-plaintext highlighter-rouge">register</code> is called, it recieves the decorated function object as an argument.  After the module is loaded, the <code class="language-plaintext highlighter-rouge">registry</code> list holds references to the two decorated functions <code class="language-plaintext highlighter-rouge">f1</code> and <code class="language-plaintext highlighter-rouge">f2</code>.  These functions as well as <code class="language-plaintext highlighter-rouge">f3</code>, aer only executed when explicitly called by <code class="language-plaintext highlighter-rouge">main</code>.  The main point here is that function decorators are executed as soon as the module is imported, but the decorated functions only run whent hey are explicity invoked.  This highlights the difference between what Pythonistas call import time and runtime.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">registry</span> <span class="o">=</span> <span class="p">[]</span>  

<span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>  
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'running register(</span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s">)'</span><span class="p">)</span>  
    <span class="n">registry</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>  
    <span class="k">return</span> <span class="n">func</span>  

<span class="o">@</span><span class="n">register</span>  
<span class="k">def</span> <span class="nf">f1</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'running f1()'</span><span class="p">)</span>

<span class="o">@</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">f2</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'running f2()'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">f3</span><span class="p">():</span>  
    <span class="k">print</span><span class="p">(</span><span class="s">'running f3()'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>  
    <span class="k">print</span><span class="p">(</span><span class="s">'running main()'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'registry -&gt;'</span><span class="p">,</span> <span class="n">registry</span><span class="p">)</span>
    <span class="n">f1</span><span class="p">()</span>
    <span class="n">f2</span><span class="p">()</span>
    <span class="n">f3</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span> 
</code></pre></div></div>

<p>The scribt above running lookse like …</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">python3</span> <span class="n">registration</span><span class="p">.</span><span class="n">py</span>
<span class="n">running</span> <span class="n">register</span><span class="p">(</span><span class="o">&lt;</span><span class="n">function</span> <span class="n">f1</span> <span class="n">at</span> <span class="mh">0x100631bf8</span><span class="o">&gt;</span><span class="p">)</span>
<span class="n">running</span> <span class="n">register</span><span class="p">(</span><span class="o">&lt;</span><span class="n">function</span> <span class="n">f2</span> <span class="n">at</span> <span class="mh">0x100631c80</span><span class="o">&gt;</span><span class="p">)</span>
<span class="n">running</span> <span class="n">main</span><span class="p">()</span>
<span class="n">registry</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">function</span> <span class="n">f1</span> <span class="n">at</span> <span class="mh">0x100631bf8</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">f2</span> <span class="n">at</span> <span class="mh">0x100631c80</span><span class="o">&gt;</span><span class="p">]</span>
<span class="n">running</span> <span class="n">f1</span><span class="p">()</span>
<span class="n">running</span> <span class="n">f2</span><span class="p">()</span>
<span class="n">running</span> <span class="n">f3</span><span class="p">()</span>
</code></pre></div></div>

<p>If *registration.py_ is imported (and nto run as a scrpt), the output is…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">registration</span>
<span class="n">running</span> <span class="n">register</span><span class="p">(</span><span class="o">&lt;</span><span class="n">function</span> <span class="n">f1</span> <span class="n">at</span> <span class="mh">0x10063b1e0</span><span class="o">&gt;</span><span class="p">)</span>
<span class="n">running</span> <span class="n">register</span><span class="p">(</span><span class="o">&lt;</span><span class="n">function</span> <span class="n">f2</span> <span class="n">at</span> <span class="mh">0x10063b268</span><span class="o">&gt;</span><span class="p">)</span>
</code></pre></div></div>

<p>Considering how decorators are commonly emploiyed in read code, the above example is unusual in two ways.</p>

<ul>
  <li>
    <p>The deocrate function is defined in the same moulde as the decorated functions.  A real decorator is usually defined in one module and applied to functions in another.</p>
  </li>
  <li>
    <p>The <code class="language-plaintext highlighter-rouge">register</code> decorator retursn the same function passed as an argument.  In practive, most decorators define an inner function and return it.  Though not common the technique above is used in many frameworks to add the decorated function to a central registry.</p>
  </li>
</ul>

<p>Code that returns an inner function almost alwasy depends on closures to operate correctly.  To understand closues we need to review how variable sopes work in Python.</p>

<h3 id="variable-scope-rules">Variable Scope Rules</h3>

<p>Note the suprise error in the exmample below.  When Ptyon compiles the body of the function, it decied that <code class="language-plaintext highlighter-rouge">b</code> is a local variable because it is assgined wtihing the function.  The generated bytecode will try to fetch <code class="language-plaintext highlighter-rouge">b</code> from local scope and when exectuing will discover that it is unbound.  This is not a bug but a choice.  Python does not requrie you to declare variables, but assumes that a variable assigne din the body of a function is local.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">6</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">f2</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="p">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="p">...</span>     <span class="n">b</span> <span class="o">=</span> <span class="mi">9</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f2</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="mi">3</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
  <span class="n">File</span> <span class="s">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">3</span><span class="p">,</span> <span class="ow">in</span> <span class="n">f2</span>
<span class="nb">UnboundLocalError</span><span class="p">:</span> <span class="n">local</span> <span class="n">variable</span> <span class="s">'b'</span> <span class="n">referenced</span> <span class="n">before</span> <span class="n">assignment</span>
</code></pre></div></div>

<p>If you want the interpreter to treat b as a global vairable and still assign a new value to it wihtin the functions, we use the <code class="language-plaintext highlighter-rouge">global</code> declaration.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">6</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">f3</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">global</span> <span class="n">b</span>
<span class="p">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="p">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="p">...</span>     <span class="n">b</span> <span class="o">=</span> <span class="mi">9</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f3</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="mi">3</span>
<span class="mi">6</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">b</span>
<span class="mi">9</span>
</code></pre></div></div>

<p>In the example above we see two scopes in action.  The <em>module global scope</em> made of names assigned to values outside of any clas or function block and <em>The f3 function local scope</em> Made of names to values as parameters or directly in the body of the function.</p>

<p>There is another scope which we call the <em>nonlocal</em> scope which we will see later.</p>

<h3 id="closures">Closures</h3>

<p>A closue is a function (lets call it <code class="language-plaintext highlighter-rouge">f</code>) with an extended scope that encompasses variables reference in the body of <code class="language-plaintext highlighter-rouge">f</code> that are not global variables or local variables of <code class="language-plaintext highlighter-rouge">f</code>. Such variables must come from the local scope of an outoer function that encompasses <code class="language-plaintext highlighter-rouge">f</code>.  It does not matter if the function is anonymous or not; what matters is that it can access nonglobal variables that are defined outside of its body.</p>

<p>Consider as an example a function <code class="language-plaintext highlighter-rouge">avg</code> to compute the mean of an ever-growing series of values; for example the average closing price of a commodity over its entire history.  Every day a new price is added, and the average is computed taking into account all prices so far.</p>

<p>here is a sample of <code class="language-plaintext highlighter-rouge">avg</code> in use</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">avg</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="mf">10.0</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">avg</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
<span class="mf">10.5</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">avg</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="mf">11.0</span>
</code></pre></div></div>

<p>One options is a class based implementation.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Averager</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">series</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">series</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">series</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">total</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">series</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">avg</span> <span class="o">=</span> <span class="n">Averager</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">avg</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="mf">10.0</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">avg</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
<span class="mf">10.5</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">avg</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="mf">11.0</span>
</code></pre></div></div>

<p>Here is the same concept implemented with closures.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">make_averager</span><span class="p">():</span>
    <span class="n">series</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">averager</span><span class="p">(</span><span class="n">new_value</span><span class="p">):</span>
        <span class="n">series</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">total</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">averager</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">avg</span> <span class="o">=</span> <span class="n">make_averager</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">avg</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="mf">10.0</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">avg</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
<span class="mf">10.5</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">avg</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="mf">12.0</span>
</code></pre></div></div>

<p>To summarize: a clouse is a function that retains the bindings of the free variables (the variables not bound to local scope) that exist when the function is defined, so that they can be used later when the funtin is invoked and the defining scope is no longer available.</p>

<h3 id="the-nonlocal-declaration">The nonlocal declaration.</h3>

<p>The example above was not efficietn.  We don’t need to store all the values and sum eavery time we can just store count and sum.  Below is the more efficient version but notice the problem when you try to run it.  <code class="language-plaintext highlighter-rouge">count += 1</code> Actually means <code class="language-plaintext highlighter-rouge">count = count + 1</code> so we are asctually assigning to <code class="language-plaintext highlighter-rouge">count</code> in the body of <code class="language-plaintext highlighter-rouge">averager</code> and that makes it a local variable.  Same issue would occur with the <code class="language-plaintext highlighter-rouge">total</code> variable.  We did not have this issue before with <code class="language-plaintext highlighter-rouge">series</code> because we never assigned tot he <code class="language-plaintext highlighter-rouge">series</code> name, we only called <code class="language-plaintext highlighter-rouge">series.append</code> and invoked <code class="language-plaintext highlighter-rouge">sum</code> and <code class="language-plaintext highlighter-rouge">len</code> on it.  With immutable types all you can do is read never update.  If you try to rebind them you are implicitly creating a local variable.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">make_averager</span><span class="p">():</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">averager</span><span class="p">(</span><span class="n">new_value</span><span class="p">):</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">new_value</span>
        <span class="k">return</span> <span class="n">total</span> <span class="o">/</span> <span class="n">count</span>

    <span class="k">return</span> <span class="n">averager</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">avg</span> <span class="o">=</span> <span class="n">make_averager</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">avg</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="p">...</span>
<span class="nb">UnboundLocalError</span><span class="p">:</span> <span class="n">local</span> <span class="n">variable</span> <span class="s">'count'</span> <span class="n">referenced</span> <span class="n">before</span> <span class="n">assignment</span>
<span class="o">&gt;&gt;&gt;</span>
</code></pre></div></div>

<p>To work arund the issue demonstrated above you use the <code class="language-plaintext highlighter-rouge">nonlocal</code> keyword.  Below is the correct implementation of the more efficient function.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">make_averager</span><span class="p">():</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">averager</span><span class="p">(</span><span class="n">new_value</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">count</span><span class="p">,</span> <span class="n">total</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">new_value</span>
        <span class="k">return</span> <span class="n">total</span> <span class="o">/</span> <span class="n">count</span>

    <span class="k">return</span> <span class="n">averager</span>
</code></pre></div></div>

<h3 id="python-variable-lookup-logic">Python Variable Lookup Logic</h3>

<p>When a function is defined, they Python bytecode compiler determines how to fetch a variable <code class="language-plaintext highlighter-rouge">x</code> that appers in it, based on these rules…</p>

<ul>
  <li>
    <p>If there is a <code class="language-plaintext highlighter-rouge">global x</code> declartion, <code class="language-plaintext highlighter-rouge">x</code> comes from and is assigned to the <code class="language-plaintext highlighter-rouge">x</code> global variable module. (Python does not have a program globa scope, only moudule global scopes.)</p>
  </li>
  <li>
    <p>If there is a <code class="language-plaintext highlighter-rouge">nonlocal x</code> declaration, <code class="language-plaintext highlighter-rouge">x</code> comes from and is assigned to the <code class="language-plaintext highlighter-rouge">x</code> local variable of the nearest surrounding function where <code class="language-plaintext highlighter-rouge">x</code> is defined.</p>
  </li>
  <li>
    <p>If <code class="language-plaintext highlighter-rouge">x</code> is a parameter or is assigned a value in the function body, then <code class="language-plaintext highlighter-rouge">x</code> is the local variable.</p>
  </li>
  <li>
    <p>If <code class="language-plaintext highlighter-rouge">x</code> is referenced but is not assigned and is not a parameter:</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">x</code> will be looked up in the local scopes of the surrounding function bodies (non local scopes).</p>
      </li>
      <li>
        <p>If nout found in surrounding scopes, it will be read from the module global scope.</p>
      </li>
      <li>
        <p>If not found int he global scope, it will be read from <code class="language-plaintext highlighter-rouge">__builtins__.__dict__</code></p>
      </li>
    </ul>
  </li>
</ul>

<h3 id="implementing-a-simple-decorator">Implementing a Simple Decorator</h3>

<p>Below is a simple decorator (clockdeco0.py) that clocks every invocation of the decorated function and displays the elapsed time, the arguments passed and the result of the call.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">time</span>


<span class="k">def</span> <span class="nf">clock</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">clocked</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>  
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>  
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">func</span><span class="p">.</span><span class="n">__name__</span>
        <span class="n">arg_str</span> <span class="o">=</span> <span class="s">', '</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'[</span><span class="si">{</span><span class="n">elapsed</span><span class="p">:</span><span class="mf">0.8</span><span class="n">f</span><span class="si">}</span><span class="s">s] </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">(</span><span class="si">{</span><span class="n">arg_str</span><span class="si">}</span><span class="s">) -&gt; </span><span class="si">{</span><span class="n">result</span><span class="err">!</span><span class="n">r</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">clocked</span>  
</code></pre></div></div>

<p>exmaple of use the <code class="language-plaintext highlighter-rouge">clock</code> decorator</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">clockdeco0</span> <span class="kn">import</span> <span class="n">clock</span>

<span class="o">@</span><span class="n">clock</span>
<span class="k">def</span> <span class="nf">snooze</span><span class="p">(</span><span class="n">seconds</span><span class="p">):</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>

<span class="o">@</span><span class="n">clock</span>
<span class="k">def</span> <span class="nf">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">n</span><span class="o">*</span><span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'*'</span> <span class="o">*</span> <span class="mi">40</span><span class="p">,</span> <span class="s">'Calling snooze(.123)'</span><span class="p">)</span>
    <span class="n">snooze</span><span class="p">(.</span><span class="mi">123</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'*'</span> <span class="o">*</span> <span class="mi">40</span><span class="p">,</span> <span class="s">'Calling factorial(6)'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'6! ='</span><span class="p">,</span> <span class="n">factorial</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
</code></pre></div></div>

<p>The above exmple is the typical behaviour of a decorator: It replaces the decorated function with a new function taht accepts the same arguments and (usually) returns whatever the decoarted functionw as supposed to return, while also doing some extra processing.</p>

<p>The example above has a few shortcomings.  It does not support keyword arguments, and it masks the <code class="language-plaintext highlighter-rouge">__name__</code> and <code class="language-plaintext highlighter-rouge">__doc__</code> of the decorated function.  The example below uses the <code class="language-plaintext highlighter-rouge">functools.wraps</code> decorator to copy the relevant attributes from <code class="language-plaintext highlighter-rouge">func</code> to <code class="language-plaintext highlighter-rouge">clocked</code> and handles keyword arguments correctly.</p>

<p><code class="language-plaintext highlighter-rouge">functools.wraps</code> is just one of the ready-to-use decorators in the standard library.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">functools</span>


<span class="k">def</span> <span class="nf">clock</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="o">@</span><span class="n">functools</span><span class="p">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">clocked</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">func</span><span class="p">.</span><span class="n">__name__</span>
        <span class="n">arg_lst</span> <span class="o">=</span> <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
        <span class="n">arg_lst</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s">=</span><span class="si">{</span><span class="n">v</span><span class="err">!</span><span class="n">r</span><span class="si">}</span><span class="s">'</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">arg_str</span> <span class="o">=</span> <span class="s">', '</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">arg_lst</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'[</span><span class="si">{</span><span class="n">elapsed</span><span class="p">:</span><span class="mf">0.8</span><span class="n">f</span><span class="si">}</span><span class="s">s] </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">(</span><span class="si">{</span><span class="n">arg_str</span><span class="si">}</span><span class="s">) -&gt; </span><span class="si">{</span><span class="n">result</span><span class="err">!</span><span class="n">r</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">clocked</span>
</code></pre></div></div>

<h3 id="decorators-in-the-standard-library">Decorators in the Standard Library</h3>

<p>Python has three built-in functions that are designed to decorate methods: <code class="language-plaintext highlighter-rouge">property</code>, <code class="language-plaintext highlighter-rouge">classmethod</code>, <code class="language-plaintext highlighter-rouge">staticmethod</code> we will cover these later but note there are 3 of them.</p>

<h4 id="momoization-with-functoolscache">Momoization with functools.cache</h4>

<p><em>__Note:</em>** <code class="language-plaintext highlighter-rouge">functools.cache</code> was added in Python 3.9 prior to Python 3;.9 replace <code class="language-plaintext highlighter-rouge">@cache</code> with <code class="language-plaintext highlighter-rouge">@lru_cache</code>.</p>

<p>Here is the costly way to implement nth number in Fibonacci series</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">clockdeco</span> <span class="kn">import</span> <span class="n">clock</span>


<span class="o">@</span><span class="n">clock</span>
<span class="k">def</span> <span class="nf">fibonacci</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">n</span>
    <span class="k">return</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">fibonacci</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
</code></pre></div></div>

<p>The waste here is obvoils as <code class="language-plaintext highlighter-rouge">fibonacci(1)</code> is called 8 times <code class="language-plaintext highlighter-rouge">fibonacci(2)</code> five times, etc.  Below is the improved version using <code class="language-plaintext highlighter-rouge">functools.cache</code>.  Notice that we have a stacked decorator (applying multiple decorators to a function).  For this to work all the arguments taken by the decorated function must be hashable becuase the underlying <code class="language-plaintext highlighter-rouge">lru_cache</code> uses a dict to store the results, and the keys are made from the positional and the keyword arguments made int the call.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">functools</span>

<span class="kn">from</span> <span class="nn">clockdeco</span> <span class="kn">import</span> <span class="n">clock</span>


<span class="o">@</span><span class="n">functools</span><span class="p">.</span><span class="n">cache</span>  
<span class="o">@</span><span class="n">clock</span>  
<span class="k">def</span> <span class="nf">fibonacci</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">n</span>
    <span class="k">return</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">fibonacci</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">@cache</code> really shines in applications that need to fetch information from remote APIs.</p>

<p><code class="language-plaintext highlighter-rouge">functools.cache</code> can consuem all available memory so it should be used in short lived command line scripts.  In long running scripts you should use <code class="language-plaintext highlighter-rouge">functools.lru_cache</code></p>

<h4 id="using-lru_cache">Using lru_cache</h4>

<p>The main advantate of @lru_cache is that its memory usage is bounded by the <code class="language-plaintext highlighter-rouge">maxsize</code> parameter which ahs a rather conservative default value of 128 which means cache will hold at most 128 entries at any time.  LRU stands for least recently used meaning that older entries are discarded.</p>

<p><code class="language-plaintext highlighter-rouge">@lru_cache</code> takes 2 parameters <code class="language-plaintext highlighter-rouge">maxsize</code> above and <code class="language-plaintext highlighter-rouge">typed</code> which determines if the results of different arguments types are stored separately.  For example, in the defautl setting, float and integer argumetns that are considered equal are stored only once, so there would be a single entry for the calls <code class="language-plaintext highlighter-rouge">f(1)</code> and <code class="language-plaintext highlighter-rouge">f(1.0)</code>  If type is true those would be separate entries.  Below is an exaple of the decorator with the pareameters and without.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">20</span><span class="p">,</span> <span class="n">typed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">costly_function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="p">...</span>

<span class="o">@</span><span class="n">lru_cache</span>
<span class="k">def</span> <span class="nf">costly_function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="p">...</span>
</code></pre></div></div>

<h4 id="single-dispatch-generic-function">Single Dispatch Generic Function</h4>

<p>You would use <code class="language-plaintext highlighter-rouge">@singledispach</code> in a scenario where you want to simulat overloading.  In the example below we have a base function and variations implemented baded on the type being passed.  Note that this along with typehints will work only with Python 3.7 and later.</p>

<p>The term single dispatch is used becuase the function to be called is determined by the first argument.  If multiple arguments were used it would be called multi dispatch.</p>

<p>Whenever possible registr functions to handle abstract base classes such as numbers.Integral and abc.MutableSequence, instead of concrete implementation like int and list.</p>

<p>Using ABCs <code class="language-plaintext highlighter-rouge">typing.Protocol</code> with <code class="language-plaintext highlighter-rouge">@singledispatch</code> allows you code to support existing or future classes that are actual or virutal subclasses of those ABCs or that implement those protocols.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">singledispatch</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">abc</span>
<span class="kn">import</span> <span class="nn">fractions</span>
<span class="kn">import</span> <span class="nn">decimal</span>
<span class="kn">import</span> <span class="nn">html</span>
<span class="kn">import</span> <span class="nn">numbers</span>

<span class="o">@</span><span class="n">singledispatch</span>  <span class="c1"># @singledispatch marks the base function that handles the object type.
</span><span class="k">def</span> <span class="nf">htmlize</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">html</span><span class="p">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s">'&lt;pre&gt;</span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s">&lt;/pre&gt;'</span>

<span class="o">@</span><span class="n">htmlize</span><span class="p">.</span><span class="n">register</span>  <span class="c1"># each specialized function is decorated wtih @&lt;base&gt;.register
</span><span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>  <span class="c1"># type of the first argument given at runtime determines when this particular function defintion will be used.  The name sepcialized function is irrelevent so we use _ to make that cler.
</span>    <span class="n">content</span> <span class="o">=</span> <span class="n">html</span><span class="p">.</span><span class="n">escape</span><span class="p">(</span><span class="n">text</span><span class="p">).</span><span class="n">replace</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span> <span class="s">'&lt;br/&gt;</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s">'&lt;p&gt;</span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s">&lt;/p&gt;'</span>

<span class="o">@</span><span class="n">htmlize</span><span class="p">.</span><span class="n">register</span>  
<span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">seq</span><span class="p">:</span> <span class="n">abc</span><span class="p">.</span><span class="n">Sequence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">inner</span> <span class="o">=</span> <span class="s">'&lt;/li&gt;</span><span class="se">\n</span><span class="s">&lt;li&gt;'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">htmlize</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">'&lt;ul&gt;</span><span class="se">\n</span><span class="s">&lt;li&gt;'</span> <span class="o">+</span> <span class="n">inner</span> <span class="o">+</span> <span class="s">'&lt;/li&gt;</span><span class="se">\n</span><span class="s">&lt;/ul&gt;'</span>

<span class="o">@</span><span class="n">htmlize</span><span class="p">.</span><span class="n">register</span>  
<span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="n">numbers</span><span class="p">.</span><span class="n">Integral</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s">'&lt;pre&gt;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s"> (0x</span><span class="si">{</span><span class="n">n</span><span class="p">:</span><span class="n">x</span><span class="si">}</span><span class="s">)&lt;/pre&gt;'</span>

<span class="o">@</span><span class="n">htmlize</span><span class="p">.</span><span class="n">register</span>  
<span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s">'&lt;pre&gt;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s">&lt;/pre&gt;'</span>

<span class="o">@</span><span class="n">htmlize</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="n">fractions</span><span class="p">.</span><span class="n">Fraction</span><span class="p">)</span>  
<span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">frac</span> <span class="o">=</span> <span class="n">fractions</span><span class="p">.</span><span class="n">Fraction</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s">'&lt;pre&gt;</span><span class="si">{</span><span class="n">frac</span><span class="p">.</span><span class="n">numerator</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">frac</span><span class="p">.</span><span class="n">denominator</span><span class="si">}</span><span class="s">&lt;/pre&gt;'</span>

<span class="o">@</span><span class="n">htmlize</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="n">decimal</span><span class="p">.</span><span class="n">Decimal</span><span class="p">)</span>  
<span class="o">@</span><span class="n">htmlize</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">frac</span> <span class="o">=</span> <span class="n">fractions</span><span class="p">.</span><span class="n">Fraction</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="n">limit_denominator</span><span class="p">()</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s">'&lt;pre&gt;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">frac</span><span class="p">.</span><span class="n">numerator</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">frac</span><span class="p">.</span><span class="n">denominator</span><span class="si">}</span><span class="s">)&lt;/pre&gt;'</span>
</code></pre></div></div>

<h4 id="parameterized-decorators">Parameterized Decorators</h4>

<p>When parsing a decorator in source code, Python takes the decorated function and passed it as the first argument to the decorator function.  So how do you make a decorator accpet other arguments?  You make a decorator factory that takes those arguments and returns a decorator, which is then applied to the function to be decorated.</p>

<p>The main point of example below is that <code class="language-plaintext highlighter-rouge">register()</code> returns <code class="language-plaintext highlighter-rouge">decorate</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">registry</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  

<span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>  
    <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>  <span class="c1"># the decorate function is the actual decorator.  Note how it takes function as argument.
</span>        <span class="k">print</span><span class="p">(</span><span class="s">'running register'</span>
              <span class="sa">f</span><span class="s">'(active=</span><span class="si">{</span><span class="n">active</span><span class="si">}</span><span class="s">)-&gt;decorate(</span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s">)'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">active</span><span class="p">:</span> <span class="c1"># active variable is retrieved from the closure
</span>            <span class="n">registry</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">registry</span><span class="p">.</span><span class="n">discard</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>  <span class="c1"># if not active and func in registry remove it.
</span>
        <span class="k">return</span> <span class="n">func</span>  
    <span class="k">return</span> <span class="n">decorate</span> <span class="c1"># register is our decorator factory, so it returns decorate
</span>
<span class="o">@</span><span class="n">register</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>  
<span class="k">def</span> <span class="nf">f1</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'running f1()'</span><span class="p">)</span>

<span class="o">@</span><span class="n">register</span><span class="p">()</span>  
<span class="k">def</span> <span class="nf">f2</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'running f2()'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">f3</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'running f3()'</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="the-parameterized-clock-decorator">The Parameterized Clock Decorator</h4>

<p>Below is an example of the clock decorator we had exmple of before, but users can pass a format string.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">time</span>

<span class="n">DEFAULT_FMT</span> <span class="o">=</span> <span class="s">'[{elapsed:0.8f}s] {name}({args}) -&gt; {result}'</span>

<span class="k">def</span> <span class="nf">clock</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="n">DEFAULT_FMT</span><span class="p">):</span>  
    <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>      
        <span class="k">def</span> <span class="nf">clocked</span><span class="p">(</span><span class="o">*</span><span class="n">_args</span><span class="p">):</span> 
            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
            <span class="n">_result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">_args</span><span class="p">)</span>  
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">func</span><span class="p">.</span><span class="n">__name__</span>
            <span class="n">args</span> <span class="o">=</span> <span class="s">', '</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">_args</span><span class="p">)</span>  
            <span class="n">result</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">_result</span><span class="p">)</span>  
            <span class="k">print</span><span class="p">(</span><span class="n">fmt</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">()))</span>  
            <span class="k">return</span> <span class="n">_result</span>  
        <span class="k">return</span> <span class="n">clocked</span>  
    <span class="k">return</span> <span class="n">decorate</span>  

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>

    <span class="o">@</span><span class="n">clock</span><span class="p">()</span>  
    <span class="k">def</span> <span class="nf">snooze</span><span class="p">(</span><span class="n">seconds</span><span class="p">):</span>
        <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>
</code></pre></div></div>

<p>Below is yet another example of the clock decorator but now implemented as a class</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">time</span>

<span class="n">DEFAULT_FMT</span> <span class="o">=</span> <span class="s">'[{elapsed:0.8f}s] {name}({args}) -&gt; {result}'</span>

<span class="k">class</span> <span class="nc">clock</span><span class="p">:</span>  

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">DEFAULT_FMT</span><span class="p">):</span>  
        <span class="bp">self</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>  
        <span class="k">def</span> <span class="nf">clocked</span><span class="p">(</span><span class="o">*</span><span class="n">_args</span><span class="p">):</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
            <span class="n">_result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">_args</span><span class="p">)</span>  
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">func</span><span class="p">.</span><span class="n">__name__</span>
            <span class="n">args</span> <span class="o">=</span> <span class="s">', '</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">_args</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">_result</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">()))</span>
            <span class="k">return</span> <span class="n">_result</span>
        <span class="k">return</span> <span class="n">clocked</span>
</code></pre></div></div>

<h2 id="a-pythonic-object">A Pythonic Object</h2>

<p>The <code class="language-plaintext highlighter-rouge">@classmethod</code> decorator denotes a method that operates on a class rather than an instance.  <code class="language-plaintext highlighter-rouge">@classmehtod</code> changes the way the method is called, so it recieves the class itself as the first agument, instead of an instance.  Its most common use is for alternative constructors such as frombytes in the exmple below.</p>

<p>In contrast <code class="language-plaintext highlighter-rouge">@staticmethod</code> decorator changes a method so that it receives no special first argument.  In essense, a static method is just like a plain function that happens to live in a class body.  There are not many good use cases for <code class="language-plaintext highlighter-rouge">@staticmethod</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">Demo</span><span class="p">:</span>
<span class="p">...</span>     <span class="o">@</span><span class="nb">classmethod</span>
<span class="p">...</span>     <span class="k">def</span> <span class="nf">klassmeth</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="p">...</span>         <span class="k">return</span> <span class="n">args</span>  
<span class="p">...</span>     <span class="o">@</span><span class="nb">staticmethod</span>
<span class="p">...</span>     <span class="k">def</span> <span class="nf">statmeth</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="p">...</span>         <span class="k">return</span> <span class="n">args</span>  
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Demo</span><span class="p">.</span><span class="n">klassmeth</span><span class="p">()</span>  
<span class="p">(</span><span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">__main__</span><span class="p">.</span><span class="n">Demo</span><span class="s">'&gt;,)
&gt;&gt;&gt; Demo.klassmeth('</span><span class="n">spam</span><span class="s">')
(&lt;class '</span><span class="n">__main__</span><span class="p">.</span><span class="n">Demo</span><span class="s">'&gt;, '</span><span class="n">spam</span><span class="s">')
&gt;&gt;&gt; Demo.statmeth()   
()
&gt;&gt;&gt; Demo.statmeth('</span><span class="n">spam</span><span class="s">')
('</span><span class="n">spam</span><span class="s">',)
</span></code></pre></div></div>

<h3 id="string-formatting-aside">String formatting aside</h3>

<p>Look into the below links for learing how to work with string formatting…</p>

<p>https://fpy.li/fmtspec</p>

<p>https://fpy.li/11-4</p>

<p>https://fpy.li/11-5</p>

<h3 id="private-and-protected-attributes-in-python">Private and “Protected” Attributes in Python</h3>

<p>While python does not have private variable concept like java you can name your class variable as <code class="language-plaintext highlighter-rouge">__mood</code> (preceed with two underscores) which will have Python store the variable in the instance <code class="language-plaintext highlighter-rouge">__dict__</code> as <code class="language-plaintext highlighter-rouge">_Dog__mood</code> assuming your class is named dog.  Name mangling is more for safety than security.  People can still see and modify the mangled variables but they know they are doing so at that point.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">Vector2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">v1</span><span class="p">.</span><span class="n">__dict__</span>
<span class="p">{</span><span class="s">'_Vector2d__y'</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span> <span class="s">'_Vector2d__x'</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">v1</span><span class="p">.</span><span class="n">_Vector2d__x</span>
<span class="mf">3.0</span>
</code></pre></div></div>
<p>A log of people don’t bother with name mangling and just use the <code class="language-plaintext highlighter-rouge">_</code> to denote that a variable is private.</p>

<h3 id="saving-memory-with-slots">Saving Memory with <strong>slots</strong></h3>

<p>If you define a class attribute names <code class="language-plaintext highlighter-rouge">__slots__</code> holding a sequence of attribute names, Python uses an alternative storage modle for the instance at-tributes: the attributes named in <code class="language-plaintext highlighter-rouge">__slots__</code> are stored in a hidden array or references that use less memory than a <code class="language-plaintext highlighter-rouge">dict</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">Pixel</span><span class="p">:</span>
<span class="p">...</span>     <span class="n">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s">'x'</span><span class="p">,</span> <span class="s">'y'</span><span class="p">)</span>  <span class="c1"># __slots__ attribute names can be in a tuple or list. Tuple is preferred to denote it can't be modified.
</span><span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">Pixel</span><span class="p">()</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">__dict__</span>  
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="p">...</span>
<span class="nb">AttributeError</span><span class="p">:</span> <span class="s">'Pixel'</span> <span class="nb">object</span> <span class="n">has</span> <span class="n">no</span> <span class="n">attribute</span> <span class="s">'__dict__'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">10</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">20</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="s">'red'</span>  
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="p">...</span>
<span class="nb">AttributeError</span><span class="p">:</span> <span class="s">'Pixel'</span> <span class="nb">object</span> <span class="n">has</span> <span class="n">no</span> <span class="n">attribute</span> <span class="s">'color'</span>
</code></pre></div></div>

<p>If you subclass the pixel dict above you will have a <code class="language-plaintext highlighter-rouge">__dict__</code>.  <code class="language-plaintext highlighter-rouge">__slots__</code> is not carried over and would need to be re declared in the subclass.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">OpenPixel</span><span class="p">(</span><span class="n">Pixel</span><span class="p">):</span>  
<span class="p">...</span>     <span class="k">pass</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">op</span> <span class="o">=</span> <span class="n">OpenPixel</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">op</span><span class="p">.</span><span class="n">__dict__</span>  
<span class="p">{}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">op</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">8</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">op</span><span class="p">.</span><span class="n">__dict__</span>  
<span class="p">{}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">op</span><span class="p">.</span><span class="n">x</span>  
<span class="mi">8</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">op</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="s">'green'</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">op</span><span class="p">.</span><span class="n">__dict__</span>  
<span class="p">{</span><span class="s">'color'</span><span class="p">:</span> <span class="s">'green'</span><span class="p">}</span>
</code></pre></div></div>

<p>Below is the example script from the book repo of how memory usage was measured for comparing the slots and non slots version of the class.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">resource</span>

<span class="n">NUM_VECTORS</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">7</span>

<span class="n">module</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">module_name</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">replace</span><span class="p">(</span><span class="s">'.py'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
    <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="p">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Usage: </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> &lt;vector-module-to-test&gt;'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Running test with built-in `complex`'</span><span class="p">)</span>
    <span class="n">cls</span> <span class="o">=</span> <span class="nb">complex</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="s">'Selected Vector2d type: {.__name__}.{.__name__}'</span>
    <span class="k">print</span><span class="p">(</span><span class="n">fmt</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">module</span><span class="p">.</span><span class="n">Vector2d</span><span class="p">))</span>
    <span class="n">cls</span> <span class="o">=</span> <span class="n">module</span><span class="p">.</span><span class="n">Vector2d</span>

<span class="n">mem_init</span> <span class="o">=</span> <span class="n">resource</span><span class="p">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">RUSAGE_SELF</span><span class="p">).</span><span class="n">ru_maxrss</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Creating </span><span class="si">{</span><span class="n">NUM_VECTORS</span><span class="p">:,</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">cls</span><span class="p">.</span><span class="n">__qualname__</span><span class="err">!</span><span class="n">r</span><span class="si">}</span><span class="s"> instances'</span><span class="p">)</span>

<span class="n">vectors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cls</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_VECTORS</span><span class="p">)]</span>

<span class="n">mem_final</span> <span class="o">=</span> <span class="n">resource</span><span class="p">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">RUSAGE_SELF</span><span class="p">).</span><span class="n">ru_maxrss</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Initial RAM usage: </span><span class="si">{</span><span class="n">mem_init</span><span class="p">:</span><span class="mi">14</span><span class="p">,</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'  Final RAM usage: </span><span class="si">{</span><span class="n">mem_final</span><span class="p">:</span><span class="mi">14</span><span class="p">,</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
</code></pre></div></div>

<p>Based on the book example of creating 10 million instances of the slots and non slots classes you save about 1Gig of memory however if you are dealing with millions of numerical data you should consider <code class="language-plaintext highlighter-rouge">NumPy</code> which are memory efficient and have highly optimized functions for numeric processing.</p>

<p>Issues with using <code class="language-plaintext highlighter-rouge">__slots__</code> are …</p>

<ul>
  <li>
    <p>You must remember to redeclare <code class="language-plaintext highlighter-rouge">__slots__</code> in each subclass</p>
  </li>
  <li>
    <p>Instances will only be able to have the attributes listed in <code class="language-plaintext highlighter-rouge">__slots__</code> unless you add a <code class="language-plaintext highlighter-rouge">__dict__</code> which negates the benefit of using slots.</p>
  </li>
  <li>
    <p>Classes using <code class="language-plaintext highlighter-rouge">__slots__</code> cannot use the <code class="language-plaintext highlighter-rouge">@cached_property</code> decorator.</p>
  </li>
  <li>
    <p>Instances cannot be targets of weak references unless you add <code class="language-plaintext highlighter-rouge">__weakref__</code> in <code class="language-plaintext highlighter-rouge">__slots__</code>.</p>
  </li>
</ul>

<h3 id="overriding-class-attributes">Overriding Class Attributes</h3>

<p>The TLDR of this section is if you have a class attribute that you want to customize you can just set it as in <code class="language-plaintext highlighter-rouge">myclass.myattribute = 1</code> but a better way to do this is to create a subclass where you make the change and use the subclass such as in the crappy example from the book below.  Note in this case you are setting the attribute on the class itself not on the instance of the class and all instances of the class that have not set a different value from default will be updated.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">vector2d_v3</span> <span class="kn">import</span> <span class="n">Vector2d</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">ShortVector2d</span><span class="p">(</span><span class="n">Vector2d</span><span class="p">):</span>  
<span class="p">...</span>     <span class="n">typecode</span> <span class="o">=</span> <span class="s">'f'</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sv</span> <span class="o">=</span> <span class="n">ShortVector2d</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">27</span><span class="p">)</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">sv</span>
<span class="n">ShortVector2d</span><span class="p">(</span><span class="mf">0.09090909090909091</span><span class="p">,</span> <span class="mf">0.037037037037037035</span><span class="p">)</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">sv</span><span class="p">))</span>  
<span class="mi">9</span>
</code></pre></div></div>

<h2 id="special-method-for-sequences">Special Method for Sequences</h2>

<p>The sequence protocol requires you to implement the <code class="language-plaintext highlighter-rouge">__len__</code> and <code class="language-plaintext highlighter-rouge">__getitem__</code> methods.  Any class that implements those methods with the standard signature and semantics can be used anywhere a sequence is expected.  What Spam is a subclass of is irrelevant.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">collections</span>

<span class="n">Card</span> <span class="o">=</span> <span class="n">collections</span><span class="p">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">'Card'</span><span class="p">,</span> <span class="p">[</span><span class="s">'rank'</span><span class="p">,</span> <span class="s">'suit'</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">FrenchDeck</span><span class="p">:</span>
    <span class="n">ranks</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">)]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="s">'JQKA'</span><span class="p">)</span>
    <span class="n">suits</span> <span class="o">=</span> <span class="s">'spades diamonds clubs hearts'</span><span class="p">.</span><span class="n">split</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_cards</span> <span class="o">=</span> <span class="p">[</span><span class="n">Card</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">suit</span><span class="p">)</span> <span class="k">for</span> <span class="n">suit</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">suits</span>
                                        <span class="k">for</span> <span class="n">rank</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">ranks</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_cards</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_cards</span><span class="p">[</span><span class="n">position</span><span class="p">]</span>
</code></pre></div></div>

<p>There is mention of a <code class="language-plaintext highlighter-rouge">@property</code> which defines a method as a getter.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyClass</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_x</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_x</span>

    <span class="o">@</span><span class="n">x</span><span class="p">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">value</span>

    <span class="o">@</span><span class="n">x</span><span class="p">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="p">.</span><span class="n">_x</span>
</code></pre></div></div>

<h2 id="interfaces-protocols-and-abcs">Interfaces, Protocols, and ABCs</h2>

<p>As of Python 3.8 There are  4 ways of defining and usig interfaces.</p>

<ul>
  <li>Duck Typing - The Python default approach</li>
  <li>Goose Typing - Approach supported by abstract base classes (ABCs) which relies on runtime checks of objects against ABCs.</li>
  <li>Static Typing - Traditional approach of statically-typed languages like C and Java; supported since Python 3.5 by the <code class="language-plaintext highlighter-rouge">typing</code> module and enforced by external type checkers.  Not covered much in this chapter but wil go back to it in Chapter 15.</li>
  <li>Static Duck Typing - Popular in Go language.  New in Python 3.8 also enforced by external type checkers.</li>
</ul>

<p>This chapter focuses on duck typing, goose typoing and static duck typoing which all revolve around interfaces.</p>

<h3 id="two-kinds-of-protocols">Two Kinds of Protocols</h3>

<p>An object protocol specified methods which an object must provide to fulfill a role.  It may be OK to only imlement some of the methods required by a protocol.  For example you can implemtnt he <code class="language-plaintext highlighter-rouge">__getitem__</code> method but not <code class="language-plaintext highlighter-rouge">__len__</code> and still get most of the behavior of a seqence.  For this reason protocols are an informal reference.</p>

<p>The second type of Protocol added to Python are Static Protocls which allow us to create subclasses of <code class="language-plaintext highlighter-rouge">typing.Protocol</code> to define methods that a class must implement (or inherit) to statisfy a static type checker.  Static protocols can be verified by static type checkers but dynamic protocols can’t.  To fulfill a static protocol all methods must be implemented.</p>

<p>Most ABCs in the <code class="language-plaintext highlighter-rouge">collections.abc</code> module exist to formalize interfaces that are implemented by build-in objects and are implicitly suported by the interpreter both of which predate ABCs themselves.  The ABCs are usefull as starting points for new classes, and to support explicit type checkign at runtime (aka goose typing) as well as type hints for static type checkers.</p>

<p>Python has a build in method for shuffling a sequence as in the exmple below.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">shuffle</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">shuffle</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">l</span>
<span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
</code></pre></div></div>

<p>Good idea to read though the Python Language Reference found here https://docs.python.org/3/reference/index.html</p>

<h3 id="defensive-programming-and-fail-fast">Defensive Programming and Fail Fast</h3>

<p>If you are trying to prevent being passes an infinite generator use the <code class="language-plaintext highlighter-rouge">len()</code> call on what you are being passed which will reject iterators but work on tuples and arrays. Conversely if any iterator is accptable you can call <code class="language-plaintext highlighter-rouge">item(x)</code> as soon as possible to obtain an iterator.  If x is not an iterator this call will fail with a clear message.</p>

<h3 id="goose-typing">goose Typing</h3>

<p>Python does not have an interface keyword we ue ABCs to define interfaces.</p>

<p>You can sublcass from ABCs to make it clear that you are implementing that interface.  You shoudl also use the type imported from abc module when doing isinstance checks.</p>

<p>If you are not subclassing you can register as in the exmple below to make it clear that you are implementing a class based on the ABC.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Sequence</span>
<span class="n">Sequence</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="n">FrenchDeck</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span><span class="p">,</span> <span class="n">abc</span>

<span class="n">Card</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s">'Card'</span><span class="p">,</span> <span class="p">[</span><span class="s">'rank'</span><span class="p">,</span> <span class="s">'suit'</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">FrenchDeck2</span><span class="p">(</span><span class="n">abc</span><span class="p">.</span><span class="n">MutableSequence</span><span class="p">):</span>
    <span class="n">ranks</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">)]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="s">'JQKA'</span><span class="p">)</span>
    <span class="n">suits</span> <span class="o">=</span> <span class="s">'spades diamonds clubs hearts'</span><span class="p">.</span><span class="n">split</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_cards</span> <span class="o">=</span> <span class="p">[</span><span class="n">Card</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">suit</span><span class="p">)</span> <span class="k">for</span> <span class="n">suit</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">suits</span>
                                        <span class="k">for</span> <span class="n">rank</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">ranks</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_cards</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_cards</span><span class="p">[</span><span class="n">position</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>  
        <span class="bp">self</span><span class="p">.</span><span class="n">_cards</span><span class="p">[</span><span class="n">position</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span> <span class="c1"># subclassing MutableSequence forces us to implement __delitem__  
</span>        <span class="k">del</span> <span class="bp">self</span><span class="p">.</span><span class="n">_cards</span><span class="p">[</span><span class="n">position</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="c1"># we are also required to implement insert.
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_cards</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</code></pre></div></div>

<p>Python does not check for the implementation of the abstract methods at import time, but only at runtime when we actually try to instantiate the class.</p>

<h3 id="the-abc-classes-you-shoud-know-about">The ABC Classes you shoud know about</h3>

<p><code class="language-plaintext highlighter-rouge">Iterable</code>, <code class="language-plaintext highlighter-rouge">Container</code> and <code class="language-plaintext highlighter-rouge">Sized</code>: Every collection should either inheric from these ABCs or implement compatible protocols.</p>

<p><code class="language-plaintext highlighter-rouge">Sequence</code>, <code class="language-plaintext highlighter-rouge">Mapping</code>, <code class="language-plaintext highlighter-rouge">Set</code>: These are the main immutable collection types, and each has a mutable subclass (<code class="language-plaintext highlighter-rouge">MutableSequence</code>, <code class="language-plaintext highlighter-rouge">MutableMapping</code>, <code class="language-plaintext highlighter-rouge">MutableSet</code>).</p>

<p><code class="language-plaintext highlighter-rouge">MappingView</code>: In Python3, the objects returned from the mapping methods <code class="language-plaintext highlighter-rouge">.items()</code>, <code class="language-plaintext highlighter-rouge">.keys()</code>, <code class="language-plaintext highlighter-rouge">.values()</code> implement the interfaces defined in <code class="language-plaintext highlighter-rouge">ItemsView</code>, <code class="language-plaintext highlighter-rouge">KeysView</code>, <code class="language-plaintext highlighter-rouge">ValuesView</code>.</p>

<p><code class="language-plaintext highlighter-rouge">Iterator</code>: Note that iterator subclasses <code class="language-plaintext highlighter-rouge">Iterable</code> (which we will discuss in later chapters)</p>

<p><code class="language-plaintext highlighter-rouge">Callable</code>, <code class="language-plaintext highlighter-rouge">Hashable</code>: These are not collectiosn, but <code class="language-plaintext highlighter-rouge">collections.abc</code> was the first package to define ABCs in the standard library, and these two were deemed imporatnt engouh to be included.  They support type checking objects that must be callable or hashable. Note for callable detection the <code class="language-plaintext highlighter-rouge">collable(obj)</code> build in is more convinient thatn <code class="language-plaintext highlighter-rouge">instance(obj, Callable)</code>.  If <code class="language-plaintext highlighter-rouge">isinstance(obj, Hashable)</code> returns <code class="language-plaintext highlighter-rouge">False</code>, you can be certain that <code class="language-plaintext highlighter-rouge">obj</code> is not hashable but if it returns <code class="language-plaintext highlighter-rouge">True</code> it may be a false positive.  If object is a tuple containining unhashable values the you will get a <code class="language-plaintext highlighter-rouge">True</code> which is misleading.</p>

<h3 id="writing-your-own-abc">Writing your own ABC</h3>

<p>Note that you normally don’t need to do this.  There are some good notes in the exmple code though so below is the example…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">abc</span>

<span class="k">class</span> <span class="nc">Tombola</span><span class="p">(</span><span class="n">abc</span><span class="p">.</span><span class="n">ABC</span><span class="p">):</span>  <span class="c1"># To define an ABC, subclass abc.ABC
</span>
    <span class="o">@</span><span class="n">abc</span><span class="p">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>  
        <span class="s">"""Add items from an iterable."""</span>

    <span class="o">@</span><span class="n">abc</span><span class="p">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">pick</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
        <span class="s">"""Remove item at random, returning it.

        This method should raise `LookupError` when the instance is empty.
        """</span>

    <span class="k">def</span> <span class="nf">loaded</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1"># An ABC may include concrete methods.
</span>        <span class="s">"""Return `True` if there's at least 1 item, `False` otherwise."""</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">inspect</span><span class="p">())</span>  

    <span class="k">def</span> <span class="nf">inspect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Return a sorted tuple with the items currently inside."""</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>  
            <span class="k">try</span><span class="p">:</span>
                <span class="n">items</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">pick</span><span class="p">())</span>
            <span class="k">except</span> <span class="nb">LookupError</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>  
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
</code></pre></div></div>

<p>Note the use of the <code class="language-plaintext highlighter-rouge">@abstractmethod</code> decorator.  Typically the body of an abstract method is emtpy except for a docstring since the class inheriting will have to implement the method.  There are instances where you want to have code in the abstrct method.  The inheriting class will still need to implement the method, but they will be able to invoke the abstract method by calling <code class="language-plaintext highlighter-rouge">super()</code>.</p>

<p><strong><em>Note:</em></strong> The bood mentions but does not pride details of a Python hierarchy of exceptions.  I should look that up for reference.</p>

<p>Since Python 3.3 When stacking decorators was added the way to declre an abstract classmethod is as follows…  Reminder a class method is one that is bound to class itself and not an instance of the class.  It can be called on the class itself.</p>

<p>Note that the order of stacked decorators is important.  Check the documentation when in doubt.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyABC</span><span class="p">(</span><span class="n">abc</span><span class="p">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="o">@</span><span class="nb">classmethod</span>
    <span class="o">@</span><span class="n">abc</span><span class="p">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">an_abstract_classmethod</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="p">...):</span>
        <span class="k">pass</span>
</code></pre></div></div>

<h2 id="chapter-14-inheritance-for-better-or-worse">Chapter 14 Inheritance for better or Worse</h2>

<h3 id="the-super-function">The super() Function</h3>

<p>When a subclass overrides a method of a superclass, the overriding method usually needs to call the corresponing method of the superclass.  Here is the recommended way to do that…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">LastUpdatedOrderedDict</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">):</span>
    <span class="s">"""Store items in the order they were last updated"""</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">move_to_end</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="subclassing-built-in-types-is-tricky">Subclassing Built-In Types Is Tricky</h3>

<p>While it is possible to subclass built in types such as <code class="language-plaintext highlighter-rouge">list</code> or <code class="language-plaintext highlighter-rouge">dict</code> Those types are usually written in C and usually do not call methods overridden by user-defined classes.  Don’t bother with subclassing these types.  If you need to use the <code class="language-plaintext highlighter-rouge">collections</code> modules <code class="language-plaintext highlighter-rouge">UserDict</code>, <code class="language-plaintext highlighter-rouge">UserList</code> and <code class="language-plaintext highlighter-rouge">UserString</code> which are designed to be easily extended.</p>

<p>Below is an example of subclassing <code class="language-plaintext highlighter-rouge">collections.UserDict</code>…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">collections</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">DoppelDict2</span><span class="p">(</span><span class="n">collections</span><span class="p">.</span><span class="n">UserDict</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="p">...</span>         <span class="nb">super</span><span class="p">().</span><span class="n">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dd</span> <span class="o">=</span> <span class="n">DoppelDict2</span><span class="p">(</span><span class="n">one</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dd</span>
<span class="p">{</span><span class="s">'one'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dd</span><span class="p">[</span><span class="s">'two'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dd</span>
<span class="p">{</span><span class="s">'two'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s">'one'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dd</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">three</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dd</span>
<span class="p">{</span><span class="s">'two'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s">'three'</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s">'one'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]}</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">AnswerDict2</span><span class="p">(</span><span class="n">collections</span><span class="p">.</span><span class="n">UserDict</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="p">...</span>         <span class="k">return</span> <span class="mi">42</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ad</span> <span class="o">=</span> <span class="n">AnswerDict2</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="s">'foo'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ad</span><span class="p">[</span><span class="s">'a'</span><span class="p">]</span>
<span class="mi">42</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">d</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">ad</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">d</span><span class="p">[</span><span class="s">'a'</span><span class="p">]</span>
<span class="mi">42</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">d</span>
<span class="p">{</span><span class="s">'a'</span><span class="p">:</span> <span class="mi">42</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="multiple-inheritence-and-method-resolution-order">Multiple Inheritence and Method Resolution Order</h3>

<p>Every class has an attribute called <code class="language-plaintext highlighter-rouge">__mro__</code> holding a tuple of references to the superclasses in method resolution order from the current class all the way to the <code class="language-plaintext highlighter-rouge">object</code> class.  The search order is left ot right of the order in which you set up your inheritence when declaring the class.</p>

<h3 id="mixin-classes">Mixin Classes</h3>

<p>A mixin class is designed to be subclassed together with at least one otehr class in a multiple inheritence arrangement.  A mixin is not supposed to be the only base class of a concrete class, because it does not provide all the functionality for a concrete object, but only adds or customized the behaviour of child or sibling classes.</p>

<p>In Python Mixin is a convention without any specific syntax support.</p>

<p>Below is a code exmaple of a mixin</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">collections</span>

<span class="k">def</span> <span class="nf">_upper</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>  
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">key</span><span class="p">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">key</span>

<span class="k">class</span> <span class="nc">UpperCaseMixin</span><span class="p">:</span>  
    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__setitem__</span><span class="p">(</span><span class="n">_upper</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">().</span><span class="n">__getitem__</span><span class="p">(</span><span class="n">_upper</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="n">_upper</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">default</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">().</span><span class="n">__contains__</span><span class="p">(</span><span class="n">_upper</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

<span class="c1"># Below would be in a different module naturlly
</span>
<span class="k">class</span> <span class="nc">UpperDict</span><span class="p">(</span><span class="n">UpperCaseMixin</span><span class="p">,</span> <span class="n">collections</span><span class="p">.</span><span class="n">UserDict</span><span class="p">):</span>  
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">UpperCounter</span><span class="p">(</span><span class="n">UpperCaseMixin</span><span class="p">,</span> <span class="n">collections</span><span class="p">.</span><span class="n">Counter</span><span class="p">):</span>  
    <span class="s">"""Specialized 'Counter' that uppercases string keys"""</span>


    <span class="o">&gt;&gt;&gt;</span> <span class="n">d</span> <span class="o">=</span> <span class="n">UpperDict</span><span class="p">([(</span><span class="s">'a'</span><span class="p">,</span> <span class="s">'letter A'</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">'digit two'</span><span class="p">)])</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="p">[</span><span class="s">'A'</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="n">d</span><span class="p">[</span><span class="s">'b'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'letter B'</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="s">'b'</span> <span class="ow">in</span> <span class="n">d</span>
    <span class="bp">True</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="n">d</span><span class="p">[</span><span class="s">'a'</span><span class="p">],</span> <span class="n">d</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'B'</span><span class="p">)</span>
    <span class="p">(</span><span class="s">'letter A'</span><span class="p">,</span> <span class="s">'letter B'</span><span class="p">)</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="p">[</span><span class="s">'A'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">'B'</span><span class="p">]</span>


    <span class="o">&gt;&gt;&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">UpperCounter</span><span class="p">(</span><span class="s">'BaNanA'</span><span class="p">)</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">most_common</span><span class="p">()</span>
    <span class="p">[(</span><span class="s">'A'</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="s">'N'</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="s">'B'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
</code></pre></div></div>

<h3 id="tips-on-working-with-inheritence">Tips on working with inheritence</h3>

<h4 id="favor-object-composition-over-class-inheritence">Favor Object Composition over Class Inheritence</h4>

<p>Instead of inheriting from a class you can store an instance of that class in your class and call methods from it.  This is called composition.  It leads to more flexible designs.  It cannot replace the use of interface inheritance to define a hierarchy of types.</p>

<h4 id="understand-why-inheritance-is-used-in-each-case">Understand Why Inheritance Is used in Each Case</h4>

<p>The 2 main reasons for using inheritence is 1. Inheritancd of interfaces createsa s subtype, implyin an “is-a” relationship.  This is best doen with ABCs. and 2. Inheritance of implementation avoids code deplication by reuse.  Mixins can help with this.</p>

<p>In practice Inheritance for code reuse is an implementation detail and can often be replaced by composition and delegation.  On the other hand interface inheritance is usually done in framework development.</p>

<h4 id="make-interfaces-expilcit-with-abcs">Make Interfaces Expilcit with ABCs.</h4>

<p>In modern Python, if a class is intended to define an interface, it should be an explicit ABC or a <code class="language-plaintext highlighter-rouge">typing.Protocol</code> subclass.  An ABC should subclass only abc.ABC or other ABCs.  Multiple inheritence of ABCs is not problomatic.</p>

<h4 id="use-explicit-mixins-for-code-reuse">Use Explicit Mixins for Code Reuse</h4>

<p>If a class is designed to provide method implementations for reuse by multiple unrelated subclasses, without implying an “is-a” relationship, it should be an explicit mixin class. Conceptually, a mixin does not define a new type; it merely bundles methods for reuse. A mixin should never be instantiated, and concrete classes should not inherit only from a mixin. Each mixin should provide a single specific behavior, implementing few and very closely related methods. Mixins should avoid keeping any internal state; i.e., a mixin class should not have instance attributes.</p>

<p>There is no formal way in Python to state that a class is a mixin, so it is highly recommended that they are named with a Mixin suffix.</p>

<h4 id="provide-aggregate-classes-to-users">Provide Aggregate Classes to Users</h4>

<p>A class that is constructed primarily by inheritting from mixins and does not add its own structure or behavioru is called an aggregate class.  If some combination of ABCs or mixins is particularly useful to client code, provide a class that brings them together in a sensible way.</p>

<p>Below examle the body of <code class="language-plaintext highlighter-rouge">ListView</code> is empty, but the class provides a useful service: it brings together a mixin and a base class that sould be sued together.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ListView</span><span class="p">(</span><span class="n">MultipleObjectTemplateResponseMixin</span><span class="p">,</span> <span class="n">BaseListView</span><span class="p">):</span>
    <span class="s">"""
    Render some list of objects, set by `self.model` or `self.queryset`.
    `self.queryset` can actually be any iterable of items, not just a queryset.
    """</span>
</code></pre></div></div>

<h4 id="subclasse-only-classes-designed-for-subclassing">Subclasse Only Classes Designed for Subclassing</h4>

<p>Subclassing any complex class and overriding its methods is error-prone because the superclass methods may ignore the subclass overrides in unexpected ways. As much as possible, avoid overriding methods, or at least restrain yourself to subclassing classes which are designed to be easily extended, and only in the ways in which they were designed to be extended.  Check the docs to figure out if class should be subclassed.</p>

<h2 id="chapter-15-more-about-type-hints">Chapter 15: More About Type Hints</h2>

<h3 id="overloaded-signatures">Overloaded Signatures</h3>

<p>If you need a placeholder for a function body you can use the <code class="language-plaintext highlighter-rouge">...</code> syntax.  Example below.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">overload</span>
<span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="n">__iterable</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">_T</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span> <span class="p">...</span>
<span class="o">@</span><span class="n">overload</span>
<span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="n">__iterable</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span> <span class="n">start</span><span class="p">:</span> <span class="n">_S</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">_T</span><span class="p">,</span> <span class="n">_S</span><span class="p">]:</span> <span class="p">...</span>
</code></pre></div></div>

<p>Recall in the example above the the double underscores in front of iterable denote a positional only argument which will be enforced by MyPy In example above you can call <code class="language-plaintext highlighter-rouge">sum(my_list)</code> but not <code class="language-plaintext highlighter-rouge">sum(__iterable = my_list)</code>.</p>

<p>You can also use <code class="language-plaintext highlighter-rouge">@overload</code> in a regular Python modules, by writing the overloaded signatures right before the function’s actual signature and implemntation.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">overload</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">TypeVar</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s">'T'</span><span class="p">)</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s">'S'</span><span class="p">)</span>  <span class="c1"># need this second typevar in the second overload
</span>
<span class="c1"># below is the signature for simple case sum(my_iterable).  
# The result may be T or int if the iterable is empty.
</span><span class="o">@</span><span class="n">overload</span>
<span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="n">it</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">T</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span> <span class="p">...</span>  
<span class="c1"># When start is given as argument, it can be of any type S, so result type is Union[T, S].
# This is why we need S; if we reused T then the ty pe of start would have to be the same type as the elements of Iterable[T]
</span><span class="o">@</span><span class="n">overload</span>
<span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="n">it</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="o">/</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="n">S</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">T</span><span class="p">,</span> <span class="n">S</span><span class="p">]:</span> <span class="p">...</span>  
<span class="c1"># The signature of the actual function implementation has not type hints.
</span><span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>  
    <span class="k">return</span> <span class="n">functools</span><span class="p">.</span><span class="nb">reduce</span><span class="p">(</span><span class="n">operator</span><span class="p">.</span><span class="n">add</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
</code></pre></div></div>

<p>Aiming for 100% of annotated code may lead to type hints that add lots of noise but little value.  Sometimes its better to leave a piece of code without Type Hints.</p>

<p>If yo have a dictionary that is a very specific record such as the exmple below.  From Python 3.8 Ther is a way to provide Type Hints for it.</p>

<p>In example below <code class="language-plaintext highlighter-rouge">TypeDict</code> exists only for the benefit of type checkers, and has no runtime effect.  It provides two things.  1. Class-like syntax to annotate a <code class="language-plaintext highlighter-rouge">dict</code> with type hints for the value of each “field” and 2. A constructor that tells the type checker to expect a <code class="language-plaintext highlighter-rouge">dict</code> with keys and values as specified.  The fact that <code class="language-plaintext highlighter-rouge">BookDict</code> creates a plain <code class="language-plaintext highlighter-rouge">dict</code> also means that 1. The “fields” in the psudoclass definition don’t create instance attributes.  2. You can’t write initializers with default values for the “fields” and 3. Method definitions are not allowed.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="s">"isbn"</span><span class="p">:</span> <span class="s">"0134757599"</span><span class="p">,</span>
 <span class="s">"title"</span><span class="p">:</span> <span class="s">"Refactoring, 2e"</span><span class="p">,</span>
 <span class="s">"authors"</span><span class="p">:</span> <span class="p">[</span><span class="s">"Martin Fowler"</span><span class="p">,</span> <span class="s">"Kent Beck"</span><span class="p">],</span>
 <span class="s">"pagecount"</span><span class="p">:</span> <span class="mi">478</span><span class="p">}</span>
</code></pre></div></div>

<p>Here is the way you type hint the above record…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypedDict</span>

<span class="k">class</span> <span class="nc">BookDict</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">isbn</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">authors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">pagecount</span><span class="p">:</span> <span class="nb">int</span>

<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">books</span> <span class="kn">import</span> <span class="n">BookDict</span>
<span class="c1"># You can call BookDict like a dict constructor with keyword arguments or passing a dict argument including dict literal
# Note that Authors sould be a list, but gradual typing means no type checking at runtime.
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">pp</span> <span class="o">=</span> <span class="n">BookDict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">'Programming Pearls'</span><span class="p">,</span>  
<span class="p">...</span>               <span class="n">authors</span><span class="o">=</span><span class="s">'Jon Bentley'</span><span class="p">,</span>  
<span class="p">...</span>               <span class="n">isbn</span><span class="o">=</span><span class="s">'0201657880'</span><span class="p">,</span>
<span class="p">...</span>               <span class="n">pagecount</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
<span class="c1"># Result of calling BookDict is a plain dict
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">pp</span>  
<span class="p">{</span><span class="s">'title'</span><span class="p">:</span> <span class="s">'Programming Pearls'</span><span class="p">,</span> <span class="s">'authors'</span><span class="p">:</span> <span class="s">'Jon Bentley'</span><span class="p">,</span> <span class="s">'isbn'</span><span class="p">:</span> <span class="s">'0201657880'</span><span class="p">,</span>
 <span class="s">'pagecount'</span><span class="p">:</span> <span class="mi">256</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">type</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">dict</span><span class="s">'&gt;
# Therfore you can'</span><span class="n">t</span> <span class="n">read</span> <span class="n">the</span> <span class="n">data</span> <span class="n">using</span> <span class="nb">object</span><span class="p">.</span><span class="n">field</span> <span class="n">notation</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pp</span><span class="p">.</span><span class="n">title</span>  
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="nb">AttributeError</span><span class="p">:</span> <span class="s">'dict'</span> <span class="nb">object</span> <span class="n">has</span> <span class="n">no</span> <span class="n">attribute</span> <span class="s">'title'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pp</span><span class="p">[</span><span class="s">'title'</span><span class="p">]</span>
<span class="s">'Programming Pearls'</span>
<span class="c1"># The type hints are in BookDict.__annotations__, and not in pp
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">BookDict</span><span class="p">.</span><span class="n">__annotations__</span>  
<span class="p">{</span><span class="s">'isbn'</span><span class="p">:</span> <span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">str</span><span class="s">'&gt;, '</span><span class="n">title</span><span class="s">': &lt;class '</span><span class="nb">str</span><span class="s">'&gt;, '</span><span class="n">authors</span><span class="s">': typing.List[str],
 '</span><span class="n">pagecount</span><span class="s">': &lt;class '</span><span class="nb">int</span><span class="s">'&gt;}

from books import BookDict
from typing import TYPE_CHECKING

def demo() -&gt; None:  
    book = BookDict(  
        isbn='</span><span class="mi">0134757599</span><span class="s">',
        title='</span><span class="n">Refactoring</span><span class="p">,</span> <span class="mi">2</span><span class="n">e</span><span class="s">',
        authors=['</span><span class="n">Martin</span> <span class="n">Fowler</span><span class="s">', '</span><span class="n">Kent</span> <span class="n">Beck</span><span class="s">'],
        pagecount=478
    )
    authors = book['</span><span class="n">authors</span><span class="s">'] 
    # typing.TYPE_CHECKING is only True when the program is being type checked.  At runtime it'</span><span class="n">s</span> <span class="n">always</span> <span class="n">false</span><span class="p">.</span>
    <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="c1"># reveal_type is not a runtime Python function but a debugging facility provided by MyPy.  That's why there is no import for it.
</span>        <span class="n">reveal_type</span><span class="p">(</span><span class="n">authors</span><span class="p">)</span>  
    <span class="c1"># These last 3 lines are illegal and will cause error message as seen further below...
</span>    <span class="n">authors</span> <span class="o">=</span> <span class="s">'Bob'</span>  
    <span class="n">book</span><span class="p">[</span><span class="s">'weight'</span><span class="p">]</span> <span class="o">=</span> <span class="mf">4.2</span>
    <span class="k">del</span> <span class="n">book</span><span class="p">[</span><span class="s">'title'</span><span class="p">]</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">demo</span><span class="p">()</span>


<span class="err">…</span><span class="o">/</span><span class="n">typeddict</span><span class="o">/</span> <span class="err">$</span> <span class="n">mypy</span> <span class="n">demo_books</span><span class="p">.</span><span class="n">py</span>
<span class="n">demo_books</span><span class="p">.</span><span class="n">py</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span> <span class="n">note</span><span class="p">:</span> <span class="n">Revealed</span> <span class="nb">type</span> <span class="ow">is</span> <span class="s">'built-ins.list[built-ins.str]'</span>  
<span class="n">demo_books</span><span class="p">.</span><span class="n">py</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span> <span class="n">error</span><span class="p">:</span> <span class="n">Incompatible</span> <span class="n">types</span> <span class="ow">in</span> <span class="n">assignment</span>
                  <span class="p">(</span><span class="n">expression</span> <span class="n">has</span> <span class="nb">type</span> <span class="s">"str"</span><span class="p">,</span> <span class="n">variable</span> <span class="n">has</span> <span class="nb">type</span> <span class="s">"List[str]"</span><span class="p">)</span>  
<span class="n">demo_books</span><span class="p">.</span><span class="n">py</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span> <span class="n">error</span><span class="p">:</span> <span class="n">TypedDict</span> <span class="s">"BookDict"</span> <span class="n">has</span> <span class="n">no</span> <span class="n">key</span> <span class="s">'weight'</span>  
<span class="n">demo_books</span><span class="p">.</span><span class="n">py</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span> <span class="n">error</span><span class="p">:</span> <span class="n">Key</span> <span class="s">'title'</span> <span class="n">of</span> <span class="n">TypedDict</span> <span class="s">"BookDict"</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">deleted</span>  
<span class="n">Found</span> <span class="mi">3</span> <span class="n">errors</span> <span class="ow">in</span> <span class="mi">1</span> <span class="nb">file</span> <span class="p">(</span><span class="n">checked</span> <span class="mi">1</span> <span class="n">source</span> <span class="nb">file</span><span class="p">)</span>
</code></pre></div></div>

<p>Below is another good exaple of using TypeHints note the comments.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AUTHOR_ELEMENT</span> <span class="o">=</span> <span class="s">'&lt;AUTHOR&gt;{}&lt;/AUTHOR&gt;'</span>

<span class="c1"># The whole point of using BookDict (from above) is in this function signature.
</span><span class="k">def</span> <span class="nf">to_xml</span><span class="p">(</span><span class="n">book</span><span class="p">:</span> <span class="n">BookDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>  
    <span class="c1"># It's often necessary to annoate collectiosn that start empty, otherwise Mypy can't infer the type of the elements.
</span>    <span class="n">elements</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">book</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># mypy understand instance checks, and treats value as a list in this block
</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  
            <span class="c1"># if you try key == 'authors' as the condition for the if guarding this block, Mypy found an error in this line: "object" has no attribute "__iter__", because it inferred the type of value returned from book.items() as object, which doesn’t support the __iter__ method required by the generator expression. With the isinstance check, this works because Mypy knows that value is a list in this block.
</span>            <span class="n">elements</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">AUTHOR_ELEMENT</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">elements</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s">'&lt;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s">&gt;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s">&lt;/</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s">&gt;'</span><span class="p">)</span>
    <span class="n">xml</span> <span class="o">=</span> <span class="s">'</span><span class="se">\n\t</span><span class="s">'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s">'&lt;BOOK&gt;</span><span class="se">\n\t</span><span class="si">{</span><span class="n">xml</span><span class="si">}</span><span class="se">\n</span><span class="s">&lt;/BOOK&gt;'</span>
</code></pre></div></div>

<p>Note that type checkesr have their limits and can’t enforce dynamic code that builds objects on the fly.  You still need data validation at runtime.</p>

<p><code class="language-plaintext highlighter-rouge">TypedDict</code> has more features includeing support for optional keys.  See https://fpy.li/pep589 for more info.</p>

<h3 id="type-casting">Type Casting</h3>

<p><code class="language-plaintext highlighter-rouge">typing.cast()</code> special function provides a way to handle type checking malfunctiosn or incorrect type hints in code we can’t fix.  At runtime <code class="language-plaintext highlighter-rouge">typing.cast()</code> does absolutely nothing.</p>

<p>Below is an example of when you need to use a cast along with some other code you should explore…</p>

<p>Noe in the example below <code class="language-plaintext highlighter-rouge">next()</code> call on generator expression will either return the index of a <code class="language-plaintext highlighter-rouge">str</code> item or raise <code class="language-plaintext highlighter-rouge">StopIteration</code>.  Therefore <code class="language-plaintext highlighter-rouge">find_first_str</code> will always return str if no exception is raised, and <code class="language-plaintext highlighter-rouge">str</code> is the dclared return type.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">cast</span>

<span class="k">def</span> <span class="nf">find_first_str</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">object</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">index</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">))</span>
    <span class="c1"># We only get here if there's at least one string
</span>    <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</code></pre></div></div>

<p>Don’t get too comforable useing cast to silence mypy because Mypy is usually right when it reports an error.</p>

<h3 id="reading-type-hints-at-runtime">Reading Type Hints at Runtime</h3>

<p>At import time Python reads the type hints in functions, classes and modules, and stores them in attributes named <code class="language-plaintext highlighter-rouge">__annotations__</code> as in exmaple code below…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">clip</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">80</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>

<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">clip_annot</span> <span class="kn">import</span> <span class="n">clip</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">clip</span><span class="p">.</span><span class="n">__annotations__</span>
<span class="p">{</span><span class="s">'text'</span><span class="p">:</span> <span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">str</span><span class="s">'&gt;, '</span><span class="n">max_len</span><span class="s">': &lt;class '</span><span class="nb">int</span><span class="s">'&gt;, '</span><span class="k">return</span><span class="s">': &lt;class '</span><span class="nb">str</span><span class="s">'&gt;}
</span></code></pre></div></div>

<p>If for some reason you need annoations at runtime use <code class="language-plaintext highlighter-rouge">inspect.get_annotations</code> or <code class="language-plaintext highlighter-rouge">typing.get_hints</code> as this is actively being developed and other stuff may change under you.</p>

<h4 id="basic-jargon-for-generic-types">Basic Jargon for Generic Types</h4>

<p>Some usefull definitions for generics…</p>

<p><strong><em>Generic type</em></strong> A type declared with one or more type variables. <code class="language-plaintext highlighter-rouge">LottoBlower[T]</code> or <code class="language-plaintext highlighter-rouge">abc.Mapping[KT, VT]</code></p>

<p><strong><em>Formal type parameter</em></strong> The type variables that appear in a genric type declaration.  <code class="language-plaintext highlighter-rouge">KT</code> and <code class="language-plaintext highlighter-rouge">VT</code> in <code class="language-plaintext highlighter-rouge">abc.Mapping[KT, VT]</code></p>

<p><strong><em>Parameterized type</em></strong> A type declared with actual type parameters.  <code class="language-plaintext highlighter-rouge">LottoBlower[int]</code>, <code class="language-plaintext highlighter-rouge">abc.Mapping[str, float]</code></p>

<p><strong><em>Actual type parameter</em></strong> The actual types given as parameters when a parameterized type is declared. <code class="language-plaintext highlighter-rouge">int</code> in <code class="language-plaintext highlighter-rouge">LottoBlower[int]</code></p>

<h4 id="variance">Variance</h4>

<p>This is a section that I should go back to when I have a better grasp of Type hints from writing my own guide.  There is just a lot of abstract concepts to follow here.</p>

<h2 id="chapter-16-operator-overloading">Chapter 16 Operator Overloading</h2>

<h3 id="operator-overloading-101">Operator Overloading 101</h3>

<p>Operator overloading in Python allows user defined types to interoperate with operators such as <code class="language-plaintext highlighter-rouge">+</code> and <code class="language-plaintext highlighter-rouge">|</code>.</p>

<p>Python applies some limitations on operator overloading.  We cannot change the meaning of the operators for the build in types.  We cannot create new operators, only overload existing ones.  A few operators can’t be overloaded: <code class="language-plaintext highlighter-rouge">is</code>, <code class="language-plaintext highlighter-rouge">and</code>, <code class="language-plaintext highlighter-rouge">or</code>, <code class="language-plaintext highlighter-rouge">not</code> but bitwise <code class="language-plaintext highlighter-rouge">&amp;</code>, <code class="language-plaintext highlighter-rouge">|</code>, <code class="language-plaintext highlighter-rouge">~</code> can.</p>

<p>As a rule of thumb when implementing the dunder method to overload an operator don’t modify the objects being passed return a new object of the suitable type.</p>

<p>To support operations involving objects of different types, Python implements a special dispatching mechanism for the infix operator special methods.  Given an expression <code class="language-plaintext highlighter-rouge">a + b</code>, the interpreter will perform these steps</p>

<ol>
  <li>If <code class="language-plaintext highlighter-rouge">a</code> had <code class="language-plaintext highlighter-rouge">__add__</code>, call <code class="language-plaintext highlighter-rouge">a.__add__(b)</code> and return result unless it’s <code class="language-plaintext highlighter-rouge">NotImplemented</code>.</li>
  <li>If <code class="language-plaintext highlighter-rouge">a</code> doesn’t have <code class="language-plaintext highlighter-rouge">__add__</code>, or calling it returns <code class="language-plaintext highlighter-rouge">NotImplemented</code>, check if <code class="language-plaintext highlighter-rouge">b</code> has <code class="language-plaintext highlighter-rouge">__radd__</code>, then call <code class="language-plaintext highlighter-rouge">b.__radd__(a)</code> and return results unless it’s <code class="language-plaintext highlighter-rouge">NotImplemented</code>.</li>
  <li>If <code class="language-plaintext highlighter-rouge">b</code> doesn’t have <code class="language-plaintext highlighter-rouge">__radd__</code>, or callint it returns <code class="language-plaintext highlighter-rouge">notImplemented</code>, raise <code class="language-plaintext highlighter-rouge">TypeError</code> with <em>unsuported operand types message</em></li>
</ol>

<p>the <code class="language-plaintext highlighter-rouge">NotImplemented</code> is what is returned to signale that <code class="language-plaintext highlighter-rouge">__add__</code> or <code class="language-plaintext highlighter-rouge">__radd__</code> does not know how to handle the other type.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># inside the Vector class
</span>
    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>  
        <span class="n">pairs</span> <span class="o">=</span> <span class="n">itertools</span><span class="p">.</span><span class="n">zip_longest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Vector</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>  
        <span class="k">return</span> <span class="bp">self</span> <span class="o">+</span> <span class="n">other</span>
</code></pre></div></div>

<p>Similar logic applies for <code class="language-plaintext highlighter-rouge">__mul__</code> and <code class="language-plaintext highlighter-rouge">__rmul__</code></p>

<h3 id="rich-comparison-operators">Rich Comparison Operators</h3>

<p>Handing of the rich comparison operatos <code class="language-plaintext highlighter-rouge">==</code>, <code class="language-plaintext highlighter-rouge">!=</code>, <code class="language-plaintext highlighter-rouge">&gt;</code>, <code class="language-plaintext highlighter-rouge">&lt;</code>, <code class="language-plaintext highlighter-rouge">&lt;=</code>, <code class="language-plaintext highlighter-rouge">&gt;=</code> is similar to above but differes in two aspects.  The same set of methods is used in forward and reverse operator calls (for exmple in case of <code class="language-plaintext highlighter-rouge">==</code> both the forward and reverse calls invoke <code class="language-plaintext highlighter-rouge">__eq__</code>) only a forward call to <code class="language-plaintext highlighter-rouge">__gt__</code> is followed by a reverse calld to <code class="language-plaintext highlighter-rouge">__lt__</code> with the arguments swapped.  In the case of <code class="language-plaintext highlighter-rouge">==</code> and <code class="language-plaintext highlighter-rouge">!=</code> if the reverse method is missing or returns <code class="language-plaintext highlighter-rouge">NotImplemented</code> Python compares the object IDs instead of raising <code class="language-plaintext highlighter-rouge">TypeError</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Vector</span><span class="p">:</span>
    <span class="c1"># many lines omitted
</span>
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span>
</code></pre></div></div>

<h3 id="augmented-assignment-operators">Augmented Assignment Operators</h3>

<p>If you need in place addition implement the <code class="language-plaintext highlighter-rouge">__iadd__</code> method.</p>

<p>For <code class="language-plaintext highlighter-rouge">+=</code> operator you just need to implement <code class="language-plaintext highlighter-rouge">__add__</code> becuase <code class="language-plaintext highlighter-rouge">a += b</code> evaluates to <code class="language-plaintext highlighter-rouge">a = a + b</code></p>

<h2 id="chapater-17-iterators-generators-and-classic-coroutines">Chapater 17 Iterators Generators and Classic Coroutines</h2>

<p>Iteration is fundamental to data processing: programs apply computations to data series.  If data desont’ fit in memory, we need to feth the items lazily one at a time and on demand.  That is what an iterator does and what this chapter focuses on.</p>

<p>When Python needs to iterate over an object <code class="language-plaintext highlighter-rouge">x</code>, it automatically calls <code class="language-plaintext highlighter-rouge">iter(x)</code></p>

<p>The <code class="language-plaintext highlighter-rouge">iter</code> built-in function does the following</p>

<ol>
  <li>Checks whedther the object implements <code class="language-plaintext highlighter-rouge">__iter__</code>, and calls that to obtain an iterator.</li>
  <li>If <code class="language-plaintext highlighter-rouge">__iter__</code> is not implemented, but <code class="language-plaintext highlighter-rouge">__getitem__</code> is, then <code class="language-plaintext highlighter-rouge">iter()</code> creartes an iterator that tries to fetch items by index, starting from 0 (zero)</li>
  <li>If that fails, Python raises <code class="language-plaintext highlighter-rouge">TypeError</code>, usually saying <code class="language-plaintext highlighter-rouge">C object is not iterable</code> where <code class="language-plaintext highlighter-rouge">C</code> is the class o the object.</li>
</ol>

<p>This is why all Python sequences are iterable: by definition they all implement <code class="language-plaintext highlighter-rouge">__getitem__</code>. The standard sequences even implement <code class="language-plaintext highlighter-rouge">__iter__</code> and your shoud as iteravtion via <code class="language-plaintext highlighter-rouge">__getitem__</code> is there for backward compatability.</p>

<p>For duck typing an object is iterable if it has either the <code class="language-plaintext highlighter-rouge">__getitem__</code> or <code class="language-plaintext highlighter-rouge">iterable</code> method implemented.  From Python 3.10 onwards the best way to check if something is iterable is to call <code class="language-plaintext highlighter-rouge">item(x)</code> and handle the potential error.</p>

<h3 id="using-iter-with-a-callable">Using iter with a Callable</h3>

<p>When we call <code class="language-plaintext highlighter-rouge">iter()</code> with two arguments to create an iterator from a function or any callable object.  Below is an example of using this technique to simulate rolling a 6 sided dice.</p>

<p>In this usage, the first argument must be a callable to be invoked repeatedly (with no arguments) to produce values, and the second argument is a <code class="language-plaintext highlighter-rouge">sentinel</code> a marker value which, when returned by the callable cause the iterator to raise StopIteration.  So in example below we can never roll a 1.  A place where this is useful is in buidling a block reader.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">d6</span><span class="p">():</span>
<span class="p">...</span>     <span class="k">return</span> <span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">d6_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">d6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">d6_iter</span>
<span class="o">&lt;</span><span class="n">callable_iterator</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x10a245270</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">roll</span> <span class="ow">in</span> <span class="n">d6_iter</span><span class="p">:</span>
<span class="p">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">roll</span><span class="p">)</span>
<span class="p">...</span>
<span class="mi">4</span>
<span class="mi">3</span>
<span class="mi">6</span>
<span class="mi">3</span>
</code></pre></div></div>

<h3 id="iterables-versus-iterators">Iterables Versus Iterators</h3>

<p>An iterable is any object from which the <code class="language-plaintext highlighter-rouge">iter</code> built in function can obtain an iterator.  Objects implementeing the <code class="language-plaintext highlighter-rouge">__iter__</code> method are iterable.  Sequences are always iterable as they implement <code class="language-plaintext highlighter-rouge">__getitem__</code> method.  When using an iterator you build an iterator via <code class="language-plaintext highlighter-rouge">__iter__</code> and call <code class="language-plaintext highlighter-rouge">next</code> on the iterator as in the for loop equivalent below…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="s">'ABC'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
<span class="p">...</span>     <span class="k">try</span><span class="p">:</span>
<span class="p">...</span>         <span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">))</span>  
<span class="p">...</span>     <span class="k">except</span> <span class="nb">StopIteration</span><span class="p">:</span>  
<span class="p">...</span>         <span class="k">del</span> <span class="n">it</span>  
<span class="p">...</span>         <span class="k">break</span>  
<span class="p">...</span>
<span class="n">A</span>
<span class="n">B</span>
<span class="n">C</span>
</code></pre></div></div>

<p>Below is the example of iterator demo sentence class that gives you one word at a time in iteration.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">reprlib</span>

<span class="n">RE_WORD</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="sa">r</span><span class="s">'\w+'</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Sentence</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">words</span> <span class="o">=</span> <span class="n">RE_WORD</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s">'Sentence(</span><span class="si">{</span><span class="n">reprlib</span><span class="p">.</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">text</span><span class="p">)</span><span class="si">}</span><span class="s">)'</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
        <span class="k">return</span> <span class="n">SentenceIterator</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">words</span><span class="p">)</span>  


<span class="k">class</span> <span class="nc">SentenceIterator</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">words</span><span class="p">):</span>
        <span class="c1"># Sentence iterator holds reference to words.
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">words</span> <span class="o">=</span> <span class="n">words</span>
        <span class="c1"># Self.index determines the next word to fetch
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>  

    <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># get the word at self.index
</span>            <span class="n">word</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">words</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">index</span><span class="p">]</span>  
        <span class="k">except</span> <span class="nb">IndexError</span><span class="p">:</span>
            <span class="c1"># if no word raise StopIteration
</span>            <span class="k">raise</span> <span class="nb">StopIteration</span><span class="p">()</span>
        <span class="c1"># increment self.index
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>  
        <span class="k">return</span> <span class="n">word</span>  

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></div>

<h3 id="dont-make-the-iterable-an-iterator-for-itself">Don’t make the Iterable an Iterator for Itself</h3>

<p>In example above it may be tempting to implement <code class="language-plaintext highlighter-rouge">__next__</code> in the Sentence class itself instead of writing another class but this is a common anti pattern and not a good practice.  To support multiple treversals it must be possible to obtain multiple instances of the iterable instance which is not possible if you implement <code class="language-plaintext highlighter-rouge">__next__</code> in the class itself.</p>

<p>The example above is easy to understand but Pythonic way of doing it is to use the <code class="language-plaintext highlighter-rouge">yield</code> keyword as in the example below…</p>

<p>Any Python function that has the <code class="language-plaintext highlighter-rouge">yield</code> keyword in its body is a generator function: a function which, when called, returns a generator object.  In other words a generator function is a generator factory.</p>

<p>The only syntax distinguishing a plain function from a generator function is the fact that the latter has a <code class="language-plaintext highlighter-rouge">yield</code> keyword somewhere in its body.</p>

<p>When we invoke <code class="language-plaintext highlighter-rouge">next()</code> on the generator object, exectuion advances to the next <code class="language-plaintext highlighter-rouge">yield</code> in the function body, and the <code class="language-plaintext highlighter-rouge">next()</code> call evaluates to the value yielded when the function body was suspended.  Finally enclosing generator object created by Python raises <code class="language-plaintext highlighter-rouge">StopIteration</code> when the function body returns, in accordance with the iterator protocol.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">reprlib</span>

<span class="n">RE_WORD</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="sa">r</span><span class="s">'\w+'</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Sentence</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">words</span> <span class="o">=</span> <span class="n">RE_WORD</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">'Sentence(%s)'</span> <span class="o">%</span> <span class="n">reprlib</span><span class="p">.</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>

    <span class="c1"># Iterate over self.words
</span>    <span class="c1"># Yield the current word
</span>    <span class="c1"># Explicit return is not necessary; the function can just "fall through" and return automatically.  
</span>    <span class="c1"># Ethier way a generator function does not raise StopIteration: It simply exists when done producing values.
</span>    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">words</span><span class="p">:</span>  
            <span class="k">yield</span> <span class="n">word</span>  
        

<span class="c1"># done!
</span></code></pre></div></div>

<p>You can use tuples in two ways.  First is a record with entreis being different types and the second as an immutable list.  Below are the hing signatures for each.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># A city record with name, country, and population:
</span><span class="n">city</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>

<span class="c1"># An immutable sequence of domain names:
</span><span class="n">domains</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">...]</span>
</code></pre></div></div>

<p>Similarly generators are commonly used as iterators, but they can also be used as a coroutine.  A coroutine is a generator function, created with teh <code class="language-plaintext highlighter-rouge">yield</code> keyword in its body.  A coroutine object is physically a generator object.  Generators produce data for iteration, coroutines are consumers of data</p>

<h2 id="chapter-18-with-match-and-else-blocks">Chapter 18 with match and else Blocks</h2>

<p>This chapter focuses on flow control featues which are not common in other languages.  These features ares the <code class="language-plaintext highlighter-rouge">with</code> statement and context manager protocol, pattern matching with <code class="language-plaintext highlighter-rouge">match/case</code> and the <code class="language-plaintext highlighter-rouge">else</code> clause in <code class="language-plaintext highlighter-rouge">for</code>, <code class="language-plaintext highlighter-rouge">while</code>, <code class="language-plaintext highlighter-rouge">try</code> statements.</p>

<h3 id="context-managers-and-with-blocks">Context Managers and with Blocks</h3>

<p>The <code class="language-plaintext highlighter-rouge">with</code> statement sets upa temporary context and reliably tears it down, under the control of a context mamanger object.  This prevents errors and reduces boilerplate code, making APIs at the same time safer and easier to use.</p>

<p>Context managers exist to control a <code class="language-plaintext highlighter-rouge">with</code> statement just like iterators exist to control a <code class="language-plaintext highlighter-rouge">for</code> satement.</p>

<p>The standard library includes the <code class="language-plaintext highlighter-rouge">contextlib</code> package with handy functions, classes, and decorators for building, combining, and using context managers.</p>

<p>Below is a context manager for reversion strings.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span>

<span class="k">class</span> <span class="nc">LookingGlass</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># Python invokes __enter__ with no arguments other than self.
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">original_write</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">write</span>  <span class="c1"># Hold the original sys.stdout.write method so we can restore it later.
</span>        <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">reverse_write</span>  <span class="c1"># Monkey-patch sys.stdout.write, replacing it with our own method.
</span>        <span class="k">return</span> <span class="s">'JABBERWOCKY'</span>  <span class="c1"># return string just so we have something to put in target variable what.
</span>
    <span class="c1"># This is out replacement to sys.stdout.write reverse the text argumetn and calls the original implementation.
</span>    <span class="k">def</span> <span class="nf">reverse_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">original_write</span><span class="p">(</span><span class="n">text</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>  <span class="c1"># Python calls __exit__ with None, None, None if all went well; if an exception is raised, the three arguments get the excption data.
</span>        <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">original_write</span>  <span class="c1"># restore the original method to sys.stdout.write
</span>        <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="nb">ZeroDivisionError</span><span class="p">:</span>  <span class="c1"># If the exception type is not None and its type is ZeroDevisionError print a message.
</span>            <span class="k">print</span><span class="p">(</span><span class="s">'Please DO NOT divide by zero!'</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>  <span class="c1"># return true to tell the interpreter the exception was handled.  
</span>        <span class="c1"># if __exit__ returns None or any false exceptions raised in the with block will be propogated.
</span>        
</code></pre></div></div>

<p>This is a sample run of the context manger above.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">mirror</span> <span class="kn">import</span> <span class="n">LookingGlass</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">LookingGlass</span><span class="p">()</span> <span class="k">as</span> <span class="n">what</span><span class="p">:</span>  <span class="c1"># The context manager is an interface of LookingGlass; Python calls __enter__ on the context manager and ther esult is bound to what.
</span>    <span class="p">...</span>      <span class="k">print</span><span class="p">(</span><span class="s">'Alice, Kitty and Snowdrop'</span><span class="p">)</span>  <span class="c1"># Print a str, then the value of the target variable what.  The output of each print will come out reversed.
</span>    <span class="p">...</span>      <span class="k">print</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
    <span class="p">...</span>
    <span class="n">pordwonS</span> <span class="n">dna</span> <span class="n">yttiK</span> <span class="p">,</span><span class="n">ecilA</span>
    <span class="n">YKCOWREBBAJ</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="n">what</span> <span class="c1"># Now the with block is over.  WE can see that the value reurend by __enter__, held in what is the string 'JABBERWOCKY'
</span>    <span class="s">'JABBERWOCKY'</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="s">'Back to normal.'</span><span class="p">)</span>  <span class="c1"># Program output is no longer reversed.
</span>    <span class="n">Back</span> <span class="n">to</span> <span class="n">normal</span><span class="p">.</span>
</code></pre></div></div>

<p>Note that in real life if you need to replace the standard out with a file like object for a while like in the example above there is a <code class="language-plaintext highlighter-rouge">contextlib.redirect_stdout</code> context manager for that already implemented.</p>

<p>For undersatning here is the LookingGlass case being used without the <code class="language-plaintext highlighter-rouge">with statement</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">mirror</span> <span class="kn">import</span> <span class="n">LookingGlass</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="n">manager</span> <span class="o">=</span> <span class="n">LookingGlass</span><span class="p">()</span>  <span class="c1"># instantiate and inspect the manager instance
</span>    <span class="o">&gt;&gt;&gt;</span> <span class="n">manager</span>  <span class="c1"># doctest: +ELLIPSIS
</span>    <span class="o">&lt;</span><span class="n">mirror</span><span class="p">.</span><span class="n">LookingGlass</span> <span class="nb">object</span> <span class="n">at</span> <span class="mi">0</span><span class="n">x</span><span class="p">...</span><span class="o">&gt;</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="n">monster</span> <span class="o">=</span> <span class="n">manager</span><span class="p">.</span><span class="n">__enter__</span><span class="p">()</span>  <span class="c1"># Call the manager's __enter__ method and store result in monster
</span>    <span class="o">&gt;&gt;&gt;</span> <span class="n">monster</span> <span class="o">==</span> <span class="s">'JABBERWOCKY'</span>  <span class="c1"># monster is the string 'JABBERWOCKY'.  The True identifier appears reversed because all output via stdout goes through the write method we patched in __enter__.
</span>    <span class="n">eurT</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="n">monster</span>
    <span class="s">'YKCOWREBBAJ'</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="n">manager</span>  <span class="c1"># doctest: +ELLIPSIS
</span>    <span class="o">&gt;</span><span class="p">...</span> <span class="n">ta</span> <span class="n">tcejbo</span> <span class="n">ssalGgnikooL</span><span class="p">.</span><span class="n">rorrim</span><span class="o">&lt;</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="n">manager</span><span class="p">.</span><span class="n">__exit__</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>  <span class="n">Call</span> <span class="n">manager</span><span class="p">.</span><span class="n">__exit__</span> <span class="n">to</span> <span class="n">restore</span> <span class="n">the</span> <span class="n">previous</span> <span class="n">stdout</span><span class="p">.</span><span class="n">write</span><span class="p">.</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="n">monster</span>
    <span class="s">'JABBERWOCKY'</span>
</code></pre></div></div>

<h3 id="python-310-improvment">Python 3.10 improvment</h3>

<p>Before Python 3.10 you had to next context managers but with Python 3.10 you can do soemthing like this…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="p">(</span>
    <span class="n">CtxManager1</span><span class="p">()</span> <span class="k">as</span> <span class="n">example1</span><span class="p">,</span>
    <span class="n">CtxManager2</span><span class="p">()</span> <span class="k">as</span> <span class="n">example2</span><span class="p">,</span>
    <span class="n">CtxManager3</span><span class="p">()</span> <span class="k">as</span> <span class="n">example3</span><span class="p">,</span>
<span class="p">):</span>
    <span class="p">...</span>
</code></pre></div></div>

<h3 id="the-contextlib-utilities">The contextlib Utilities</h3>

<p>This is a good refernce for the context managers that already exist in Python so you don’t build something that is already ghere. https://fpy.li/18-9</p>

<p><code class="language-plaintext highlighter-rouge">contextlib</code> package also includes <code class="language-plaintext highlighter-rouge">closing</code> a function to build context managers out of object that provide a <code class="language-plaintext highlighter-rouge">close()</code> method but don’t implement the <code class="language-plaintext highlighter-rouge">__enter__</code>/<code class="language-plaintext highlighter-rouge">__exit__</code> interface.  <code class="language-plaintext highlighter-rouge">supress</code> A context manager to temporarily ignore exceptiosn given as arguments, and <code class="language-plaintext highlighter-rouge">nullcontext</code> A context manager that does nothing, to simplify conditional logic around objects that may not implement a suitable context manager.  It serves as a stand in when conditional code before the <code class="language-plaintext highlighter-rouge">with</code> block may or may not provide a context manger for the <code class="language-plaintext highlighter-rouge">with statement</code>.</p>

<p><code class="language-plaintext highlighter-rouge">contextlib</code> module provides classes and decorators</p>

<p><code class="language-plaintext highlighter-rouge">@contextmanger</code> - A decorater that lets you build a context manager rom a simple generator function, instaed of creating a class and implementing the interface.</p>

<p><code class="language-plaintext highlighter-rouge">AbstractContextManager</code> - An ABC that formalizes the context manager interface, and makes it a bit easier to create context manager classes by subclassing</p>

<p><code class="language-plaintext highlighter-rouge">ContextDecorator</code> - A base class for defining class-based context managers that can also be used as function decorators, running the entire function within a managed context.</p>

<p><code class="language-plaintext highlighter-rouge">ExitStack</code> - A context manager that lets you enter a variable number of context managers. When the with block ends, ExitStack calls the stacked context managers’ <strong>exit</strong> methods in LIFO order (last entered, first exited). Use this class when you don’t know beforehand how many context managers you need to enter in your with block; for example, when opening all files from an arbitrary list of files at the same time.</p>

<p>With Python 3.7, contextlib added <code class="language-plaintext highlighter-rouge">AbstractAsyncContextManager</code>, <code class="language-plaintext highlighter-rouge">@asynccontextmanager</code>, and <code class="language-plaintext highlighter-rouge">AsyncExitStack</code>. They are similar to the equivalent utilities without the async part of the name, but designed for use with the new async with statement.</p>

<h3 id="using-contextmanager">Using @contextmanager</h3>

<p>Using @contextmanager reduces the boilerplate of creating a context manager: instead of writing a whole class with <code class="language-plaintext highlighter-rouge">__enter__/__exit__</code> methods, you just implement a generator with a single yield that should produce whatever you want the <code class="language-plaintext highlighter-rouge">__enter__</code> method to return.</p>

<p>In a generator decoreate with <code class="language-plaintext highlighter-rouge">@contextmanager</code>, <code class="language-plaintext highlighter-rouge">yield</code> splits the body fo the function into two parts; everything before the <code class="language-plaintext highlighter-rouge">yield</code> will be executed at the beginning of the <code class="language-plaintext highlighter-rouge">with</code> block when the interpreter calls <code class="language-plaintext highlighter-rouge">__enter__</code>; the code after <code class="language-plaintext highlighter-rouge">yield</code> will run when <code class="language-plaintext highlighter-rouge">__exit__</code> is called a the end of the block.</p>

<p>The exmaple below replaces the LookingGlass example above with a generator.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="o">@</span><span class="n">contextlib</span><span class="p">.</span><span class="n">contextmanager</span> <span class="c1"># Apply the contextmanager decorator
</span><span class="k">def</span> <span class="nf">looking_glass</span><span class="p">():</span>
    <span class="n">original_write</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">write</span> <span class="c1"># Preserve the original sys.stdout.write method.
</span>
    <span class="k">def</span> <span class="nf">reverse_write</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>  <span class="c1"># reverse_write can call original_write later because it is available in its closure
</span>        <span class="n">original_write</span><span class="p">(</span><span class="n">text</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">reverse_write</span>  <span class="c1"># Replace sys.stdout.write and reverse_write.
</span>    <span class="k">yield</span> <span class="s">'JABBERWOCKY'</span>  <span class="c1"># Yield the value that will be boudn to the target variable in the as clause of the with statement.  The generator pauses at this point while the body of the with executes.
</span>    <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">original_write</span> <span class="c1"># When control exits the with block, execution continues afte the yield; here the original sys.stdout.write is restored.
</span></code></pre></div></div>

<p>Below is the above lookig glass function in operation.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">mirror_gen</span> <span class="kn">import</span> <span class="n">looking_glass</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">looking_glass</span><span class="p">()</span> <span class="k">as</span> <span class="n">what</span><span class="p">:</span>  
    <span class="p">...</span>      <span class="k">print</span><span class="p">(</span><span class="s">'Alice, Kitty and Snowdrop'</span><span class="p">)</span>
    <span class="p">...</span>      <span class="k">print</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
    <span class="p">...</span>
    <span class="n">pordwonS</span> <span class="n">dna</span> <span class="n">yttiK</span> <span class="p">,</span><span class="n">ecilA</span>
    <span class="n">YKCOWREBBAJ</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="n">what</span>
    <span class="s">'JABBERWOCKY'</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="s">'back to normal'</span><span class="p">)</span>
    <span class="n">back</span> <span class="n">to</span> <span class="n">normal</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">contextlib.contextmanager</code> decorator wraps the function in a class that implements the <code class="language-plaintext highlighter-rouge">__enter__</code> and <code class="language-plaintext highlighter-rouge">__exit__</code> methods.</p>

<p>The <code class="language-plaintext highlighter-rouge">__enter__</code> method of that class calls the generator object to get a generator object lets call it <code class="language-plaintext highlighter-rouge">gen</code>.  It calls <code class="language-plaintext highlighter-rouge">next(gen)</code> to dirve to the <code class="language-plaintext highlighter-rouge">yield</code> keyword.  Returns the value yielded by <code class="language-plaintext highlighter-rouge">next(gen)</code>, to allow the user to bind it to a variable in the <code class="language-plaintext highlighter-rouge">with/as</code> form.  When the <code class="language-plaintext highlighter-rouge">with</code> block terminates, the <code class="language-plaintext highlighter-rouge">__exit__</code> method will check whether an exception was passed as <code class="language-plaintext highlighter-rouge">exc_type</code>; if so, <code class="language-plaintext highlighter-rouge">gen.throw(exception)</code> is invoked causing the exception to be raised in the <code class="language-plaintext highlighter-rouge">yield</code> line inside the generator function body.  Otherwise <code class="language-plaintext highlighter-rouge">next(gen)</code> is called, resuming the execution of the generator function body after the <code class="language-plaintext highlighter-rouge">yield</code>.</p>

<p>The example above has a flaw.   if an exception is raised in the body of the with block, the Python interpreter will catch it and raise it again in the yield expression inside looking_glass. But there is no error handling there, so the looking_glass generator will terminate without ever restoring the original sys.stdout.write method, leaving the system in an invalid state.  The code below is a fix for this…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="o">@</span><span class="n">contextlib</span><span class="p">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">looking_glass</span><span class="p">():</span>
    <span class="n">original_write</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">write</span>

    <span class="k">def</span> <span class="nf">reverse_write</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="n">original_write</span><span class="p">(</span><span class="n">text</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">reverse_write</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s">''</span>  <span class="c1"># Create a variable for a possible error message;
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="s">'JABBERWOCKY'</span>
    <span class="k">except</span> <span class="nb">ZeroDivisionError</span><span class="p">:</span> <span class="c1"># Handle ZeroDivisionError by setting an error message.  
</span>        <span class="n">msg</span> <span class="o">=</span> <span class="s">'Please DO NOT divide by zero!'</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">original_write</span> <span class="c1"># Undo monkey patcheing of sys.stdout.write
</span>        <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="c1"># display error message if it was set.
</span></code></pre></div></div>

<p>Recall that the <code class="language-plaintext highlighter-rouge">__exit__</code> method tells the interpreter that it has handled the exception by returning a truthy value; in that case, the interpreter suppresses the exception. On the other hand, if <code class="language-plaintext highlighter-rouge">__exit__</code> does not explicitly return a value, the interpreter gets the usual None, and propagates the exception. With @contextmanager, the default behavior is inverted: the <code class="language-plaintext highlighter-rouge">__exit__</code> method provided by the decorator assumes any exception sent into the generator is handled and should be suppressed.</p>

<p>Having a <code class="language-plaintext highlighter-rouge">try/finally</code> or a <code class="language-plaintext highlighter-rouge">with</code> block around the <code class="language-plaintext highlighter-rouge">yield</code> is an unavaoidable price of using <code class="language-plaintext highlighter-rouge">@contextmanager</code> because you never know what the users of yoru context manager ar going to do inside the <code class="language-plaintext highlighter-rouge">with</code> block.</p>

<p>A little known featuer of <code class="language-plaintext highlighter-rouge">@contextmanager</code> is that generators decorated with it can also be used as decorators themselves.  That happens because <code class="language-plaintext highlighter-rouge">@contextmanager</code> is implemented within the <code class="language-plaintext highlighter-rouge">contextlib.ContextDecorator</code> class.  Example of this below…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="o">@</span><span class="n">looking_glass</span><span class="p">()</span>
    <span class="p">...</span> <span class="k">def</span> <span class="nf">verse</span><span class="p">():</span>
    <span class="p">...</span>     <span class="k">print</span><span class="p">(</span><span class="s">'The time has come'</span><span class="p">)</span>
    <span class="p">...</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="n">verse</span><span class="p">()</span>  <span class="c1"># looking_glass does its job before and after the body of the verse runs.
</span>    <span class="n">emoc</span> <span class="n">sah</span> <span class="n">emit</span> <span class="n">ehT</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="s">'back to normal'</span><span class="p">)</span>  <span class="c1"># this confirms that the original sys.write was restored.
</span>    <span class="n">back</span> <span class="n">to</span> <span class="n">normal</span>
</code></pre></div></div>

<h3 id="do-this-then-that-else-blocks-beyond-if">Do This, Then That: else Blocks Beyond if</h3>

<p>The <code class="language-plaintext highlighter-rouge">else</code> clause in Ptyon can be used beyond the <code class="language-plaintext highlighter-rouge">if</code> statment.  It can be sued with <code class="language-plaintext highlighter-rouge">for</code>, <code class="language-plaintext highlighter-rouge">while</code>, and <code class="language-plaintext highlighter-rouge">try</code> statements.</p>

<p>Here are the rules…</p>

<p><code class="language-plaintext highlighter-rouge">for</code> - The <code class="language-plaintext highlighter-rouge">else</code> block will run only if and when the for loop runs to completion (i.e. not if the <code class="language-plaintext highlighter-rouge">for</code> is aborted with a <code class="language-plaintext highlighter-rouge">break</code>)</p>

<p><code class="language-plaintext highlighter-rouge">while</code> - The <code class="language-plaintext highlighter-rouge">else</code> block will run only if an dwhen the <code class="language-plaintext highlighter-rouge">while</code> loop exits because the condition become falsy (i.e. not if the while is aborted with a break)</p>

<p><code class="language-plaintext highlighter-rouge">try</code> - The <code class="language-plaintext highlighter-rouge">else</code> block will run only if no exception is raised in the <code class="language-plaintext highlighter-rouge">try</code> block.  The official docs also state: “Exceptions in the else clause are not handled by the preceding <code class="language-plaintext highlighter-rouge">except</code> clauses.</p>

<p>In all cases the <code class="language-plaintext highlighter-rouge">else</code> clause is also skipped if an exception or a <code class="language-plaintext highlighter-rouge">return</code>, <code class="language-plaintext highlighter-rouge">break</code>, or <code class="language-plaintext highlighter-rouge">continue</code> statement causes control to jump out of the main block of the compound statement.</p>

<p>Using <code class="language-plaintext highlighter-rouge">else</code> with these statements often makes the code easier to read and saves the trouble of setting up control flags or coding extra <code class="language-plaintext highlighter-rouge">if</code> statements.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">my_list</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="n">flavor</span> <span class="o">==</span> <span class="s">'banana'</span><span class="p">:</span>
        <span class="k">break</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'No banana flavor found!'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span><span class="p">:</span>
    <span class="n">dangerous_call</span><span class="p">()</span>
    <span class="n">after_call</span><span class="p">()</span>
<span class="k">except</span> <span class="nb">OSError</span><span class="p">:</span>
    <span class="n">log</span><span class="p">(</span><span class="s">'OSError...'</span><span class="p">)</span>

<span class="c1"># in above example after_call is in the try block for no good reason but with else we can do...
</span><span class="k">try</span><span class="p">:</span>
    <span class="n">dangerous_call</span><span class="p">()</span>
<span class="k">except</span> <span class="nb">OSError</span><span class="p">:</span>
    <span class="n">log</span><span class="p">(</span><span class="s">'OSError...'</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">after_call</span><span class="p">()</span>
<span class="c1"># Now it's clear that the try block is guarding against possible errors in dangerous_call() and not in after_call().  Its also explicit that after_call will only execute if no exceptiosn are raise din the try block.
</span></code></pre></div></div>

<h2 id="chapter-19-concurrency-model-in-python">Chapter 19 Concurrency Model in Python.</h2>

<p>The main challenge with concurrnency is when you start a thread you need some way to track it for it to be usable in code.  Also starting a thread is expensive so you want to be mindfull of how much work you have the thread doing.</p>

<h3 id="a-bit-of-jargoncore-concepts">A bit of Jargon/Core concepts.</h3>

<p><strong>Concurrency</strong> - The ability to handle multiple tasks, making progress one at a time or in parallel (if possible) so that each of them eventually succeeds or fails.  A single core CPU is capable of concurrency if it runs an OS scheduler that interleaves the execution of the pending tasks.  Also known as multitasking.</p>

<p><strong>Parallelism</strong> - The ability to execute multiple computations at the same time.  This requires a multicore CPU, multiple CPUs or a GPU or multiple computers in a cluster.</p>

<p><strong>Execution Unit</strong> - A genral term for objects that execute code conccurrenlty, each with independent state and call stack.  Python natively supports 3 kinds of execution units: processes, threads and coroutines.</p>

<p><strong>Process</strong> - An instance of a computer program while it is running, using memory and a slice of the CPU time.  Processes communicate via pipes, sockets, or memory mapped files - all of which can only carry raw bytes.  Python bytes must be serialized (converted to raw bytes) to be passed from one process to another.</p>

<p><strong>Thread</strong> - An execution unit within a single process.  When a process starst it uses a single thread but can create more threads to operate concurrently.  Threads wihthin a process hold the same memory space, which holds live Python objects.  This allows easy data sharing between threads.  Like proceses threads also enable preemptive multi tasking under the supervision of the OS scheduler.  A thread consumes less resources than a process doing the same job.</p>

<p><strong>Coroutine</strong> - A function that can suspend itself and resume later.  In Python classic coroutines are built from generator functions, and native coroutines are defined with <code class="language-plaintext highlighter-rouge">async def</code>.  Python coroutines usually run wihin a single thread udner the supervision of an event looop, also in the same thread.  Asynchronous programming frameowrks such as asyncio, Curio, or Trio provide an event loop and supporting libraries for nonblocking coroutine based I/O.  Coroutines support cooperative multitasking.  Each coroutine must explicitly seed control with the <code class="language-plaintext highlighter-rouge">yield</code> or <code class="language-plaintext highlighter-rouge">await</code> keyword so that anothe rmay proceed concurrently (but not in parallel).  This means that any blocking code in a coroutine blocks the execution of the event loop and all other coroutines.  In Contrast with the preemptive multitasking supported by processes and threads.  On the other hand, each coroutines consumes less resources than a thread or process doing the same job.</p>

<h3 id="processes-threads-and-pythons-infamous-gil">Processes, Threads, and Python’s Infamous GIL</h3>

<p>Here are the 10 points of how the concepts above Apply to Python.</p>

<ol>
  <li>
    <p>Each instance of the Python interpreter is a process.  You can start additional Python processes usin the <code class="language-plaintext highlighter-rouge">multiprocessing</code> or <code class="language-plaintext highlighter-rouge">concurrent.futures</code> libraries.  Python’s <code class="language-plaintext highlighter-rouge">subprocess</code> library is designed to launch processes to run external programs, regardless of the languages used to write them.</p>
  </li>
  <li>
    <p>The Python interpreter uses a single thread to run the user’s program and the memory garbage colector.  You can start additional Python threads using the <code class="language-plaintext highlighter-rouge">threading</code> or <code class="language-plaintext highlighter-rouge">concurrent.futures</code> libraries.</p>
  </li>
  <li>
    <p>Access to object reference counts and other internal interpretr state is controlled by a lock, the Global Interpreter Lock (GIL).  Only one Python thread can hold the GIL at any time.  This means that only one thread can execute Python code at any time, regardless of the number of CPU cores.</p>
  </li>
  <li>
    <p>To prevent a Python thread from holding the GIL indefinitely, Python’s bytecode interpreter pauses the current Python thread every 5ms by default, releasing the GIL.  The thread can try to reacquire the GIL, but if there are other threads waiting for it, the OS scheduler may pick one of them to proceed.</p>
  </li>
  <li>
    <p>When we write Python code, we have no control over the GIL.  A build-in funciton or an extension written in C or any language that interfaces at the Python/C API level - can release the GIL while running time consuming tasks.</p>
  </li>
  <li>
    <p>Every Python standard library function taht makes a syscall releases the GIL.  This includes all functions that perfrm disk I/O, network I/O and <code class="language-plaintext highlighter-rouge">time.sleep()</code>.</p>
  </li>
  <li>
    <p>Extensiosn that integrate at the Python/C API level can also launch other non-Python threads that are not effected by the GIL.  Such GIL-free threads generally cannot change Python objects, but they can read from and write to the memory underlying objects that support the buffer protocol such as <code class="language-plaintext highlighter-rouge">bytearray</code>, and <code class="language-plaintext highlighter-rouge">array.array</code></p>
  </li>
  <li>
    <p>Effect of the GIL on network programming with Python threads is relatively small, because the I/O functions release the GIL and reading or writing to the network always implies high latency comared to reading and writing in memory.</p>
  </li>
  <li>
    <p>Contention over GIL slows donw compute intensive Python threads.  Sequential single threaded code is simpler and faster for such tasks.</p>
  </li>
  <li>
    <p>To run CPU-intensive Python coe on multiple cores, you must use multiple Python processes.</p>
  </li>
</ol>

<p>Threading is OK if you are running mutltiple I/O bound tasks but if you need to compute in parallel run multiple Pyton Processes.</p>

<h3 id="a-concurrent-hello-world">A Concurrent Hello World</h3>

<p>Each of the examples below will start a function that blocks for 3 seconds while animating characters in the terminal to let the user know that the program is “thinking” and not stalled.  The script makes an nimated spinner displaying each echarecter in the string “|/-“ in the same screen position.  When the slow computation finishes, the line with the spinner is cleared and ansser of 42 is shown.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">Event</span>

<span class="c1"># This function will run in a separate thread.  The done argument is an instance of threading.Event a simple object to synchronize threads.
</span><span class="k">def</span> <span class="nf">spin</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">done</span><span class="p">:</span> <span class="n">Event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>  
    <span class="c1"># This is an infinite loop because itertools.cyle yields one character at a time, cycling through the string forever.
</span>    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">itertools</span><span class="p">.</span><span class="n">cycle</span><span class="p">(</span><span class="sa">r</span><span class="s">'\|/-'</span><span class="p">):</span>
        <span class="c1"># The trick for text-mode animation: move the cursor back to the start of the line with the carriage return ASCII control character '\r'  
</span>        <span class="n">status</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'</span><span class="se">\r</span><span class="si">{</span><span class="n">char</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s">'</span>  
        <span class="k">print</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># The Event.wait(timeout=None) method returns True when the event is set by another thread; if the timeout elapses, it returns False.  The .1s timeout sests the "frame rate" of the animation to 10 FPS.  
</span>        <span class="k">if</span> <span class="n">done</span><span class="p">.</span><span class="n">wait</span><span class="p">(.</span><span class="mi">1</span><span class="p">):</span>  
            <span class="k">break</span> <span class="c1"># Exit the infinite loop 
</span>    <span class="n">blanks</span> <span class="o">=</span> <span class="s">' '</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="se">\r</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="se">\r</span><span class="s">'</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span> <span class="c1"># Clear the status line by overwriting with spacesa nd moving the cursor back to the beginning. 
</span>
<span class="k">def</span> <span class="nf">slow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="c1"># slow() will be called by the main thread.  Imagine this is a slow API call over the network.  Calling sleep blocks the main thread, but the GIL is released so the spinner thread can proceed.
</span>    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  
    <span class="k">return</span> <span class="mi">42</span>
</code></pre></div></div>

<p>The first important insight of this example is that <code class="language-plaintext highlighter-rouge">time.sleep()</code> bloks the calling thread but releases the GIL, allowing other python threads to run.</p>

<p>The <code class="language-plaintext highlighter-rouge">spin</code> and <code class="language-plaintext highlighter-rouge">slow</code> functions will execute concurrently.  The main thread - thre only thread when the program starts - will start a new thread to run <code class="language-plaintext highlighter-rouge">spin</code> and then call <code class="language-plaintext highlighter-rouge">slow</code>.  By desing, there is no API for terminating a thread in Python.  You must send it a message to shut down.</p>

<p>The <code class="language-plaintext highlighter-rouge">threading.Event</code> class is Python’s simplest signalling mechanism to coordinate threads.  An <code class="language-plaintext highlighter-rouge">Event</code> instance has an internal boolean flag that starts as <code class="language-plaintext highlighter-rouge">False</code>.  Calling <code class="language-plaintext highlighter-rouge">Event.set()</code> sets the flag to <code class="language-plaintext highlighter-rouge">True</code>.  While the flag is false, if a thread calls <code class="language-plaintext highlighter-rouge">Event.wait()</code>, it is blocked until another thread calls <code class="language-plaintext highlighter-rouge">Event.set()</code>, at which time <code class="language-plaintext highlighter-rouge">Event.wait()</code> returns <code class="language-plaintext highlighter-rouge">True</code>.  If a timeout in seconds is given to <code class="language-plaintext highlighter-rouge">Event.wait(s)</code>, this call returns <code class="language-plaintext highlighter-rouge">False</code> when the timeout elapses, or returns <code class="language-plaintext highlighter-rouge">True</code> as soon as <code class="language-plaintext highlighter-rouge">Event.set()</code> is called by another thread.</p>

<p>The <code class="language-plaintext highlighter-rouge">supervisor</code> function listed in example below uses an <code class="language-plaintext highlighter-rouge">Event</code> to signal the <code class="language-plaintext highlighter-rouge">spin</code> function to exit.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">supervisor</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>  <span class="c1"># supervisor will return the result of slow
</span>    <span class="n">done</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>  <span class="c1"># The threading.Event instance is the key to coordinate the activities of the main thread and the spinner thread as expained further down.
</span>    <span class="c1"># To create new Thread, provide a function as the target keyword argument, and positional arguments to the target as a tuple passed via args.
</span>    <span class="n">spinner</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s">'thinking!'</span><span class="p">,</span> <span class="n">done</span><span class="p">))</span>
    <span class="c1"># Display the spinner object.  The output if &lt;Thread(Thread-1, initial)&gt; where initial is the state of the thread meaning it has not started.
</span>    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'spinner object: </span><span class="si">{</span><span class="n">spinner</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
    <span class="n">spinner</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>  <span class="c1"># start the spinner thread
</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">slow</span><span class="p">()</span>  <span class="c1"># Call slow which blocks the main thread.  Meanwhile, the secondary thread is running the spinner animation.
</span>    <span class="n">done</span><span class="p">.</span><span class="nb">set</span><span class="p">()</span>  <span class="c1"># Set the Event flag to True; this will terminat the for loop inside the spin function.
</span>    <span class="n">spinner</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>  <span class="c1"># Wait until the spinner thread finishes
</span>    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">supervisor</span><span class="p">()</span>  <span class="c1"># Run the supervisor function.  
</span>    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Answer: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
<span class="c1"># WHen the main thread sets the done event, the spinner thread will eventually notice and exit cleanly.
</span></code></pre></div></div>

<h3 id="spinner-with-processes">Spinner with Processes</h3>

<p>The <code class="language-plaintext highlighter-rouge">multiprocessing</code> package supports running concurent tasks in separate Python processes instead of threads.  When you create a <code class="language-plaintext highlighter-rouge">multiprocess.Process</code> instance, a whole new Python interpreter is started as a child process in the background.  Since each process has its own GIL, this allows your prgram to use all available CPU cores.  There will be a better example of this later (home grown process pool) but the simple example is below.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="c1"># The basic multiprocessing API imitates the threading API, but type hints and Mypy expose the difference:
# multiprocessing.Event is a function (not a class like threading.Event) which returns a synchronize.Event instance
# forcing us to import multiprocessing.synchronize
</span><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Event</span>  
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">synchronize</span>     

<span class="k">def</span> <span class="nf">spin</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">done</span><span class="p">:</span> <span class="n">synchronize</span><span class="p">.</span><span class="n">Event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>  

<span class="c1"># [snip] the rest of spin and slow functions are unchanged from spinner_thread.py
</span>
<span class="k">def</span> <span class="nf">supervisor</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">done</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
    <span class="c1"># Basic usage of the Process class is similar to Thread
</span>    <span class="n">spinner</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span>               
                      <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s">'thinking!'</span><span class="p">,</span> <span class="n">done</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'spinner object: </span><span class="si">{</span><span class="n">spinner</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>          
    <span class="n">spinner</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">slow</span><span class="p">()</span>
    <span class="n">done</span><span class="p">.</span><span class="nb">set</span><span class="p">()</span>
    <span class="n">spinner</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="c1"># [snip] main function is unchanged as well
</span></code></pre></div></div>

<h3 id="spinner-with-coroutines">Spinner with Coroutines</h3>

<p>Chapter 21 will do a deep dive into asynchronous programming with coroutines.  This is just a high level introduction to contrast this approach with the threads and processes approach.</p>

<p>Unlike threads and processes where the OS does the scheduling of resources coroutines are driven by an application-level event lopp that manages a queue of pending coroutines, drives them one by one, monitors events triggered by I/O operations initiated by coroutines, and passes control back to the corresponding coroutine when each event happens.  The event loop and the library coroutines and the user coroutines all execute in a single thread therefor any time spend in a coroutine slows down the event loop and all other coroutines.</p>

<p>Coroutine version of spinner program is below…</p>

<p>Note that spin and slow coroutines are further down in the notes because this book sucks a building on things.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>  <span class="c1"># main is the only regular function in this program the rest are coroutines.
</span>    <span class="c1"># The asyncio.run function start the event loop to drive the coroutine that will eventually set the other coroutines in motion.
</span>    <span class="c1"># The main function will stay blocked until supervisor returns.The return value of supervisor will bet the return value of asyncio.run
</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">supervisor</span><span class="p">())</span> 
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Answer: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">supervisor</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>  <span class="c1"># native corourines are defined with async def
</span>    <span class="c1"># asyncio.create_task shedules the eventual execution of spin, immediately returning an instance of asyncio.Task.
</span>    <span class="n">spinner</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">spin</span><span class="p">(</span><span class="s">'thinking!'</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'spinner object: </span><span class="si">{</span><span class="n">spinner</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>  
    <span class="c1"># The await keyword calls slow blocking supervisor until slow returns.  The return value of slow will be assigned to result.
</span>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">slow</span><span class="p">()</span>  
    <span class="c1"># The Task.cancel method raises a CancelledError exception inside the spin coroutine
</span>    <span class="n">spinner</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>  
    <span class="k">return</span> <span class="n">result</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p>The above example demonstrates the three ways of running a coroutine:</p>

<p><code class="language-plaintext highlighter-rouge">asyncio.run(coro())</code> - Called from a regular function to drive a coroutine object that usually is the entry point for all the asynchronous code in the program, like the <code class="language-plaintext highlighter-rouge">supervisor</code> in this example.  This call blocks until the body of <code class="language-plaintext highlighter-rouge">coro</code> returns.  The return value of the <code class="language-plaintext highlighter-rouge">run()</code> call is whatever the body of the <code class="language-plaintext highlighter-rouge">coro</code> returns.</p>

<p><code class="language-plaintext highlighter-rouge">asyncio.create_task(coro())</code> - Called from a coroutine to shedule another coroutine to execute eventually.  This call does not susupend the current coroutine.  It returns a Task instance, an object that wraps the coroutine object and provides methods to control and query its state.</p>

<p><code class="language-plaintext highlighter-rouge">await coro()</code> - Called from a coroutine to transfer control to the coroutine object returned by <code class="language-plaintext highlighter-rouge">coro()</code>.  This suspends the current coroutine until the body of the <code class="language-plaintext highlighter-rouge">coro</code> returns.  The value of the await expression is whatever the body of the coro returns.</p>

<p>Below are the spin and slow coroutines which were called on in the exmple above.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="c1"># We don't need the Event argument that was used to signal that slow had completed its job in thread based spinner.
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">spin</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>  
    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">itertools</span><span class="p">.</span><span class="n">cycle</span><span class="p">(</span><span class="sa">r</span><span class="s">'\|/-'</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'</span><span class="se">\r</span><span class="si">{</span><span class="n">char</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s">'</span>
        <span class="k">print</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># use await asyncio.sleep(.1) instead of time.sleep(.1), to pause without blocking other coroutines.  
</span>            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(.</span><span class="mi">1</span><span class="p">)</span>  
        <span class="c1"># asyncio.CancelledError is raised when the cancel method is called on the Task controlling this coroutine.  Time to exit the loop.
</span>        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>  
            <span class="k">break</span>
    <span class="n">blanks</span> <span class="o">=</span> <span class="s">' '</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="se">\r</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="se">\r</span><span class="s">'</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">slow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="c1"># The slow coroutine also uses await asyncio.sleep instead of time.sleep.
</span>    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  
    <span class="k">return</span> <span class="mi">42</span>
</code></pre></div></div>

<p>An expriment the book suggests is to import time and instead of await asyncio.sleep(3) call time.sleep(3) as in code below.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">slow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">42</span>
</code></pre></div></div>

<p>What you should see is that the spinner never appears, the program waits for 3 seconds and returns the 42 answer.  To understand why we see this behaviour recall that <code class="language-plaintext highlighter-rouge">asyncio</code> has only one flow of execution, unless you explicitly start additional threads or processes.  That means only one coroutine executes at any point in time.  Concurrency is achieved by control passing from one coroutine to another.</p>

<p>Never use <code class="language-plaintext highlighter-rouge">time.sleep</code> in <code class="language-plaintext highlighter-rouge">asyncio</code> coroutines unless you want to pause your whole program.  If a coroutine needs to spend some time doing nothing, it should <code class="language-plaintext highlighter-rouge">await asyncio.sleep(DELAY)</code>.  This yields control back to the <code class="language-plaintext highlighter-rouge">asyncio</code> event loop, which can drive other pending coroutines.</p>

<p>There is a <code class="language-plaintext highlighter-rouge">greenlet</code> package that has been around for many years and used at scale.  It supports cooperative multitasking though lightweight corroutines called <code class="language-plaintext highlighter-rouge">greenlets</code> that don’t requrie specail syntax such as <code class="language-plaintext highlighter-rouge">yield</code> or <code class="language-plaintext highlighter-rouge">await</code>, and is therefor easier to integrate into existing, sequential codebases. (SQL Alchemy 1.4 uses greenlets) internally to implement its asynchronous API compatible with <code class="language-plaintext highlighter-rouge">asyncio</code></p>

<p>The <code class="language-plaintext highlighter-rouge">gevent</code> networking library monkey patches Python’s standard <code class="language-plaintext highlighter-rouge">socket</code> module making it nonblocking by replacing some of its code with <code class="language-plaintext highlighter-rouge">greenlets</code>.  To a large extend <code class="language-plaintext highlighter-rouge">gevent</code> is transparent to the surrouning code making it easier to adapt sequential applicaitons and libraries to perform concurrent networki I/O.  Gunicorn uses gevent.</p>

<p>With coroutines you have to call <code class="language-plaintext highlighter-rouge">await</code> give up control and let the rest of the program run.  By definition a coroutine can only be cancelled when its suspended at an <code class="language-plaintext highlighter-rouge">await</code> expression, so you can perform cleanup by handling the <code class="language-plaintext highlighter-rouge">CancelledError</code> exception.</p>

<h3 id="a-homegrown-process-pool">A Homegrown Process Pool</h3>

<p>Code below is a good exampel of how to time the prime calcuation running.  No threading stuff yet other than this example being used later.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="s">"""
sequential.py: baseline for comparing sequential, multiprocessing,
and threading code for CPU-intensive work.
"""</span>

<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">perf_counter</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NamedTuple</span>

<span class="kn">from</span> <span class="nn">primes</span> <span class="kn">import</span> <span class="n">is_prime</span><span class="p">,</span> <span class="n">NUMBERS</span>

<span class="k">class</span> <span class="nc">Result</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>  
    <span class="n">prime</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">elapsed</span><span class="p">:</span> <span class="nb">float</span>

<span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>  
    <span class="n">t0</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">prime</span> <span class="o">=</span> <span class="n">is_prime</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Result</span><span class="p">(</span><span class="n">prime</span><span class="p">,</span> <span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Checking </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">NUMBERS</span><span class="p">)</span><span class="si">}</span><span class="s"> numbers sequentially:'</span><span class="p">)</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">NUMBERS</span><span class="p">:</span>  
        <span class="n">prime</span><span class="p">,</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="n">check</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s">'P'</span> <span class="k">if</span> <span class="n">prime</span> <span class="k">else</span> <span class="s">' '</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">n</span><span class="p">:</span><span class="mi">16</span><span class="si">}</span><span class="s">  </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">elapsed</span><span class="p">:</span><span class="mf">9.6</span><span class="n">f</span><span class="si">}</span><span class="s">s'</span><span class="p">)</span>

    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>  
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Total time: </span><span class="si">{</span><span class="n">elapsed</span><span class="p">:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p>The example below shows the use of multiple processes to distribute the primality checks across multiple CPU cores.</p>

<p>sample output…</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python3 procs.py
Checking 20 numbers with 12 processes:
               2  P  0.000002s
3333333333333333     0.000021s
4444444444444444     0.000002s
5555555555555555     0.000018s
6666666666666666     0.000002s
 142702110479723  P  1.350982s
7777777777777777     0.000009s
 299593572317531  P  1.981411s
9999999999999999     0.000008s
3333333333333301  P  6.328173s
3333335652092209     6.419249s
4444444488888889     7.051267s
4444444444444423  P  7.122004s
5555553133149889     7.412735s
5555555555555503  P  7.603327s
6666666666666719  P  7.934670s
6666667141414921     8.017599s
7777777536340681     8.339623s
7777777777777753  P  8.388859s
9999999999999917  P  8.117313s
20 checks <span class="k">in </span>9.58s
</code></pre></div></div>

<p>Because we are delegating to threads/processes our code does not call the worker function directly and thus we can’t just get a return value.  Instead the working is driven by the thread process library, and it eventually produces a result that needs to be stored somewhere.  Coordinating workers and collecting results are common uses of queues in concurrent programming and distrubuted systems.</p>

<p>Much of the cod in example below deals with setting up and using queues.</p>

<p>The <code class="language-plaintext highlighter-rouge">worker</code> function in example below follows a common pattern in concurrent programming: looping indefinitely while taking items from a queue and processing each with a function that does the actual work. The loop ends when the queue produces a sentinel value. In this pattern, the sentinel that shuts down the worker is often called a “poison pill.”  Other vible options for sentinal values are None, <code class="language-plaintext highlighter-rouge">Ellipsis</code> build in object (a.k.a <code class="language-plaintext highlighter-rouge">...</code>) which can survive being serialized without loosing its identity as object if pickled.dumped and pickle.loadd will be different from original object and not pass an equality check.</p>

<p>If the main process exits before all subprocesses are done, you may see confusing tracebacks on FileNotFoundError exceptions caused by an internal lock in multiprocessing. Debugging concurrent code is always hard, and debugging multiprocessing is even harder because of all the complexity behind the thread-like façade. Fortunately, the ProcessPoolExecutor we’ll meet in Chapter 20 is easier to use and more robust.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">perf_counter</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NamedTuple</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">SimpleQueue</span><span class="p">,</span> <span class="n">cpu_count</span>  
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">queues</span>  <span class="c1"># queues has the SimpleQueue class we need for type hints
</span>
<span class="kn">from</span> <span class="nn">primes</span> <span class="kn">import</span> <span class="n">is_prime</span><span class="p">,</span> <span class="n">NUMBERS</span>

<span class="k">class</span> <span class="nc">PrimeResult</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>  
    <span class="n">n</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">prime</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">elapsed</span><span class="p">:</span> <span class="nb">float</span>

<span class="c1"># This is a type alias for SimpleQueue that that the main function will use to send numbers to the processes
# that will do the work.
</span><span class="n">JobQueue</span> <span class="o">=</span> <span class="n">queues</span><span class="p">.</span><span class="n">SimpleQueue</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
<span class="c1"># Type alias for a second SimpleQueu that will collect the results in main.  
# The values in the queue will be tuples made of the number to be tested for primality and a Result tuple.
</span><span class="n">ResultQueue</span> <span class="o">=</span> <span class="n">queues</span><span class="p">.</span><span class="n">SimpleQueue</span><span class="p">[</span><span class="n">PrimeResult</span><span class="p">]</span>  

<span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PrimeResult</span><span class="p">:</span>  
    <span class="n">t0</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">is_prime</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">PrimeResult</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>

<span class="c1"># worker gets a queue with the numbers to be checked, and another to put results.
</span><span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="n">jobs</span><span class="p">:</span> <span class="n">JobQueue</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">ResultQueue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>  
    <span class="c1"># In this code, 0 is a poison pill: a signal for the worker to finish if n is not 0 proceed with loop.
</span>    <span class="k">while</span> <span class="n">n</span> <span class="p">:</span><span class="o">=</span> <span class="n">jobs</span><span class="p">.</span><span class="n">get</span><span class="p">():</span>  
        <span class="n">results</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">check</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>  <span class="c1"># invoke primality check and enqueue prime result.
</span>    <span class="c1"># Send back a PrimeResult(0, False, 0.0) to le the main loop know that this worker is done.
</span>    <span class="n">results</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">PrimeResult</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>  

<span class="k">def</span> <span class="nf">start_jobs</span><span class="p">(</span>
    <span class="c1"># procs is the number of processes that will compute the prime checks in parallel.
</span>    <span class="n">procs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">jobs</span><span class="p">:</span> <span class="n">JobQueue</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">ResultQueue</span>  
<span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">NUMBERS</span><span class="p">:</span>
        <span class="n">jobs</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>  <span class="c1"># Enqueue the numbers to be checked in jobs
</span>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">procs</span><span class="p">):</span>
        <span class="c1"># Fork a child process for each worker.  Each child will run the loop inside its own instance of the worker function, until it fetches a 0 from the jobs queue.
</span>        <span class="n">proc</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="n">results</span><span class="p">))</span>  
        <span class="n">proc</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>  <span class="c1"># start the child process
</span>        <span class="n">jobs</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Enqueue one 0 for each process, to terminate them.
</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>  
        <span class="n">procs</span> <span class="o">=</span> <span class="n">cpu_count</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">procs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Checking </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">NUMBERS</span><span class="p">)</span><span class="si">}</span><span class="s"> numbers with </span><span class="si">{</span><span class="n">procs</span><span class="si">}</span><span class="s"> processes:'</span><span class="p">)</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">jobs</span><span class="p">:</span> <span class="n">JobQueue</span> <span class="o">=</span> <span class="n">SimpleQueue</span><span class="p">()</span>  
    <span class="n">results</span><span class="p">:</span> <span class="n">ResultQueue</span> <span class="o">=</span> <span class="n">SimpleQueue</span><span class="p">()</span>
    <span class="n">start_jobs</span><span class="p">(</span><span class="n">procs</span><span class="p">,</span> <span class="n">jobs</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>  
    <span class="n">checked</span> <span class="o">=</span> <span class="n">report</span><span class="p">(</span><span class="n">procs</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>  
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">checked</span><span class="si">}</span><span class="s"> checks in </span><span class="si">{</span><span class="n">elapsed</span><span class="p">:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s'</span><span class="p">)</span>  

<span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="n">procs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">ResultQueue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span> 
    <span class="n">checked</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">procs_done</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">procs_done</span> <span class="o">&lt;</span> <span class="n">procs</span><span class="p">:</span>  
        <span class="n">n</span><span class="p">,</span> <span class="n">prime</span><span class="p">,</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="n">results</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>  
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  
            <span class="n">procs_done</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">checked</span> <span class="o">+=</span> <span class="mi">1</span>  
            <span class="n">label</span> <span class="o">=</span> <span class="s">'P'</span> <span class="k">if</span> <span class="n">prime</span> <span class="k">else</span> <span class="s">' '</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">n</span><span class="p">:</span><span class="mi">16</span><span class="si">}</span><span class="s">  </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">elapsed</span><span class="p">:</span><span class="mf">9.6</span><span class="n">f</span><span class="si">}</span><span class="s">s'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">checked</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="some-system-design-ways-of-bypassing-gil">Some system design ways of bypassing GIL</h3>

<p>Use an applicaitons server such as mod wsgi, uWSGI, Gunicorn or NGINX Unit in front of the python app so that it sends the request to a Python thread and you don’t deal with the asyncio stuff.</p>

<p>WSGI is a synchronous API. It doesn’t support coroutines with async/await—the most efficient way to implement WebSockets or HTTP long polling in Python. The ASGI specification is a successor to WSGI, designed for asynchronous Python web frameworks such as aiohttp, Sanic, FastAPI, etc., as well as Django and Flask, which are gradually adding asynchronous functionality.</p>

<p>Distributed Task Queues are another option.  Some example are Celery and RQ.</p>

<h2 id="chapter-20-concurrent-executors">Chapter 20 Concurrent Executors</h2>

<p>This chapter focuses on <code class="language-plaintext highlighter-rouge">concurrent.futures.Executor</code> classes that encapsulate the pattern of “spawning a bunch of independent threads and collecting the results in a queue”.</p>

<p>The examples we will ocver will be a script that grabs pictures of country flags over the web.  The examples in this chapter will be the sequential version adn the much faster running threaded one using the futures library.  The asyncio version will be covered in the next chapter.  Two points being made here are that you will see much better performance in network I/O opertations if you use multiple processes and for HTTP processes that make multiple requests it does not matter much if you use coroutines or thrads.</p>

<p>Below is the sequential download script</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>

<span class="kn">import</span> <span class="nn">httpx</span>  

<span class="n">POP20_CC</span> <span class="o">=</span> <span class="p">(</span><span class="s">'CN IN US ID BR PK NG BD RU JP '</span>
            <span class="s">'MX PH VN ET EG DE IR TR CD FR'</span><span class="p">).</span><span class="n">split</span><span class="p">()</span>  

<span class="n">BASE_URL</span> <span class="o">=</span> <span class="s">'https://www.fluentpython.com/data/flags'</span>  
<span class="n">DEST_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s">'downloaded'</span><span class="p">)</span>                         

<span class="k">def</span> <span class="nf">save_flag</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>     
    <span class="p">(</span><span class="n">DEST_DIR</span> <span class="o">/</span> <span class="n">filename</span><span class="p">).</span><span class="n">write_bytes</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_flag</span><span class="p">(</span><span class="n">cc</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>  
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">cc</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">cc</span><span class="si">}</span><span class="s">.gif'</span><span class="p">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">6.1</span><span class="p">,</span>       
                     <span class="n">follow_redirects</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  
    <span class="n">resp</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>  
    <span class="k">return</span> <span class="n">resp</span><span class="p">.</span><span class="n">content</span>

<span class="k">def</span> <span class="nf">download_many</span><span class="p">(</span><span class="n">cc_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>  
    <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cc_list</span><span class="p">):</span>                 
        <span class="n">image</span> <span class="o">=</span> <span class="n">get_flag</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
        <span class="n">save_flag</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">cc</span><span class="si">}</span><span class="s">.gif'</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">' '</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>         
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">cc_list</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">downloader</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>  
    <span class="n">DEST_DIR</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>                          
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>                               
    <span class="n">count</span> <span class="o">=</span> <span class="n">downloader</span><span class="p">(</span><span class="n">POP20_CC</span><span class="p">)</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="se">\n</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s"> downloads in </span><span class="si">{</span><span class="n">elapsed</span><span class="p">:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">(</span><span class="n">download_many</span><span class="p">)</span>     
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">httpx</code> library is inspired by requests package, but it provides synchronous and asynchronous APIs so usable in the coming threaded examples.</p>

<p>The examples below is downloading flags using <code class="language-plaintext highlighter-rouge">concurrent.futures</code></p>

<p>The main features of the <code class="language-plaintext highlighter-rouge">concurrent.futures</code> package are the ThreadPoolExecutor and ProcessPoolExecutor classes, which implement an API to submit callables for execution in different threads or processes, respectively. The classes transparently manage a pool of worker threads or processes, and queues to distribute jobs and collect results. But the interface is very high-level, and we don’t need to know about any of those details for a simple use case like our flag downloads.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">concurrent</span> <span class="kn">import</span> <span class="n">futures</span>

<span class="kn">from</span> <span class="nn">flags</span> <span class="kn">import</span> <span class="n">save_flag</span><span class="p">,</span> <span class="n">get_flag</span><span class="p">,</span> <span class="n">main</span>  

<span class="k">def</span> <span class="nf">download_one</span><span class="p">(</span><span class="n">cc</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>  
    <span class="n">image</span> <span class="o">=</span> <span class="n">get_flag</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
    <span class="n">save_flag</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">cc</span><span class="si">}</span><span class="s">.gif'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">' '</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cc</span>

<span class="k">def</span> <span class="nf">download_many</span><span class="p">(</span><span class="n">cc_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="c1"># Instantiate the ThreadPoolExecutor as a context manager; the executer.__exit__ method will call executor.shutdown(wait=True)
</span>    <span class="c1"># which will block untill all threads are done.
</span>    <span class="k">with</span> <span class="n">futures</span><span class="p">.</span><span class="n">ThreadPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>         
        <span class="c1"># The map method is similar to the map built-in except that the download_one function will be called concurrently
</span>        <span class="c1"># from multiple threads; it returns a generator that you can iterate to retrieve the valeu returned by each function call.
</span>        <span class="c1"># in this case, each call to download_one will return a country code.
</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">executor</span><span class="p">.</span><span class="nb">map</span><span class="p">(</span><span class="n">download_one</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cc_list</span><span class="p">))</span>  

    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>                                  

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">(</span><span class="n">download_many</span><span class="p">)</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">ThreadPoolExecutor</code> constructor takes several arguments not shown, but the first and most important one is <code class="language-plaintext highlighter-rouge">max_workers</code>, setting the maximum number of worker threads to be executed. When <code class="language-plaintext highlighter-rouge">max_workers</code> is None (the default), <code class="language-plaintext highlighter-rouge">ThreadPool​Executor</code> decides its value using the following expression—since Python 3.8: <code class="language-plaintext highlighter-rouge">max_workers = min(32, os.cpu_count() + 4)</code></p>

<h3 id="what-are-the-futures">What are the Futures?</h3>

<p>Do not create futures.  They are meant to be instantiated exclusively by the concurrency framework be it <code class="language-plaintext highlighter-rouge">concurrent.futures</code> or <code class="language-plaintext highlighter-rouge">asyncio</code>.  The reason why is a <code class="language-plaintext highlighter-rouge">Future</code> represents something that is scheduled to run, therefore it must be scheduled to run, and that’the job of the framework.</p>

<p>Both type of <code class="language-plaintext highlighter-rouge">Future</code> have a <code class="language-plaintext highlighter-rouge">.done()</code> method that is nonblocking and returns a Boolean that tells you wheter the callable wrapped by that future has executed or not.  There is also the <code class="language-plaintext highlighter-rouge">add_done_callback()</code> so that you don’t have to keep checking if the future is done.</p>

<p>Below is a rewrid of the flag example using <code class="language-plaintext highlighter-rouge">concurrent.futures.as_completed</code>.  Only the download_many function needs to be updated so we display it here.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">download_many</span><span class="p">(</span><span class="n">cc_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">cc_list</span> <span class="o">=</span> <span class="n">cc_list</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>  
    <span class="k">with</span> <span class="n">futures</span><span class="p">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>  
        <span class="n">to_do</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">futures</span><span class="p">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># sorting here just to make it clear that results will arrive out of order.
</span>        <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cc_list</span><span class="p">):</span>
            <span class="c1"># executor.submit schedules the callable to be executed, and returns a future representing this pending operation.
</span>            <span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="p">.</span><span class="n">submit</span><span class="p">(</span><span class="n">download_one</span><span class="p">,</span> <span class="n">cc</span><span class="p">)</span>
            <span class="c1"># store each future so we can later retrieve it as completed.
</span>            <span class="n">to_do</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>  
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Scheduled for </span><span class="si">{</span><span class="n">cc</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">future</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>  

        <span class="c1"># as_completed yields futures as they are completed.
</span>        <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">future</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">futures</span><span class="p">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">to_do</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>  
            <span class="n">res</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">future</span><span class="p">.</span><span class="n">result</span><span class="p">()</span>  <span class="c1"># get the result of the future
</span>            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">future</span><span class="si">}</span><span class="s"> result: </span><span class="si">{</span><span class="n">res</span><span class="err">!</span><span class="n">r</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>  

    <span class="k">return</span> <span class="n">count</span>
</code></pre></div></div>

<p>Below is the prime finder code from earlier rewritten with <code class="language-plaintext highlighter-rouge">ProcessPoolExecutor</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">concurrent</span> <span class="kn">import</span> <span class="n">futures</span>  
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">perf_counter</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NamedTuple</span>

<span class="kn">from</span> <span class="nn">primes</span> <span class="kn">import</span> <span class="n">is_prime</span><span class="p">,</span> <span class="n">NUMBERS</span>

<span class="k">class</span> <span class="nc">PrimeResult</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>  
    <span class="n">n</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">flag</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">elapsed</span><span class="p">:</span> <span class="nb">float</span>

<span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PrimeResult</span><span class="p">:</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">is_prime</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">PrimeResult</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">workers</span> <span class="o">=</span> <span class="bp">None</span>      
    <span class="k">else</span><span class="p">:</span>
        <span class="n">workers</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">executor</span> <span class="o">=</span> <span class="n">futures</span><span class="p">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">workers</span><span class="p">)</span>  
    <span class="n">actual_workers</span> <span class="o">=</span> <span class="n">executor</span><span class="p">.</span><span class="n">_max_workers</span>  <span class="c1"># type: ignore  
</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Checking </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">NUMBERS</span><span class="p">)</span><span class="si">}</span><span class="s"> numbers with </span><span class="si">{</span><span class="n">actual_workers</span><span class="si">}</span><span class="s"> processes:'</span><span class="p">)</span>

    <span class="n">t0</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>

    <span class="n">numbers</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">NUMBERS</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  
    <span class="k">with</span> <span class="n">executor</span><span class="p">:</span>  
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">prime</span><span class="p">,</span> <span class="n">elapsed</span> <span class="ow">in</span> <span class="n">executor</span><span class="p">.</span><span class="nb">map</span><span class="p">(</span><span class="n">check</span><span class="p">,</span> <span class="n">numbers</span><span class="p">):</span>  
            <span class="n">label</span> <span class="o">=</span> <span class="s">'P'</span> <span class="k">if</span> <span class="n">prime</span> <span class="k">else</span> <span class="s">' '</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">n</span><span class="p">:</span><span class="mi">16</span><span class="si">}</span><span class="s">  </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">elapsed</span><span class="p">:</span><span class="mf">9.6</span><span class="n">f</span><span class="si">}</span><span class="s">s'</span><span class="p">)</span>

    <span class="n">time</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Total time: </span><span class="si">{</span><span class="n">time</span><span class="p">:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="chapter-21-asynchronous-programming">Chapter 21 Asynchronous Programming</h2>

<p>This chapter covers Python’s <code class="language-plaintext highlighter-rouge">async def</code>, <code class="language-plaintext highlighter-rouge">await</code>, <code class="language-plaintext highlighter-rouge">async with</code>, <code class="language-plaintext highlighter-rouge">async for</code> constructs. Asyncio and other asynchronous libraries.</p>

<h3 id="some-definitions-for-the-chapter">Some definitions for the chapter</h3>

<p><strong>Native coroutine</strong> - A couroutine function defined with async def.  You can delegate from a native coroutine to another native coroutine using the <code class="language-plaintext highlighter-rouge">await</code> keyword.  The <code class="language-plaintext highlighter-rouge">async def</code> statement aways defines a native coroutine, even if the <code class="language-plaintext highlighter-rouge">await</code> keyword is not used in its body.  The <code class="language-plaintext highlighter-rouge">await</code> keyword cannot be used outside of a native coroutine.</p>

<p><strong>Classic coroutine</strong> - A generator function that consumes data sent to it via <code class="language-plaintext highlighter-rouge">my_coro.send(data)</code> calls, and reads that data by using <code class="language-plaintext highlighter-rouge">yield</code> in an expression.  Classic coroutines can delegate to other classic coroutines using <code class="language-plaintext highlighter-rouge">yield from</code>.  Classic coroutines cannot be driven by <code class="language-plaintext highlighter-rouge">await</code>, and are no longer supported by asyncio.</p>

<p><strong>Generator-based coroutine</strong> - A generator funciton decorated with <code class="language-plaintext highlighter-rouge">@types.coroutine</code>.  That decorator makes the generator compatible with the <code class="language-plaintext highlighter-rouge">await</code> keyword.</p>

<p><strong>Asynchronous generator</strong> - A generator function defined with <code class="language-plaintext highlighter-rouge">async def</code> and using <code class="language-plaintext highlighter-rouge">yield</code> in its body.  It returns an asynchronous generator object that provides <code class="language-plaintext highlighter-rouge">__anext__</code>, a coroutine method to retrieve the next item.</p>

<h3 id="an-asyncio-example-probing-domains">An asyncio Example: Probing Domains</h3>

<p>Example below propbes domains to see if they can be resolved.</p>

<p>Output looks something like this where + means domain was resolvable.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python3 blogdom.py
  with.dev
+ <span class="k">elif</span>.dev
+ def.dev
  from.dev
  <span class="k">else</span>.dev
  or.dev
  <span class="k">if</span>.dev
  del.dev
+ as.dev
  none.dev
  pass.dev
  true.dev
+ <span class="k">in</span>.dev
+ <span class="k">for</span>.dev
+ is.dev
+ and.dev
+ try.dev
+ not.dev

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">from</span> <span class="nn">keyword</span> <span class="kn">import</span> <span class="n">kwlist</span>

<span class="n">MAX_KEYWORD_LEN</span> <span class="o">=</span> <span class="mi">4</span>  


<span class="k">async</span> <span class="k">def</span> <span class="nf">probe</span><span class="p">(</span><span class="n">domain</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>  
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">get_running_loop</span><span class="p">()</span>  
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># The loop.getaddrinfo(...) coroutine method returns a five part tuple of parameter sto connect to 
</span>        <span class="c1"># the given address suing a socket.  In this example, we don't need the result.  If we got it means 
</span>        <span class="c1"># the domain resolves otherwise it doesn't.
</span>        <span class="k">await</span> <span class="n">loop</span><span class="p">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>  
    <span class="k">except</span> <span class="n">socket</span><span class="p">.</span><span class="n">gaierror</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>  
    <span class="n">names</span> <span class="o">=</span> <span class="p">(</span><span class="n">kw</span> <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">kwlist</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">MAX_KEYWORD_LEN</span><span class="p">)</span>  
    <span class="n">domains</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">.dev'</span><span class="p">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>  
    <span class="n">coros</span> <span class="o">=</span> <span class="p">[</span><span class="n">probe</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span> <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">domains</span><span class="p">]</span>  
    <span class="k">for</span> <span class="n">coro</span> <span class="ow">in</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">coros</span><span class="p">):</span>  
        <span class="n">domain</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="k">await</span> <span class="n">coro</span>  
        <span class="n">mark</span> <span class="o">=</span> <span class="s">'+'</span> <span class="k">if</span> <span class="n">found</span> <span class="k">else</span> <span class="s">' '</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">mark</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>  
</code></pre></div></div>

<h3 id="new-concept-awaitable">New Concept: Awaitable</h3>

<p>The <code class="language-plaintext highlighter-rouge">for</code> keyword works with <em>iterables</em> the <code class="language-plaintext highlighter-rouge">await</code> keyword works with <em>awaitables</em></p>

<p>As a user of asyncio the two awaitables you will see routines are either native coroutine objects which you get by calling native coroutine functions or an <code class="language-plaintext highlighter-rouge">asyncio.Task</code> which you usually get by passing a coroutine object o <code class="language-plaintext highlighter-rouge">asyncio.create_task()</code></p>

<h2 id="chapter-22-dynamic-attributes-and-properties">Chapter 22 Dynamic Attributes and Properties</h2>

<p>The examples in this chapter process/use the following json.  This is just a small sample of what the json structure is.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w"> </span><span class="nl">"Schedule"</span><span class="p">:</span><span class="w">
  </span><span class="p">{</span><span class="w"> </span><span class="nl">"conferences"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="nl">"serial"</span><span class="p">:</span><span class="w"> </span><span class="mi">115</span><span class="w"> </span><span class="p">}],</span><span class="w">
    </span><span class="nl">"events"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"serial"</span><span class="p">:</span><span class="w"> </span><span class="mi">34505</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Why Schools Don´t Use Open Source to Teach Programming"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"event_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"40-minute conference session"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"time_start"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-23 11:30:00"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"time_stop"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-23 12:10:00"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"venue_serial"</span><span class="p">:</span><span class="w"> </span><span class="mi">1462</span><span class="p">,</span><span class="w">
        </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Aside from the fact that high school programming..."</span><span class="p">,</span><span class="w">
        </span><span class="nl">"website_url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://oscon.com/oscon2014/public/schedule/detail/34505"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"speakers"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">157509</span><span class="p">],</span><span class="w">
        </span><span class="nl">"categories"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"Education"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"speakers"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"serial"</span><span class="p">:</span><span class="w"> </span><span class="mi">157509</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Robert Lefkowitz"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"photo"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
        </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://sharewave.com/"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"position"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CTO"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"affiliation"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Sharewave"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"twitter"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sharewaveteam"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"bio"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Robert ´r0ml´ Lefkowitz is the CTO at Sharewave, a startup..."</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"venues"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"serial"</span><span class="p">:</span><span class="w"> </span><span class="mi">1462</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"F151"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"category"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Conference Venues"</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Below is code for FrozenJSON which demos use of <code class="language-plaintext highlighter-rouge">__getattr__</code> to let you navigate the JSON with dot <code class="language-plaintext highlighter-rouge">.</code> notation.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">json</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="n">raw_feed</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">'data/osconfeed.json'</span><span class="p">))</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="n">feed</span> <span class="o">=</span> <span class="n">FrozenJSON</span><span class="p">(</span><span class="n">raw_feed</span><span class="p">)</span>  
    <span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">feed</span><span class="p">.</span><span class="n">Schedule</span><span class="p">.</span><span class="n">speakers</span><span class="p">)</span>  
    <span class="mi">357</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="n">feed</span><span class="p">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">dict_keys</span><span class="p">([</span><span class="s">'Schedule'</span><span class="p">])</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">feed</span><span class="p">.</span><span class="n">Schedule</span><span class="p">.</span><span class="n">keys</span><span class="p">())</span>  
    <span class="p">[</span><span class="s">'conferences'</span><span class="p">,</span> <span class="s">'events'</span><span class="p">,</span> <span class="s">'speakers'</span><span class="p">,</span> <span class="s">'venues'</span><span class="p">]</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">feed</span><span class="p">.</span><span class="n">Schedule</span><span class="p">.</span><span class="n">items</span><span class="p">()):</span> 
    <span class="p">...</span>     <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">):</span><span class="mi">3</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">abc</span>


<span class="k">class</span> <span class="nc">FrozenJSON</span><span class="p">:</span>
    <span class="s">"""A read-only façade for navigating a JSON-like object
       using attribute notation
    """</span>

    <span class="c1"># The logic here is to add _ to any reserved keywords because that will break using the . notation sequence
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">keyword</span><span class="p">.</span><span class="n">iskeyword</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>  
                <span class="n">key</span> <span class="o">+=</span> <span class="s">'_'</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">__data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>  

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>  
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__data</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>  
        <span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FrozenJSON</span><span class="p">.</span><span class="n">build</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__data</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>  

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__data</span><span class="p">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="c1"># This is an alternate constructor a common use of the @classmetho decorator
</span>    <span class="o">@</span><span class="nb">classmethod</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>  
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">abc</span><span class="p">.</span><span class="n">Mapping</span><span class="p">):</span>  
            <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">abc</span><span class="p">.</span><span class="n">MutableSequence</span><span class="p">):</span>  
            <span class="k">return</span> <span class="p">[</span><span class="n">cls</span><span class="p">.</span><span class="n">build</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  
            <span class="k">return</span> <span class="n">obj</span>    
</code></pre></div></div>

<p>Recall that the <code class="language-plaintext highlighter-rouge">__getattr__</code> special method is only invoked by the interpreter when the usual process failt to retrieve an attribute (i.e when the named attribute cannot be found in class or inheritence chain)</p>

<h3 id="flexible-object-creation-with-new">Flexible Object Creation with <strong>new</strong></h3>

<p>We often refer to <code class="language-plaintext highlighter-rouge">__init__</code> as the constructor method, but that’s because we adopted jargon from other languages. In Python, <code class="language-plaintext highlighter-rouge">__init__</code> gets self as the first argument, therefore the object already exists when <code class="language-plaintext highlighter-rouge">__init__</code> is called by the interpreter. Also, <code class="language-plaintext highlighter-rouge">__init__</code> cannot return anything. So it’s really an initializer, not a constructor.</p>

<p>If necessary, the <code class="language-plaintext highlighter-rouge">__new__</code> method can also return an instance of a different class. When that happens, the interpreter does not call <code class="language-plaintext highlighter-rouge">__init__</code>. In other words, Python’s logic for building an object is similar to this pseudocode:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># pseudocode for object construction
</span><span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="n">the_class</span><span class="p">,</span> <span class="n">some_arg</span><span class="p">):</span>
    <span class="n">new_object</span> <span class="o">=</span> <span class="n">the_class</span><span class="p">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">some_arg</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_object</span><span class="p">,</span> <span class="n">the_class</span><span class="p">):</span>
        <span class="n">the_class</span><span class="p">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">new_object</span><span class="p">,</span> <span class="n">some_arg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_object</span>

<span class="c1"># the following statements are roughly equivalent
</span><span class="n">x</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">(</span><span class="s">'bar'</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">make</span><span class="p">(</span><span class="n">Foo</span><span class="p">,</span> <span class="s">'bar'</span><span class="p">)</span>
</code></pre></div></div>

<p>Below is the FrozenJSON with the logic of build moved to <code class="language-plaintext highlighter-rouge">__new__</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">abc</span>
<span class="kn">import</span> <span class="nn">keyword</span>

<span class="k">class</span> <span class="nc">FrozenJSON</span><span class="p">:</span>
    <span class="s">"""A read-only façade for navigating a JSON-like object
       using attribute notation
    """</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>  
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">abc</span><span class="p">.</span><span class="n">Mapping</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">().</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>  
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">abc</span><span class="p">.</span><span class="n">MutableSequence</span><span class="p">):</span>  
            <span class="k">return</span> <span class="p">[</span><span class="n">cls</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">arg</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">keyword</span><span class="p">.</span><span class="n">iskeyword</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">+=</span> <span class="s">'_'</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">__data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__data</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FrozenJSON</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__data</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>  

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__data</span><span class="p">.</span><span class="n">keys</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="computed-properties">Computed Properties</h3>

<p>The Python standard library provides classes where each instance has an arbitrary set of attributes built from keyword arguments given to <code class="language-plaintext highlighter-rouge">__init__</code>: <code class="language-plaintext highlighter-rouge">types.SimpleNamespace</code>, <code class="language-plaintext highlighter-rouge">argparse.Namespace</code>, and <code class="language-plaintext highlighter-rouge">multiprocessing.managers.Namespace</code>.  Worth looking these up and experimenting.</p>

<p>One use of the <code class="language-plaintext highlighter-rouge">@staticmethod</code> decorator is to make it exlicit that results of method are not implacted by state or data in the class.</p>

<p>Below is an exmaple of a computed property.  Essentially you can use the <code class="language-plaintext highlighter-rouge">@property</code> decorator to create a function that will return a computed value instead of a class attribute.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Event</span><span class="p">(</span><span class="n">Record</span><span class="p">):</span>  

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s">'&lt;</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="err">!</span><span class="n">r</span><span class="si">}</span><span class="s">&gt;'</span>  
        <span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">().</span><span class="n">__repr__</span><span class="p">()</span>

    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">venue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'venue.</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">venue_serial</span><span class="si">}</span><span class="s">'</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div></div>

<p>Its a common metaprogramming tickt to write to and access an objects <code class="language-plaintext highlighter-rouge">__dict__</code> as in <code class="language-plaintext highlighter-rouge">self.__dict__['speakers']</code> to bypass the Python inheritence recursion lookup for a method or attribute.</p>

<h3 id="bespoke-property-cache">Bespoke Property Cache</h3>

<p>Python 3.8 introduced a <code class="language-plaintext highlighter-rouge">@functools.cached_property</code> decorator.  Its thread safe, but comes with some caveats.</p>

<p>Just a rminder that <code class="language-plaintext highlighter-rouge">functools</code> comes with 3 decorators <code class="language-plaintext highlighter-rouge">@cache</code>, <code class="language-plaintext highlighter-rouge">@lru_cache</code> and <code class="language-plaintext highlighter-rouge">@cached_property</code></p>

<p>The <code class="language-plaintext highlighter-rouge">@cached_property</code> decorator caches the result of the method in an instance attribute with the same name.  For examle in the code below the value computed by venue will be store din a venua attribute and used instead of the method.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">venue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'venue.</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">venue_serial</span><span class="si">}</span><span class="s">'</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div></div>

<p>Some important limitations of <code class="language-plaintext highlighter-rouge">@cached_property</code> are …</p>

<ul>
  <li>It cannot be used as a drop in replacment for <code class="language-plaintext highlighter-rouge">@property</code> if the decorated method already depends on an instance attribute with the same name.</li>
  <li>It cannot be sued in a class that defines <code class="language-plaintext highlighter-rouge">__slots__</code></li>
  <li>It defeats the key-sharing optimizatio of the instance <code class="language-plaintext highlighter-rouge">__dict__</code>, because it creates an instance attribute after <code class="language-plaintext highlighter-rouge">__init__</code></li>
</ul>

<p>An alternative solution is to stack <code class="language-plaintext highlighter-rouge">@cache</code> and <code class="language-plaintext highlighter-rouge">@property</code> Note that order of the stacking is importatn.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="nb">property</span>  
<span class="o">@</span><span class="n">cache</span>  
<span class="k">def</span> <span class="nf">speakers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">spkr_serials</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s">'speakers'</span><span class="p">]</span>
    <span class="n">fetch</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">fetch</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">fetch</span><span class="p">(</span><span class="sa">f</span><span class="s">'speaker.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">spkr_serials</span><span class="p">]</span>
</code></pre></div></div>

<h3 id="using-a-property-for-attriburte-validation">Using a property for Attriburte Validation</h3>

<p>Besides computing attribute values, properties area lso used to enforce business rules by changing a pub-lic attribute into an attribute protected by a getter and setter without affecting client code.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">LineItem</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span>  <span class="c1"># Here property setter is already in use making sure that weight can't be negative
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span>

    <span class="k">def</span> <span class="nf">subtotal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">weight</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">price</span>

    <span class="o">@</span><span class="nb">property</span>  <span class="c1"># @property decorates the getter method
</span>    <span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__weight</span>  <span class="c1"># The actual value is store din private __weight
</span>
    <span class="o">@</span><span class="n">weight</span><span class="p">.</span><span class="n">setter</span>  <span class="c1"># the decorated getter has a .setter attribute which ties the getter and setter together.
</span>    <span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">__weight</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'value must be &gt; 0'</span><span class="p">)</span>
</code></pre></div></div>

<p>The full signature of the property constructor is <code class="language-plaintext highlighter-rouge">property(fget=None, fset=None, fdel=None, doc=None)</code>.  All arguments are optional and if a function is not provied for one of them, the corresponding operation is not allowed on the resulting property object.</p>

<p>Below is an example of how to document a property so that docstrings can be picked up</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>

    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""The bar attribute"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s">'bar'</span><span class="p">]</span>

    <span class="o">@</span><span class="n">bar</span><span class="p">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s">'bar'</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</code></pre></div></div>

<h3 id="coding-a-property-factory">Coding a Property Factory</h3>

<p>The problem we are trying to solve here is that we have weight protected to be non negative, but not price.  In order to not duplicate code we will make a factory.</p>

<p>The use of the factory we will write is below.  The factory will be <code class="language-plaintext highlighter-rouge">quantity</code> in the example below.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">LineItem</span><span class="p">:</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">quantity</span><span class="p">(</span><span class="s">'weight'</span><span class="p">)</span>  
    <span class="n">price</span> <span class="o">=</span> <span class="n">quantity</span><span class="p">(</span><span class="s">'price'</span><span class="p">)</span>  

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span>  
        <span class="bp">self</span><span class="p">.</span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span>

    <span class="k">def</span> <span class="nf">subtotal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">weight</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">price</span>
</code></pre></div></div>

<p>Recall that properties are class attributes.  When building each <code class="language-plaintext highlighter-rouge">quantity</code> property, we need to pass the name of the <code class="language-plaintext highlighter-rouge">LineItem</code> attribute that will be managed by that specific property.  Havin to type <code class="language-plaintext highlighter-rouge">weight</code> twice is unfortunate in  <code class="language-plaintext highlighter-rouge">weight = quantity('weight')</code> but avoiding that is comlicated because the property has no way of knowing which class attribute name will be bound to it.  This is a problem that will be solved in Chapter 23.</p>

<p>Here is the quantity function …</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">quantity</span><span class="p">(</span><span class="n">storage_name</span><span class="p">):</span>  

    <span class="c1"># The first argument of the qty_getter could be named self, but that would be strange because this is not a class body; instance refers to the LineItem instance where the attribute will be stored.
</span>    <span class="k">def</span> <span class="nf">qty_getter</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
        <span class="c1"># qty_getter references storage_name, so it will be preserved in the closure of this function; 
</span>        <span class="c1"># the value is retrieved directly from the instance.__dict__ to bypass the property and avoid an infinite recursion.
</span>        <span class="k">return</span> <span class="n">instance</span><span class="p">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">storage_name</span><span class="p">]</span>  

    <span class="k">def</span> <span class="nf">qty_setter</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>  
        <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">instance</span><span class="p">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">storage_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'value must be &gt; 0'</span><span class="p">)</span>

    <span class="c1"># build a custom property object then return it.
</span>    <span class="k">return</span> <span class="nb">property</span><span class="p">(</span><span class="n">qty_getter</span><span class="p">,</span> <span class="n">qty_setter</span><span class="p">)</span> 
</code></pre></div></div>

<p>In a real system some kind of validation may appear in many fields across several classes, and the <code class="language-plaintext highlighter-rouge">quantity</code> factory would be the place in a utilty module to be used over and over again.  Again this can also be doen with descriptor classes which we will cover in Chapter 23.</p>

<h3 id="handling-attribute-deletion">Handling Attribute Deletion</h3>

<p>The <code class="language-plaintext highlighter-rouge">del</code> statement can delete not only variables but also attributes.</p>

<p>Here is a basic and silly example…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BlackKnight</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">phrases</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">'an arm'</span><span class="p">,</span> <span class="s">"'Tis but a scratch."</span><span class="p">),</span>
            <span class="p">(</span><span class="s">'another arm'</span><span class="p">,</span> <span class="s">"It's just a flesh wound."</span><span class="p">),</span>
            <span class="p">(</span><span class="s">'a leg'</span><span class="p">,</span> <span class="s">"I'm invincible!"</span><span class="p">),</span>
            <span class="p">(</span><span class="s">'another leg'</span><span class="p">,</span> <span class="s">"All right, we'll call it a draw."</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">member</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'next member is:'</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">phrases</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="o">@</span><span class="n">member</span><span class="p">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">member</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">member</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">phrases</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'BLACK KNIGHT (loses </span><span class="si">{</span><span class="n">member</span><span class="si">}</span><span class="s">) -- </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

    <span class="o">&gt;&gt;&gt;</span> <span class="n">knight</span> <span class="o">=</span> <span class="n">BlackKnight</span><span class="p">()</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="n">knight</span><span class="p">.</span><span class="n">member</span>
    <span class="nb">next</span> <span class="n">member</span> <span class="ow">is</span><span class="p">:</span>
    <span class="s">'an arm'</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="k">del</span> <span class="n">knight</span><span class="p">.</span><span class="n">member</span>
    <span class="n">BLACK</span> <span class="n">KNIGHT</span> <span class="p">(</span><span class="n">loses</span> <span class="n">an</span> <span class="n">arm</span><span class="p">)</span> <span class="o">--</span> <span class="s">'Tis but a scratch.
    &gt;&gt;&gt; del knight.member
    BLACK KNIGHT (loses another arm) -- It'</span><span class="n">s</span> <span class="n">just</span> <span class="n">a</span> <span class="n">flesh</span> <span class="n">wound</span><span class="p">.</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="k">del</span> <span class="n">knight</span><span class="p">.</span><span class="n">member</span>
    <span class="n">BLACK</span> <span class="n">KNIGHT</span> <span class="p">(</span><span class="n">loses</span> <span class="n">a</span> <span class="n">leg</span><span class="p">)</span> <span class="o">--</span> <span class="n">I</span><span class="s">'m invincible!
    &gt;&gt;&gt; del knight.member
    BLACK KNIGHT (loses another leg) -- All right, we'</span><span class="n">ll</span> <span class="n">call</span> <span class="n">it</span> <span class="n">a</span> <span class="n">draw</span><span class="p">.</span>
</code></pre></div></div>

<p>In the classic call syntax you would implement the <code class="language-plaintext highlighter-rouge">fdel</code> argument in <code class="language-plaintext highlighter-rouge">member = property(member_getter, fdel=member_deleter)</code></p>

<p>You can also code the <code class="language-plaintext highlighter-rouge">__delattr__</code> special method in your class.</p>

<h3 id="essential-attributes-and-functions-for-attribute-handling">Essential Attributes and Functions for Attribute Handling</h3>

<h4 id="special-attribute-that-affect-attribute-handling">Special Attribute that Affect Attribute Handling</h4>

<p><code class="language-plaintext highlighter-rouge">__class__</code> - A reference to the object’s class (i.e., <code class="language-plaintext highlighter-rouge">obj.__class__</code> is the same as type(obj)). Python looks for special methods such as <code class="language-plaintext highlighter-rouge">__getattr__</code> only in an object’s class, and not in the instances themselves.</p>

<p><code class="language-plaintext highlighter-rouge">__dict__</code> - A mapping that stores the writable attributes of an object or class. An object that has a <strong>dict</strong> can have arbitrary new attributes set at any time. If a class has a <strong>slots</strong> attribute, then its instances may not have a <strong>dict</strong>. See <strong>slots</strong> (next).</p>

<p><code class="language-plaintext highlighter-rouge">__slots__</code> - An attribute that may be defined in a class to save memory. <strong>slots</strong> is a tuple of strings naming the allowed attributes.13 If the ‘<strong>dict</strong>’ name is not in <strong>slots</strong>, then the instances of that class will not have a <strong>dict</strong> of their own, and only the attributes listed in <strong>slots</strong> will be allowed in those instances</p>

<h4 id="built-in-functions-for-attribute-handling">Built-In Functions for Attribute Handling</h4>

<p><code class="language-plaintext highlighter-rouge">dir([object])</code> - Lists most attributes of the object. The official docs say dir is intended for interactive use so it does not provide a comprehensive list of attributes, but an “interesting” set of names. dir can inspect objects implemented with or without a <strong>dict</strong>. The <strong>dict</strong> attribute itself is not listed by dir, but the <strong>dict</strong> keys are listed. Several special attributes of classes, such as <strong>mro</strong>, <strong>bases</strong>, and <strong>name</strong>, are not listed by dir either. You can customize the output of dir by implementing the <strong>dir</strong> special method, as we saw in Example 22-4. If the optional object argument is not given, dir lists the names in the current scope.</p>

<p><code class="language-plaintext highlighter-rouge">getattr(object, name[, default])</code> - Gets the attribute identified by the name string from the object. The main use case is to retrieve attributes (or methods) whose names we don’t know beforehand. This may fetch an attribute from the object’s class or from a superclass. If no such attribute exists, getattr raises AttributeError or returns the default value, if given. One great example of using gettatr is in the Cmd.onecmd method in the cmd package of the standard library, where it is used to get and execute a user-defined command.</p>

<p><code class="language-plaintext highlighter-rouge">hasattr(object, name)</code> - Returns True if the named attribute exists in the object, or can be somehow fetched through it (by inheritance, for example). The documentation explains: “This is implemented by calling getattr(object, name) and seeing whether it raises an AttributeError or not.”</p>

<p><code class="language-plaintext highlighter-rouge">setattr(object, name, value)</code> - Assigns the value to the named attribute of object, if the object allows it. This may create a new attribute or overwrite an existing one.</p>

<p><code class="language-plaintext highlighter-rouge">vars([object])</code> - Returns the <strong>dict</strong> of object; vars can’t deal with instances of classes that define <strong>slots</strong> and don’t have a <strong>dict</strong> (contrast with dir, which handles such instances). Without an argument, vars() does the same as locals(): returns a dict representing the local scope.</p>

<h4 id="special-methods-for-attribute-handling">Special Methods for Attribute Handling</h4>

<p>Attribute access using either dot notation or the built-in functions getattr, hasattr, and setattr triggers the appropriate special methods listed here. Reading and writing attributes directly in the instance <strong>dict</strong> does not trigger these special methods—and that’s the usual way to bypass them if needed.</p>

<p>In other words, assume that the special methods will be retrieved on the class itself, even when the target of the action is an instance. For this reason, special methods are not shadowed by instance attributes with the same name.</p>

<p>In the following examples, assume there is a class named Class, obj is an instance of Class, and attr is an attribute of obj.</p>

<p>For every one of these special methods, it doesn’t matter if the attribute access is done using dot notation or one of the built-in functions listed in “Built-In Functions for Attribute Handling”. For example, both obj.attr and getattr(obj, ‘attr’, 42) trigger Class.<strong>getattribute</strong>(obj, ‘attr’).</p>

<p><code class="language-plaintext highlighter-rouge">__delattr__(self, name)</code> - Always called when there is an attempt to delete an attribute using the del statement; e.g., del obj.attr triggers Class.<strong>delattr</strong>(obj, ‘attr’). If attr is a property, its deleter method is never called if the class implements <strong>delattr</strong>.</p>

<p><code class="language-plaintext highlighter-rouge">__dir__(self)</code> - Called when dir is invoked on the object, to provide a listing of attributes; e.g., dir(obj) triggers Class.<strong>dir</strong>(obj). Also used by tab-completion in all modern Python consoles.</p>

<p><code class="language-plaintext highlighter-rouge">__getattr__(self, name)</code> - Called only when an attempt to retrieve the named attribute fails, after the obj, Class, and its superclasses are searched. The expressions obj.no_such_attr, getattr(obj, ‘no_such_attr’), and hasattr(obj, ‘no_such_attr’) may trigger Class.<strong>getattr</strong>(obj, ‘no_such_attr’), but only if an attribute by that name cannot be found in obj or in Class and its superclasses.</p>

<p><code class="language-plaintext highlighter-rouge">__getattribute__(self, name)</code> - Always called when there is an attempt to retrieve the named attribute directly from Python code (the interpreter may bypass this in some cases, for example, to get the <strong>repr</strong> method). Dot notation and the getattr and hasattr built-ins trigger this method. <strong>getattr</strong> is only invoked after <strong>getattribute</strong>, and only when <strong>getattribute</strong> raises AttributeError. To retrieve attributes of the instance obj without triggering an infinite recursion, implementations of <strong>getattribute</strong> should use super().<strong>getattribute</strong>(obj, name).</p>

<p><code class="language-plaintext highlighter-rouge">__setattr__(self, name, value)</code> - Always called when there is an attempt to set the named attribute. Dot notation and the setattr built-in trigger this method; e.g., both obj.attr = 42 and setattr(obj, ‘attr’, 42) trigger Class.<strong>setattr</strong>(obj, ‘attr’, 42).</p>

<h2 id="chapter-23-attribute-descriptors">Chapter 23 Attribute Descriptors</h2>

<p>Descriptors are a way of reusing the same access logic in multiple attributes.  For example filed types in SQLAlchemy are descritpors managing the flow of data from the fields in a databse record to Python object attributes and vice versa.</p>

<p>A descriptor is a class that implements a dynamic protocol consisting of the <code class="language-plaintext highlighter-rouge">__get__</code>, <code class="language-plaintext highlighter-rouge">__set__</code>, and <code class="language-plaintext highlighter-rouge">__delete__</code> methods. The property class implements the full descriptor protocol. As usual with dynamic protocols, partial implementations are OK. In fact, most descriptors we see in real code implement only <code class="language-plaintext highlighter-rouge">__get__</code> and <code class="language-plaintext highlighter-rouge">__set__</code>, and many implement only one of these methods.</p>

<p>In this chapter we use the same bulk food exaple from chapter 22.</p>

<p>A descriptor class is the object oriented way of what we did with the functional programming approch in last chapter.</p>

<p>You use a descriptro by decorating instances of it as class attributes of another class.</p>

<h3 id="terms-to-understand-descriptors">Terms to understand descriptors</h3>

<p><strong>Descriptor class</strong> - A class implementing the descriptor protocol.</p>

<p><strong>Managed class</strong> - The class where the descriptor instances are declared as class attributes.</p>

<p><strong>Descriptor instance</strong> - Each instance of a descritpro class, declared as a class attribute of the managed class.</p>

<p><strong>Managed instance</strong> - One instance of the managed class</p>

<p><strong>Storage attribute</strong> - An attribute of the managed isntance that holds the value of a manged attribute for that particular instance.</p>

<p><strong>Managed attribute</strong> - A public attribute in the managed class that is handled by a descriptor instance, with values stored in storage attributes.  In other words, a descriptor instance and a storage attribute provide the infrastructure for a manged attribute.</p>

<p>Below is the code for the <code class="language-plaintext highlighter-rouge">Quantity</code> descriptor class</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Quantity</span><span class="p">:</span>  <span class="c1"># Descriptor is a protocol based feature.  No subclassing needed to implement one.
</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">storage_name</span><span class="p">):</span>
        <span class="c1"># Each Quantity instance will have a storage_name attribute: that's the name of the storage attribute to hold the value in the managed instance.
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">storage_name</span> <span class="o">=</span> <span class="n">storage_name</span>  

    <span class="c1"># __set__ is called when there is an attempt to assing to the managed attribute.  Here, self is the descrptor instance (i.e LineItem.weight or LineItem.price)
</span>    <span class="c1"># insatnce is the managed instance (a LineItem instance), and value is being assigned.
</span>    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>  
        <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># We must store the attribute value directly into `__dict__`; calling setattr(instance, self.storage_name) would trigger the __set__ method again, leading to infinite recursion.
</span>            <span class="n">instance</span><span class="p">.</span><span class="n">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">storage_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">storage_name</span><span class="si">}</span><span class="s"> must be &gt; 0'</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># We need to implement __get__ because the name of the managed attribute may not be the same as the storage_name.  Owner is explained later
</span>    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>  
        <span class="k">return</span> <span class="n">instance</span><span class="p">.</span><span class="n">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">storage_name</span><span class="p">]</span>
</code></pre></div></div>

<p>We need to implement the get method because the user can do somethin like …</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">House</span><span class="p">:</span>
    <span class="n">rooms</span> <span class="o">=</span> <span class="n">Quantity</span><span class="p">(</span><span class="s">'number_of_rooms'</span><span class="p">)</span>
</code></pre></div></div>

<p>In this case somethign like <code class="language-plaintext highlighter-rouge">chaos_manor.number_of_rooms</code> would bypass the descriptor.</p>

<p>Note that <code class="language-plaintext highlighter-rouge">__get__</code> receives threee arguments: <code class="language-plaintext highlighter-rouge">self</code>, <code class="language-plaintext highlighter-rouge">instance</code>, <code class="language-plaintext highlighter-rouge">owner</code>.  The <code class="language-plaintext highlighter-rouge">owner</code> argument is a reference to the manged class (i.e LineItem), and its useful if you want the descriptor to support retrieving class a class attribute.  If a managed attribute such as <code class="language-plaintext highlighter-rouge">weight</code> is retrieve via the class like <code class="language-plaintext highlighter-rouge">LineItem.weight</code>, the descriptor <code class="language-plaintext highlighter-rouge">__get__</code> method receives <code class="language-plaintext highlighter-rouge">None</code> as the value for the <code class="language-plaintext highlighter-rouge">instance</code> argument.</p>

<p>To support introspection and other metaprogramming tricks by the suer, its a good practive to make <code class="language-plaintext highlighter-rouge">__get__</code> return the descriptor instance when the managed attribute is accessed thought the class.  To do that we would code <code class="language-plaintext highlighter-rouge">__get__</code> like this.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">instance</span><span class="p">.</span><span class="n">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">storage_name</span><span class="p">]</span>
</code></pre></div></div>

<p>Here is the usage of the Quantity descriptor we wrote…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">LineItem</span><span class="p">:</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">Quantity</span><span class="p">(</span><span class="s">'weight'</span><span class="p">)</span>  
    <span class="n">price</span> <span class="o">=</span> <span class="n">Quantity</span><span class="p">(</span><span class="s">'price'</span><span class="p">)</span>  

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>  
        <span class="bp">self</span><span class="p">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span>

    <span class="k">def</span> <span class="nf">subtotal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">weight</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">price</span>

</code></pre></div></div>

<p>One issue we still have is you have to write code similar to below.  Having to write weight and price twice is error prone as someone can easily make a copy paste mistake and have a hard to track down bug.  To addrress this issue you can use the <code class="language-plaintext highlighter-rouge">__set__name__</code> special method which was added to the protocol in Python 3.6.  The interpreter calls <code class="language-plaintext highlighter-rouge">__set_name__</code> on each descriptor it finds in a class body if the descriptor implements it.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">LineItem</span><span class="p">:</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">Quantity</span><span class="p">(</span><span class="s">'weight'</span><span class="p">)</span>  
    <span class="n">price</span> <span class="o">=</span> <span class="n">Quantity</span><span class="p">(</span><span class="s">'price'</span><span class="p">)</span>
</code></pre></div></div>

<p>Here is the Quantity class with <code class="language-plaintext highlighter-rouge">__set_name__</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Quantity</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__set_name__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>  
        <span class="bp">self</span><span class="p">.</span><span class="n">storage_name</span> <span class="o">=</span> <span class="n">name</span>          

    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>   
        <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># A note here not related to this example but important.
</span>            <span class="c1"># Youw ant to set on the insatnce not the descriptor as you may have many instances
</span>            <span class="c1"># but just one descritor and you don't want the shared state.
</span>            <span class="n">instance</span><span class="p">.</span><span class="n">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">storage_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">storage_name</span><span class="si">}</span><span class="s"> must be &gt; 0'</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># no __get__ needed  
</span>
<span class="k">class</span> <span class="nc">LineItem</span><span class="p">:</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">Quantity</span><span class="p">()</span>  
    <span class="n">price</span> <span class="o">=</span> <span class="n">Quantity</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span>

    <span class="k">def</span> <span class="nf">subtotal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">weight</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">price</span>
</code></pre></div></div>

<p>Another scenario we can have is that the product description may be blank.  This leads us to refactor an example where instead of having a bunch of similar descriptors we can inherit and have them implement a validate method so that each descriptor does the appropriate validation.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">abc</span>

<span class="k">class</span> <span class="nc">Validated</span><span class="p">(</span><span class="n">abc</span><span class="p">.</span><span class="n">ABC</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__set_name__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">storage_name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">storage_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  
        <span class="n">instance</span><span class="p">.</span><span class="n">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">storage_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>  

    <span class="o">@</span><span class="n">abc</span><span class="p">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>  
        <span class="s">"""return validated value or raise ValueError"""</span>

<span class="k">class</span> <span class="nc">Quantity</span><span class="p">(</span><span class="n">Validated</span><span class="p">):</span>
    <span class="s">"""a number greater than zero"""</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>  
        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s"> must be &gt; 0'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">NonBlank</span><span class="p">(</span><span class="n">Validated</span><span class="p">):</span>
    <span class="s">"""a string with at least one non-space character"""</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>  
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s"> cannot be blank'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>
</code></pre></div></div>

<p>and use of the code would look like below where client does not need to kow any of the details.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">model_v5</span> <span class="k">as</span> <span class="n">model</span>  

<span class="k">class</span> <span class="nc">LineItem</span><span class="p">:</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">NonBlank</span><span class="p">()</span>  
    <span class="n">weight</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">Quantity</span><span class="p">()</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">Quantity</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span>

    <span class="k">def</span> <span class="nf">subtotal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">weight</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">price</span>
</code></pre></div></div>

<p>The example we saw above is an overriding descriptor because its <code class="language-plaintext highlighter-rouge">__set__</code> method overrides the setting of an instance attribute by the same name in the managed instance.  There are however also nonoveridding descriptors.</p>

<h3 id="overriding-versus-nonoverriding-descriptors">Overriding Versus Nonoverriding Descriptors</h3>

<p>Recall that there is an important asymmetry in the way Python handles attributes. Reading an attribute through an instance normally returns the attribute defined in the instance, but if there is no such attribute in the instance, a class attribute will be retrieved. On the other hand, assigning to an attribute in an instance normally creates the attribute in the instance, without affecting the class at all.</p>

<p>This asymmetry also affects descriptors, in effect creating two broad categories of descriptors, depending on whether the <strong>set</strong> method is implemented. If <strong>set</strong> is present, the class is an overriding descriptor; otherwise, it is a nonoverriding descriptor.</p>

<p>A descriptor that does not implement <strong>set</strong> is a nonoverriding descriptor. Setting an instance attribute with the same name will shadow the descriptor, rendering it ineffective for handling that attribute in that specific instance. Methods and @functools.cached_property are implemented as nonoverriding descriptors.  The setting of attributes in the class cannot be controlled by descriptors attached to the same class. In particular, this means that the descriptor attributes themselves can be clobbered by assigning to the class.</p>

<h3 id="descriptor-usage-tips">Descriptor Usage Tips</h3>

<ul>
  <li>
    <p>Use <code class="language-plaintext highlighter-rouge">property</code> to keep it simple.  The <code class="language-plaintext highlighter-rouge">property</code> built in creates overriding descriptors implementing <code class="language-plaintext highlighter-rouge">__set__</code> and <code class="language-plaintext highlighter-rouge">__get__</code> even if you do not define a setter method.  The defult <code class="language-plaintext highlighter-rouge">__set__</code> of a property raises <code class="language-plaintext highlighter-rouge">AttributeError</code> so a property is the easiest way to implement a read only attribute.</p>
  </li>
  <li>
    <p>Read-only descriptors require <code class="language-plaintext highlighter-rouge">__set__</code> - If you don’t implement <code class="language-plaintext highlighter-rouge">__set__</code> setting a namesake attribute on an instanc will shadow the descriptor.  The <code class="language-plaintext highlighter-rouge">__set__</code> method on read only should raise an <code class="language-plaintext highlighter-rouge">AttributeError</code> which is why <code class="language-plaintext highlighter-rouge">property</code> above is the way to go.</p>
  </li>
  <li>
    <p>Caching can be done efficiently with <code class="language-plaintext highlighter-rouge">__get__</code> only.  If you code just the <strong>get</strong> method, you have a nonoverriding descriptor. These are useful to make some expensive computation and then cache the result by setting an attribute by the same name on the instance.9 The namesake instance attribute will shadow the descriptor, so subsequent access to that attribute will fetch it directly from the instance <strong>dict</strong> and not trigger the descriptor <strong>get</strong> anymore. The @functools.cached_property decorator actually produces a nonoverriding descriptor.</p>
  </li>
  <li>
    <p>Nonspecial methods can be shadowed by instance attributes - Because functions and methods only implement <strong>get</strong>, they are nonoverriding descriptors. A simple assignment like my_obj.the_method = 7 means that further access to the_method through that instance will retrieve the number 7—without affecting the class or other instances. However, this issue does not interfere with special methods. The interpreter only looks for special methods in the class itself, in other words, repr(x) is executed as x.<strong>class</strong>.<strong>repr</strong>(x), so a <strong>repr</strong> attribute defined in x has no effect on repr(x). For the same reason, the existence of an attribute named <strong>getattr</strong> in an instance will not subvert the usual attribute access algorithm.</p>
  </li>
</ul>

<h2 id="chapter-24-class-metaprogramming">Chapter 24 Class Metaprogramming</h2>

<p>If for some reason you neeed to create a class at runtime here is the code for that…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyClass</span><span class="p">(</span><span class="n">MySuperClass</span><span class="p">,</span> <span class="n">MyMixin</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">42</span>

    <span class="k">def</span> <span class="nf">x2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span>

<span class="n">MyClass</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s">'MyClass'</span><span class="p">,</span>
               <span class="p">(</span><span class="n">MySuperClass</span><span class="p">,</span> <span class="n">MyMixin</span><span class="p">),</span>
               <span class="p">{</span><span class="s">'x'</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span> <span class="s">'x2'</span><span class="p">:</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">},</span>
          <span class="p">)</span>
</code></pre></div></div>

<p>A metacalss is a class that creates other classes.  <code class="language-plaintext highlighter-rouge">type</code> in the example above is a metaclass.</p>

<p>Below is an example of a clas factory and then a demo of that factory.</p>

<p>The demo code for the class factory above</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Iterator</span>

<span class="n">FieldNames</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>  

<span class="c1"># we are returing a type i.e a class that behaves like a tuple. 
# The type hing -&gt;type[tuple] is saying we will return a subclass of type.
</span><span class="k">def</span> <span class="nf">record_factory</span><span class="p">(</span><span class="n">cls_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">field_names</span><span class="p">:</span> <span class="n">FieldNames</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]:</span>  

    <span class="n">slots</span> <span class="o">=</span> <span class="n">parse_identifiers</span><span class="p">(</span><span class="n">field_names</span><span class="p">)</span>  

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>  
        <span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__slots__</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
        <span class="n">attrs</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>  
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">__slots__</span><span class="p">:</span>
            <span class="k">yield</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
        <span class="n">values</span> <span class="o">=</span> <span class="s">', '</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">=</span><span class="si">{</span><span class="n">value</span><span class="err">!</span><span class="n">r</span><span class="si">}</span><span class="s">'</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__slots__</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
        <span class="n">cls_name</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">cls_name</span><span class="si">}</span><span class="s">(</span><span class="si">{</span><span class="n">values</span><span class="si">}</span><span class="s">)'</span>

    <span class="n">cls_attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>  
        <span class="n">__slots__</span><span class="o">=</span><span class="n">slots</span><span class="p">,</span>
        <span class="n">__init__</span><span class="o">=</span><span class="n">__init__</span><span class="p">,</span>
        <span class="n">__iter__</span><span class="o">=</span><span class="n">__iter__</span><span class="p">,</span>
        <span class="n">__repr__</span><span class="o">=</span><span class="n">__repr__</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">cls_name</span><span class="p">,</span> <span class="p">(</span><span class="nb">object</span><span class="p">,),</span> <span class="n">cls_attrs</span><span class="p">)</span>  


<span class="k">def</span> <span class="nf">parse_identifiers</span><span class="p">(</span><span class="n">names</span><span class="p">:</span> <span class="n">FieldNames</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">...]:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">names</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">','</span><span class="p">,</span> <span class="s">' '</span><span class="p">).</span><span class="n">split</span><span class="p">()</span>  
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">isidentifier</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">names</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'names must all be valid identifiers'</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">Dog</span> <span class="o">=</span> <span class="n">record_factory</span><span class="p">(</span><span class="s">'Dog'</span><span class="p">,</span> <span class="s">'name weight owner'</span><span class="p">)</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">rex</span> <span class="o">=</span> <span class="n">Dog</span><span class="p">(</span><span class="s">'Rex'</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="s">'Bob'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">rex</span>  
<span class="n">Dog</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'Rex'</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="s">'Bob'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">name</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">rex</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">name</span><span class="p">,</span> <span class="n">weight</span>
<span class="p">(</span><span class="s">'Rex'</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="s">"{2}'s dog weighs {1}kg"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="o">*</span><span class="n">rex</span><span class="p">)</span>  
<span class="s">"Bob's dog weighs 30kg"</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">rex</span><span class="p">.</span><span class="n">weight</span> <span class="o">=</span> <span class="mi">32</span>  
<span class="o">&gt;&gt;&gt;</span> <span class="n">rex</span>
<span class="n">Dog</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'Rex'</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="s">'Bob'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Dog</span><span class="p">.</span><span class="n">__mro__</span>  
<span class="p">(</span><span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">factories</span><span class="p">.</span><span class="n">Dog</span><span class="s">'&gt;, &lt;class '</span><span class="nb">object</span><span class="s">'&gt;)
</span></code></pre></div></div>

<h3 id="enhancing-classes-with-a-class-decorator">Enhancing Classes with a Class Decorator</h3>

<p>A class decorator behaves like a function decorator.  It is a callable that gets the decorated class as an argument, and should return a class to replace the decorate class.  Class decorators often return the same class after injecting more methods in it via attribute assignment.</p>

<p>Here is code for a class decorator first how its used and then the code.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="o">&gt;&gt;&gt;</span> <span class="o">@</span><span class="n">checked</span>
    <span class="p">...</span> <span class="k">class</span> <span class="nc">Movie</span><span class="p">:</span>
    <span class="p">...</span>     <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">...</span>     <span class="n">year</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">...</span>     <span class="n">box_office</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">...</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="n">movie</span> <span class="o">=</span> <span class="n">Movie</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">'The Godfather'</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="mi">1972</span><span class="p">,</span> <span class="n">box_office</span><span class="o">=</span><span class="mi">137</span><span class="p">)</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="n">movie</span><span class="p">.</span><span class="n">title</span>
    <span class="s">'The Godfather'</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="n">movie</span>
    <span class="n">Movie</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">'The Godfather'</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="mi">1972</span><span class="p">,</span> <span class="n">box_office</span><span class="o">=</span><span class="mf">137.0</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># hints here suggest that we take class as arg and return a class becuase classes are instances of type
</span><span class="k">def</span> <span class="nf">checked</span><span class="p">(</span><span class="n">cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">:</span>  
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">constructor</span> <span class="ow">in</span> <span class="n">_fields</span><span class="p">(</span><span class="n">cls</span><span class="p">).</span><span class="n">items</span><span class="p">():</span>    
        <span class="nb">setattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">constructor</span><span class="p">))</span>  

    <span class="n">cls</span><span class="p">.</span><span class="n">_fields</span> <span class="o">=</span> <span class="nb">classmethod</span><span class="p">(</span><span class="n">_fields</span><span class="p">)</span>  <span class="c1"># type: ignore  
</span>
    <span class="c1"># module-level functions that will become instances methods of the decorated class
</span>    <span class="n">instance_methods</span> <span class="o">=</span> <span class="p">(</span>  
        <span class="n">__init__</span><span class="p">,</span>
        <span class="n">__repr__</span><span class="p">,</span>
        <span class="n">__setattr__</span><span class="p">,</span>
        <span class="n">_asdict</span><span class="p">,</span>
        <span class="n">__flag_unknown_attrs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Add each of the instance_methods to cls
</span>    <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">instance_methods</span><span class="p">:</span>  
        <span class="nb">setattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">method</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>

    <span class="c1"># return the decorated cls
</span>    <span class="k">return</span> <span class="n">cls</span>

<span class="k">def</span> <span class="nf">_fields</span><span class="p">(</span><span class="n">cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">get_type_hints</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">_fields</span><span class="p">():</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">...)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__flag_unknown_attrs</span><span class="p">(</span><span class="o">*</span><span class="n">kwargs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">_fields</span><span class="p">():</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__class__</span>
        <span class="n">descriptor</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">descriptor</span><span class="p">.</span><span class="n">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__flag_unknown_attrs</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">__flag_unknown_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="n">names</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
    <span class="n">plural</span> <span class="o">=</span> <span class="s">'s'</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s">''</span>
    <span class="n">extra</span> <span class="o">=</span> <span class="s">', '</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">name</span><span class="err">!</span><span class="n">r</span><span class="si">}</span><span class="s">'</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>
    <span class="n">cls_name</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">)</span>
    <span class="k">raise</span> <span class="nb">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">cls_name</span><span class="si">}</span><span class="s"> has no attribute</span><span class="si">{</span><span class="n">plural</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">extra</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__dict__</span><span class="p">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">Field</span><span class="p">)</span>
    <span class="p">}</span>

<span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="s">', '</span><span class="p">.</span><span class="n">join</span><span class="p">(</span>
        <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s">=</span><span class="si">{</span><span class="n">value</span><span class="err">!</span><span class="n">r</span><span class="si">}</span><span class="s">'</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">_asdict</span><span class="p">().</span><span class="n">items</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="si">}</span><span class="s">(</span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s">)'</span>
</code></pre></div></div>

<p>If you have not got it already in Python classes are instances of <code class="language-plaintext highlighter-rouge">type</code> and the class of <code class="language-plaintext highlighter-rouge">type</code> is <code class="language-plaintext highlighter-rouge">type</code> (to avoid infinite regress).  The classes <code class="language-plaintext highlighter-rouge">object</code> and <code class="language-plaintext highlighter-rouge">type</code> have a unique relationship: <code class="language-plaintext highlighter-rouge">object</code> is an instance of <code class="language-plaintext highlighter-rouge">type</code> and <code class="language-plaintext highlighter-rouge">type</code> is a subclass of <code class="language-plaintext highlighter-rouge">object</code>.  This relationship is “magic”: it cannot be expressed in Python because either class would have to exit before the other could be defined.  The fact that <code class="language-plaintext highlighter-rouge">type</code> is an instanc eof itself is also magical.</p>


  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">My References</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">My References</li><li><a class="u-email" href="mailto:your-email@example.com">your-email@example.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/jekyll"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">jekyll</span></a></li><li><a href="https://www.twitter.com/jekyllrb"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">jekyllrb</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
